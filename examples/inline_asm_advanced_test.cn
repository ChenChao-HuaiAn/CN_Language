/*
 * 内联汇编高级测试示例
 * 演示内联汇编的输入输出参数和破坏列表
 */

函数 主程序() {
    // 测试1：带输出参数的内联汇编
    #ifdef __x86_64__
    整数 input_val = 42;
    整数 output_val;
    
    打印("测试1: 带输出参数的内联汇编");
    打印("输入值: ");
    打印(input_val);
    
    // 使用内联汇编将输入值加1后输出
    内联汇编("mov eax, %0; inc eax; mov %1, eax", "output_val", "input_val", "eax");
    
    打印("输出值: ");
    打印(output_val);
    #endif
    
    // 测试2：带多个输入和输出的内联汇编
    #ifdef __x86_64__
    整数 a = 10, b = 20, c = 30;
    整数 sum;
    
    打印("\n测试2: 多个输入和输出");
    打印("a=");
    打印(a);
    打印(", b=");
    打印(b);
    打印(", c=");
    打印(c);
    
    // 使用内联汇编计算三个数的和
    内联汇编("mov eax, %0; add eax, %1; add eax, %2; mov %3, eax", 
               "sum", "a,b,c", "eax");
    
    打印("总和: ");
    打印(sum);
    #endif
    
    // 测试3：带破坏列表的内联汇编
    #ifdef __x86_64__
    整数 x = 100, y = 200;
    整数 product;
    
    打印("\n测试3: 带破坏列表的内联汇编");
    打印("x=");
    打印(x);
    打印(", y=");
    打印(y);
    
    // 使用内联汇编计算乘积，并声明破坏的寄存器
    内联汇编("mov eax, %0; imul eax, %1; mov %2, eax", 
               "product", "x,y", "eax,edx");
    
    打印("乘积: ");
    打印(product);
    #endif
    
    // 测试4：使用内联汇编进行位操作
    #ifdef __x86_64__
    整数 num = 15;
    整数 shifted;
    
    打印("\n测试4: 位操作");
    打印("原始值: ");
    打印(num);
    
    // 左移2位
    内联汇编("mov eax, %0; shl eax, 2; mov %1, eax", 
               "shifted", "num", "eax");
    
    打印("左移2位后: ");
    打印(shifted);
    #endif
    
    // 测试5：使用内联汇编读取模型特定寄存器
    #ifdef __x86_64__
    整数 cr0_value;
    
    打印("\n测试5: 读取控制寄存器");
    
    // 读取CR0寄存器
    内联汇编("mov eax, cr0", "cr0_value", "", "eax");
    
    打印("CR0值: ");
    打印(cr0_value);
    #endif
    
    // 测试6：使用内联汇编进行内存操作
    #ifdef __x86_64__
    整数 mem_val = 55;
    整数 result;
    
    打印("\n测试6: 内存操作");
    打印("内存中的值: ");
    打印(mem_val);
    
    // 通过内联汇编读取内存值
    内联汇编("mov eax, [%0]; mov %1, eax", 
               "result", "&mem_val", "eax");
    
    打印("读取的值: ");
    打印(result);
    #endif
    
    // 测试7：使用内联汇编进行条件操作
    #ifdef __x86_64__
    整数 test_val = 5;
    整数 is_zero;
    
    打印("\n测试7: 条件操作");
    打印("测试值: ");
    打印(test_val);
    
    // 测试值是否为0
    内联汇编("test %0, %0; setz al; movzx %1, al", 
               "is_zero", "test_val", "eax");
    
    打印("是否为0 (1=是, 0=否): ");
    打印(is_zero);
    #endif
    
    // 测试8：使用内联汇编进行字符串操作
    #ifdef __x86_64__
    字符串 str = "Hello";
    整数 length;
    
    打印("\n测试8: 字符串操作");
    打印("字符串: ");
    打印(str);
    
    // 计算字符串长度（简单实现）
    内联汇编("mov eax, %0; mov ecx, -1; xor al, al; repne scasb; not ecx; dec ecx; mov %1, ecx", 
               "length", "&str", "eax,ecx,edi");
    
    打印("字符串长度: ");
    打印(length);
    #endif
    
    打印("\n所有内联汇编测试完成");
    
    返回 0;
}
