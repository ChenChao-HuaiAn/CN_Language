// 测试自旋锁功能
// 模拟短时间临界区保护

整数 自旋锁标志 = 0;
整数 保护数据 = 0;

函数 整数 尝试获取锁() {
    如果 (自旋锁标志 == 0) {
        自旋锁标志 = 1;
        返回 1;  // 成功
    }
    返回 0;  // 失败
}

函数 释放锁() {
    自旋锁标志 = 0;
    返回 0;
}

函数 主程序() {
    打印("=== 测试自旋锁 ===");
    打印换行();
    
    // 初始化
    自旋锁标志 = 0;
    保护数据 = 100;
    
    打印("初始数据: ");
    打印整数(保护数据);
    打印换行();
    
    // 尝试获取锁
    整数 获取结果 = 尝试获取锁();
    如果 (获取结果 == 1) {
        打印("成功获取自旋锁");
        打印换行();
        
        // 修改保护数据
        保护数据 = 保护数据 + 50;
        打印("修改后数据: ");
        打印整数(保护数据);
        打印换行();
        
        // 释放锁
        释放锁();
        打印("释放自旋锁");
        打印换行();
    } 否则 {
        打印("获取锁失败");
        打印换行();
    }
    
    // 再次尝试获取锁
    获取结果 = 尝试获取锁();
    如果 (获取结果 == 1) {
        打印("再次成功获取锁");
        打印换行();
        
        保护数据 = 保护数据 * 2;
        打印("最终数据: ");
        打印整数(保护数据);
        打印换行();
        
        释放锁();
        打印("再次释放锁");
        打印换行();
    }
    
    打印("=== 自旋锁测试完成 ===");
    打印换行();
    
    返回 0;
}
