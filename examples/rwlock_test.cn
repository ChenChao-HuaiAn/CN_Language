// 测试读写锁功能
// 模拟多读者单写者场景

整数 共享数据 = 0;
整数 读者数量 = 0;
整数 写者标志 = 0;

函数 整数 开始读() {
    如果 (写者标志 == 0) {
        读者数量 = 读者数量 + 1;
        返回 1;  // 成功
    }
    返回 0;  // 失败
}

函数 结束读() {
    读者数量 = 读者数量 - 1;
    返回 0;
}

函数 整数 开始写() {
    如果 (读者数量 == 0 && 写者标志 == 0) {
        写者标志 = 1;
        返回 1;  // 成功
    }
    返回 0;  // 失败
}

函数 结束写() {
    写者标志 = 0;
    返回 0;
}

函数 主程序() {
    打印("=== 测试读写锁 ===");
    打印换行();
    
    // 初始化
    共享数据 = 42;
    读者数量 = 0;
    写者标志 = 0;
    
    打印("初始共享数据: ");
    打印整数(共享数据);
    打印换行();
    
    // 测试读操作
    打印("测试读操作...");
    打印换行();
    
    整数 读1 = 开始读();
    如果 (读1 == 1) {
        打印("读者1进入，数据: ");
        打印整数(共享数据);
        打印换行();
        
        整数 读2 = 开始读();
        如果 (读2 == 1) {
            打印("读者2进入，数据: ");
            打印整数(共享数据);
            打印换行();
            结束读();
        }
        
        结束读();
    }
    
    // 测试写操作
    打印("测试写操作...");
    打印换行();
    
    整数 写1 = 开始写();
    如果 (写1 == 1) {
        打印("写者进入");
        打印换行();
        共享数据 = 共享数据 * 2;
        打印("修改后数据: ");
        打印整数(共享数据);
        打印换行();
        结束写();
    }
    
    // 再次读取验证
    打印("验证修改...");
    打印换行();
    读1 = 开始读();
    如果 (读1 == 1) {
        打印("最终数据: ");
        打印整数(共享数据);
        打印换行();
        结束读();
    }
    
    打印("=== 读写锁测试完成 ===");
    打印换行();
    
    返回 0;
}
