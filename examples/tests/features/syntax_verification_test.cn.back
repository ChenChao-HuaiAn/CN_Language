/*
 * CN Language 核心语法特性验收测试程序
 * 
 * 本程序综合验证阶段8所有核心语法扩展：
 * 1. 函数声明与调用（中文关键字）
 * 2. 枚举类型定义与使用
 * 3. 结构体定义与成员访问
 * 4. 指针与引用操作
 * 5. 数组操作与索引
 * 6. 控制流语句（if/else/while/for/switch）
 * 7. 模块系统与可见性
 * 8. 运算符（算术、逻辑、位运算、原子操作）
 * 9. 类型转换
 * 10. 内存管理与并发控制
 * 
 * 这是阶段8系统编程能力的全面验收测试
 */

// ============================================
// 1. 枚举类型测试
// ============================================

枚举 颜色 {
    红色 = 1,
    绿色 = 2,
    蓝色 = 3,
    黄色 = 4
}

枚举 操作类型 {
    操作_读取 = 0,
    操作_写入 = 1,
    操作_删除 = 2
}

// ============================================
// 2. 结构体定义测试
// ============================================

结构体 坐标点 {
    整数 x;
    整数 y;
    字符串 标签;
}

结构体 矩形 {
    坐标点 左上角;
    坐标点 右下角;
    整数 面积;
}

结构体 链表节点 {
    整数 数据;
    链表节点* 下一个;
}

// ============================================
// 3. 模块系统测试
// ============================================

模块 数学工具 {
    公开:
    
    函数 整数 加法(整数 a, 整数 b) {
        返回 a + b;
    }
    
    函数 整数 减法(整数 a, 整数 b) {
        返回 a - b;
    }
    
    函数 整数 乘法(整数 a, 整数 b) {
        返回 a * b;
    }
    
    私有:
    
    函数 整数 内部计算(整数 x) {
        返回 x * 2 + 1;
    }
}

模块 字符串工具 {
    公开:
    
    函数 整数 计算长度(字符串 文本) {
        // 简化版本，实际会调用运行时函数
        返回 10;
    }
    
    函数 布尔 是否相等(字符串 a, 字符串 b) {
        返回 真;  // 简化
    }
}

// ============================================
// 4. 函数测试 - 基本函数
// ============================================

函数 打印测试标题(字符串 标题) {
    打印("\n====================");
    打印(标题);
    打印("====================");
}

函数 整数 计算阶乘(整数 n) {
    如果 (n <= 1) {
        返回 1;
    }
    返回 n * 计算阶乘(n - 1);
}

函数 整数 斐波那契(整数 n) {
    如果 (n <= 1) {
        返回 n;
    }
    返回 斐波那契(n - 1) + 斐波那契(n - 2);
}

// ============================================
// 5. 指针与引用测试函数
// ============================================

函数 交换值_指针(整数* a, 整数* b) {
    整数 临时 = *a;
    *a = *b;
    *b = 临时;
}

函数 增加值(整数& 引用值) {
    引用值 = 引用值 + 10;
}

函数 整数* 创建节点(整数 值) {
    整数* 节点 = (整数*)cn_rt_malloc(sizeof(整数));
    *节点 = 值;
    返回 节点;
}

// ============================================
// 6. 数组操作测试函数
// ============================================

函数 整数 数组求和(整数[] 数组, 整数 长度) {
    整数 总和 = 0;
    整数 i = 0;
    当 (i < 长度) {
        总和 = 总和 + 数组[i];
        i++;
    }
    返回 总和;
}

函数 整数 查找最大值(整数[] 数组, 整数 长度) {
    如果 (长度 == 0) {
        返回 0;
    }
    
    整数 最大 = 数组[0];
    整数 i = 1;
    当 (i < 长度) {
        如果 (数组[i] > 最大) {
            最大 = 数组[i];
        }
        i++;
    }
    返回 最大;
}

// ============================================
// 测试场景函数
// ============================================

函数 测试枚举类型() {
    打印测试标题("测试1：枚举类型");
    
    颜色 我的颜色 = 红色;
    打印("初始颜色值: " + 我的颜色);
    
    我的颜色 = 蓝色;
    打印("修改后颜色值: " + 我的颜色);
    
    操作类型 操作 = 操作_写入;
    打印("操作类型: " + 操作);
    
    打印("✓ 枚举类型测试通过");
}

函数 测试结构体() {
    打印测试标题("测试2：结构体定义与操作");
    
    // 创建坐标点
    坐标点 点1;
    点1.x = 10;
    点1.y = 20;
    点1.标签 = "起点";
    
    打印("点1: (" + 点1.x + ", " + 点1.y + ") - " + 点1.标签);
    
    // 创建矩形
    矩形 我的矩形;
    我的矩形.左上角.x = 0;
    我的矩形.左上角.y = 0;
    我的矩形.右下角.x = 100;
    我的矩形.右下角.y = 50;
    我的矩形.面积 = 5000;
    
    打印("矩形: [(" + 我的矩形.左上角.x + "," + 我的矩形.左上角.y + ") 到 (" +
          我的矩形.右下角.x + "," + 我的矩形.右下角.y + ")]");
    打印("面积: " + 我的矩形.面积);
    
    打印("✓ 结构体测试通过");
}

函数 测试函数与递归() {
    打印测试标题("测试3：函数声明与递归");
    
    打印("计算阶乘：");
    整数 结果1 = 计算阶乘(5);
    打印("5! = " + 结果1);
    
    打印("计算斐波那契：");
    整数 结果2 = 斐波那契(7);
    打印("fib(7) = " + 结果2);
    
    // 使用模块函数
    打印("模块函数测试：");
    整数 和 = 数学工具.加法(10, 20);
    打印("10 + 20 = " + 和);
    
    整数 差 = 数学工具.减法(50, 15);
    打印("50 - 15 = " + 差);
    
    打印("✓ 函数与递归测试通过");
}

函数 测试指针与引用() {
    打印测试标题("测试4：指针与引用");
    
    // 测试指针
    整数 a = 100;
    整数 b = 200;
    打印("交换前: a=" + a + ", b=" + b);
    
    交换值_指针(&a, &b);
    打印("交换后: a=" + a + ", b=" + b);
    
    // 测试引用
    整数 值 = 50;
    打印("增加前: " + 值);
    增加值(值);
    打印("增加后: " + 值);
    
    // 测试动态内存
    整数* 动态节点 = 创建节点(999);
    打印("动态创建的节点值: " + *动态节点);
    cn_rt_free(动态节点);
    
    打印("✓ 指针与引用测试通过");
}

函数 测试数组操作() {
    打印测试标题("测试5：数组操作");
    
    整数 数组[5] = {10, 20, 30, 40, 50};
    
    打印("数组元素：");
    整数 i = 0;
    当 (i < 5) {
        打印("  数组[" + i + "] = " + 数组[i]);
        i++;
    }
    
    整数 总和 = 数组求和(数组, 5);
    打印("数组总和: " + 总和);
    
    整数 最大值 = 查找最大值(数组, 5);
    打印("最大值: " + 最大值);
    
    打印("✓ 数组操作测试通过");
}

函数 测试控制流() {
    打印测试标题("测试6：控制流语句");
    
    // 测试if-else
    打印("if-else测试：");
    整数 x = 15;
    如果 (x > 10) {
        打印("  x > 10: 真");
    } 否则 {
        打印("  x > 10: 假");
    }
    
    // 测试while循环
    打印("while循环测试：");
    整数 计数 = 0;
    当 (计数 < 3) {
        打印("  循环 " + 计数);
        计数++;
    }
    
    // 测试switch语句
    打印("switch语句测试：");
    整数 选项 = 2;
    切换 (选项) {
        情况 1:
            打印("  选项1");
            跳出;
        情况 2:
            打印("  选项2");
            跳出;
        默认:
            打印("  默认选项");
    }
    
    打印("✓ 控制流测试通过");
}

函数 测试运算符() {
    打印测试标题("测试7：运算符");
    
    // 算术运算
    整数 a = 10, b = 3;
    打印("算术运算：");
    打印("  10 + 3 = " + (a + b));
    打印("  10 - 3 = " + (a - b));
    打印("  10 * 3 = " + (a * b));
    打印("  10 / 3 = " + (a / b));
    打印("  10 % 3 = " + (a % b));
    
    // 逻辑运算
    打印("逻辑运算：");
    布尔 真值 = 真;
    布尔 假值 = 假;
    打印("  真 并且 假 = " + (真值 并且 假值));
    打印("  真 或者 假 = " + (真值 或者 假值));
    打印("  非 真 = " + (非 真值));
    
    // 位运算
    打印("位运算：");
    整数 x = 12, y = 5;
    打印("  12 & 5 = " + (x & y));
    打印("  12 | 5 = " + (x | y));
    打印("  12 ^ 5 = " + (x ^ y));
    打印("  ~12 = " + (~x));
    
    打印("✓ 运算符测试通过");
}

函数 测试类型转换() {
    打印测试标题("测试8：类型转换");
    
    整数 整数值 = 42;
    小数 小数值 = 3.14;
    
    打印("整数转小数: " + (小数)整数值);
    打印("小数转整数: " + (整数)小数值);
    
    // 指针转换
    整数 数据 = 100;
    内存地址 地址 = (内存地址)&数据;
    打印("指针地址: 0x" + 地址);
    
    打印("✓ 类型转换测试通过");
}

函数 测试并发控制() {
    打印测试标题("测试9：并发控制");
    
    // 原子操作测试
    CnAtomic32 原子计数;
    cn_rt_atomic32_init(&原子计数, 0);
    
    打印("原子操作测试：");
    整数 旧值 = cn_rt_atomic32_fetch_add(&原子计数, 5, CN_MEMORY_ORDER_SEQ_CST);
    打印("  原子递增：" + 旧值 + " -> " + (旧值 + 5));
    
    整数 当前值 = cn_rt_atomic32_load(&原子计数, CN_MEMORY_ORDER_SEQ_CST);
    打印("  当前值：" + 当前值);
    
    // 互斥锁测试
    CnMutex 互斥锁;
    cn_rt_mutex_init(&互斥锁);
    
    打印("互斥锁测试：");
    cn_rt_mutex_lock(&互斥锁);
    打印("  加锁成功");
    cn_rt_mutex_unlock(&互斥锁);
    打印("  解锁成功");
    
    cn_rt_mutex_destroy(&互斥锁);
    
    打印("✓ 并发控制测试通过");
}

函数 测试内存管理() {
    打印测试标题("测试10：内存管理");
    
    // 动态分配
    整数* 缓冲区 = (整数*)cn_rt_malloc(10 * sizeof(整数));
    
    打印("分配10个整数的缓冲区");
    
    // 初始化
    整数 i = 0;
    当 (i < 10) {
        缓冲区[i] = i * 10;
        i++;
    }
    
    // 读取
    打印("缓冲区内容：");
    i = 0;
    当 (i < 10) {
        打印("  [" + i + "] = " + 缓冲区[i]);
        i++;
    }
    
    // 释放
    cn_rt_free(缓冲区);
    打印("缓冲区已释放");
    
    打印("✓ 内存管理测试通过");
}

// ============================================
// 主程序 - 运行所有测试
// ============================================

函数 主程序() {
    打印("\n");
    打印("========================================");
    打印("CN Language 核心语法特性验收测试");
    打印("阶段8：核心语法扩展与系统编程能力");
    打印("========================================");
    
    // 运行所有测试
    测试枚举类型();
    测试结构体();
    测试函数与递归();
    测试指针与引用();
    测试数组操作();
    测试控制流();
    测试运算符();
    测试类型转换();
    测试并发控制();
    测试内存管理();
    
    // 测试总结
    打印("\n");
    打印("========================================");
    打印("测试总结");
    打印("========================================");
    打印("✓ 所有核心语法特性测试通过！");
    打印("");
    打印("测试覆盖：");
    打印("  [1] 枚举类型 ✓");
    打印("  [2] 结构体 ✓");
    打印("  [3] 函数与递归 ✓");
    打印("  [4] 指针与引用 ✓");
    打印("  [5] 数组操作 ✓");
    打印("  [6] 控制流语句 ✓");
    打印("  [7] 运算符 ✓");
    打印("  [8] 类型转换 ✓");
    打印("  [9] 并发控制 ✓");
    打印("  [10] 内存管理 ✓");
    打印("");
    打印("CN Language 核心语法验收完成！");
    打印("========================================");
    
    返回 0;
}
