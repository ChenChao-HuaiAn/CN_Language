/*
 * CN_Language I/O系统集成测试
 * 测试I/O系统各组件的协同工作
 */

#include "cnlang/runtime/stdlib.h"
#include "cnlang/runtime/io.h"
#include <stdio.h>
#include <string.h>

// 测试场景：简单的配置文件读写系统
int 测试配置文件系统(void)
{
    printf("\n=== 测试场景：配置文件系统 ===\n");
    
    const char* 配置文件 = "test_config.ini";
    
    // 1. 写入配置
    printf("步骤1: 写入配置文件...\n");
    void* 文件 = 打开文件(配置文件, "w");
    if (文件 == NULL) {
        printf("错误: 无法创建配置文件\n");
        return 0;
    }
    
    // 写入配置项
    const char* 配置内容[] = {
        "[系统设置]\n",
        "应用名称=CN语言编译器\n",
        "版本号=1.0.0\n",
        "调试模式=开启\n",
        "\n",
        "[路径配置]\n",
        "源码目录=./src\n",
        "输出目录=./build\n"
    };
    
    for (int i = 0; i < 8; i++) {
        写入文件(文件, 配置内容[i], 获取字符串长度(配置内容[i]));
    }
    
    刷新文件缓冲(文件);
    关闭文件(文件);
    printf("  配置文件写入完成\n");
    
    // 2. 读取配置
    printf("步骤2: 读取配置文件...\n");
    文件 = 打开文件(配置文件, "r");
    if (文件 == NULL) {
        printf("错误: 无法打开配置文件\n");
        return 0;
    }
    
    char 缓冲区[1024];
    size_t 读取字节 = 读取文件(文件, 缓冲区, sizeof(缓冲区) - 1);
    缓冲区[读取字节] = '\0';
    
    printf("  读取到 %zu 字节\n", 读取字节);
    printf("  配置内容:\n%s\n", 缓冲区);
    
    关闭文件(文件);
    
    return 1;
}

// 测试场景：日志记录系统
int 测试日志记录系统(void)
{
    printf("\n=== 测试场景：日志记录系统 ===\n");
    
    const char* 日志文件 = "test_application.log";
    
    // 清空日志文件
    void* 文件 = 打开文件(日志文件, "w");
    if (文件 == NULL) {
        printf("错误: 无法创建日志文件\n");
        return 0;
    }
    关闭文件(文件);
    
    // 记录多条日志
    printf("步骤1: 记录日志条目...\n");
    
    const char* 日志级别[] = {"INFO", "DEBUG", "WARNING", "ERROR"};
    const char* 日志消息[] = {
        "应用程序启动",
        "加载配置文件",
        "内存使用率达到80%",
        "文件读取失败"
    };
    
    for (int i = 0; i < 4; i++) {
        文件 = 打开文件(日志文件, "a");  // 追加模式
        if (文件 == NULL) {
            continue;
        }
        
        char 日志行[256];
        安全格式化字符串(日志行, sizeof(日志行),
                          "[%s] %s\n", 日志级别[i], 日志消息[i]);
        
        写入文件(文件, 日志行, 获取字符串长度(日志行));
        刷新文件缓冲(文件);
        关闭文件(文件);
        
        printf("  记录: [%s] %s\n", 日志级别[i], 日志消息[i]);
    }
    
    // 读取并分析日志
    printf("步骤2: 读取日志文件...\n");
    文件 = 打开文件(日志文件, "r");
    if (文件 != NULL) {
        char 缓冲区[1024];
        size_t 读取 = 读取文件(文件, 缓冲区, sizeof(缓冲区) - 1);
        缓冲区[读取] = '\0';
        
        printf("  日志内容:\n%s\n", 缓冲区);
        关闭文件(文件);
    }
    
    return 1;
}

// 测试场景：数据导出系统
int 测试数据导出系统(void)
{
    printf("\n=== 测试场景：数据导出系统 ===\n");
    
    const char* 数据文件 = "test_data_export.csv";
    
    printf("步骤1: 导出CSV数据...\n");
    void* 文件 = 打开文件(数据文件, "w");
    if (文件 == NULL) {
        printf("错误: 无法创建数据文件\n");
        return 0;
    }
    
    // 写入CSV标题
    const char* 标题 = "ID,姓名,年龄,成绩\n";
    写入文件(文件, 标题, 获取字符串长度(标题));
    
    // 写入数据行
    typedef struct {
        int id;
        const char* 姓名;
        int 年龄;
        float 成绩;
    } 学生数据;
    
    学生数据 学生[] = {
        {1, "张三", 20, 85.5},
        {2, "李四", 21, 92.0},
        {3, "王五", 19, 78.5}
    };
    
    char 数据行[256];
    for (int i = 0; i < 3; i++) {
        安全格式化字符串(数据行, sizeof(数据行),
                          "%d,%s,%d,%.1f\n",
                          学生[i].id, 学生[i].姓名, 
                          学生[i].年龄, 学生[i].成绩);
        写入文件(文件, 数据行, 获取字符串长度(数据行));
        printf("  导出: %s", 数据行);
    }
    
    关闭文件(文件);
    
    // 验证导出
    printf("步骤2: 验证导出数据...\n");
    文件 = 打开文件(数据文件, "r");
    if (文件 != NULL) {
        // 获取文件大小
        文件定位(文件, 0, 2);
        long 文件大小 = 获取文件位置(文件);
        printf("  文件大小: %ld 字节\n", 文件大小);
        
        // 读取内容
        文件定位(文件, 0, 0);
        char 缓冲区[1024];
        size_t 读取 = 读取文件(文件, 缓冲区, sizeof(缓冲区) - 1);
        缓冲区[读取] = '\0';
        
        printf("  导出内容:\n%s\n", 缓冲区);
        关闭文件(文件);
    }
    
    return 1;
}

// 测试场景：文件处理流水线
int 测试文件处理流水线(void)
{
    printf("\n=== 测试场景：文件处理流水线 ===\n");
    
    const char* 输入文件 = "test_input.txt";
    const char* 输出文件 = "test_output.txt";
    
    // 1. 创建输入文件
    printf("步骤1: 创建输入文件...\n");
    void* 文件 = 打开文件(输入文件, "w");
    if (文件 == NULL) {
        printf("错误: 无法创建输入文件\n");
        return 0;
    }
    
    const char* 输入数据 = "CN语言\n标准库\nI/O系统\n测试\n";
    写入文件(文件, 输入数据, 获取字符串长度(输入数据));
    关闭文件(文件);
    printf("  输入文件创建完成\n");
    
    // 2. 处理文件（读取、转换、写入）
    printf("步骤2: 处理文件...\n");
    
    // 读取输入
    文件 = 打开文件(输入文件, "r");
    if (文件 == NULL) {
        printf("错误: 无法打开输入文件\n");
        return 0;
    }
    
    char 输入缓冲[1024];
    size_t 读取字节 = 读取文件(文件, 输入缓冲, sizeof(输入缓冲) - 1);
    输入缓冲[读取字节] = '\0';
    关闭文件(文件);
    
    printf("  读取 %zu 字节\n", 读取字节);
    
    // 写入输出（添加行号）
    文件 = 打开文件(输出文件, "w");
    if (文件 == NULL) {
        printf("错误: 无法创建输出文件\n");
        return 0;
    }
    
    // 简单的处理：添加前缀
    char 输出缓冲[1024];
    安全格式化字符串(输出缓冲, sizeof(输出缓冲),
                      "处理后的内容:\n%s", 输入缓冲);
    写入文件(文件, 输出缓冲, 获取字符串长度(输出缓冲));
    关闭文件(文件);
    
    printf("  输出文件创建完成\n");
    
    // 3. 验证输出
    printf("步骤3: 验证输出...\n");
    文件 = 打开文件(输出文件, "r");
    if (文件 != NULL) {
        char 验证缓冲[1024];
        读取字节 = 读取文件(文件, 验证缓冲, sizeof(验证缓冲) - 1);
        验证缓冲[读取字节] = '\0';
        
        printf("  输出内容:\n%s\n", 验证缓冲);
        关闭文件(文件);
    }
    
    return 1;
}

// 测试场景：缓冲区性能
int 测试缓冲区性能(void)
{
    printf("\n=== 测试场景：缓冲区性能测试 ===\n");
    
    const char* 测试文件 = "test_buffer_perf.txt";
    const int 写入次数 = 100;
    
    // 测试1：无缓冲写入
    printf("测试1: 无缓冲写入 (%d次)...\n", 写入次数);
    void* 文件 = 打开文件(测试文件, "w");
    if (文件 == NULL) {
        printf("错误: 无法打开文件\n");
        return 0;
    }
    
    cn_rt_file_setbuf((CnRtFile)文件, NULL, 2, 0);  // 无缓冲
    
    const char* 数据 = "无缓冲测试数据\n";
    for (int i = 0; i < 写入次数; i++) {
        写入文件(文件, 数据, 获取字符串长度(数据));
    }
    
    关闭文件(文件);
    printf("  完成无缓冲写入\n");
    
    // 测试2：全缓冲写入
    printf("测试2: 全缓冲写入 (%d次)...\n", 写入次数);
    文件 = 打开文件(测试文件, "w");
    if (文件 == NULL) {
        printf("错误: 无法打开文件\n");
        return 0;
    }
    
    char 自定义缓冲[4096];
    cn_rt_file_setbuf((CnRtFile)文件, 自定义缓冲, 0, sizeof(自定义缓冲));  // 全缓冲
    
    数据 = "全缓冲测试数据\n";
    for (int i = 0; i < 写入次数; i++) {
        写入文件(文件, 数据, 获取字符串长度(数据));
    }
    
    刷新文件缓冲(文件);
    关闭文件(文件);
    printf("  完成全缓冲写入\n");
    
    // 验证文件内容
    文件 = 打开文件(测试文件, "r");
    if (文件 != NULL) {
        文件定位(文件, 0, 2);
        long 文件大小 = 获取文件位置(文件);
        printf("  最终文件大小: %ld 字节\n", 文件大小);
        关闭文件(文件);
    }
    
    return 1;
}

// 主测试函数
int main(void)
{
    printf("\n========================================\n");
    printf("CN_Language I/O系统集成测试\n");
    printf("========================================\n");
    
    int 测试通过 = 0;
    int 测试总数 = 0;
    
    // 运行集成测试场景
    测试总数++;
    if (测试配置文件系统()) 测试通过++;
    
    测试总数++;
    if (测试日志记录系统()) 测试通过++;
    
    测试总数++;
    if (测试数据导出系统()) 测试通过++;
    
    测试总数++;
    if (测试文件处理流水线()) 测试通过++;
    
    测试总数++;
    if (测试缓冲区性能()) 测试通过++;
    
    printf("\n========================================\n");
    printf("测试总结:\n");
    printf("  总计: %d 个场景\n", 测试总数);
    printf("  通过: %d 个场景\n", 测试通过);
    printf("  失败: %d 个场景\n", 测试总数 - 测试通过);
    printf("========================================\n\n");
    
    return (测试通过 == 测试总数) ? 0 : 1;
}
