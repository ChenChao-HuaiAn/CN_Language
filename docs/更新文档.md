
### 1. 扩展放在哪里？

我已经把一个最小可用的 VS Code LSP 扩展加到了仓库里：

- **扩展根目录**：  
  `tools/vscode/cnlang-lsp`
- 关键文件：
  - `package.json`：扩展元数据、语言声明、配置项
  - `extension.js`：真正启动 `cnlsp` 进程的客户端代码

扩展会为 **`.cn` 文件**提供 LSP 客户端能力，语言 id 为 `cn`。

---

### 2. 如何在本机安装 / 调试这个扩展？

#### 步骤 1：构建 `cnlsp` 服务器（你已经有，但再列一次）

在项目根目录：

```powershell
cd c:\Users\ChenChao\Documents\gitcode\CN_Language
mkdir build  # 若已存在可省略
cd build
cmake ..
cmake --build . --target cnlsp
```

会生成：

- `build/src/Debug/cnlsp.exe`（Windows）

#### 步骤 2：在扩展目录安装依赖

```powershell
cd c:\Users\ChenChao\Documents\gitcode\CN_Language\tools\vscode\cnlang-lsp
npm install
```

> 这里只拉取 `vscode-languageclient`，不会动你主项目的 C 代码。

#### 步骤 3：在 VS Code 中以“调试扩展”方式运行

1. 用 VS Code 打开整个仓库目录：  
   `c:\Users\ChenChao\Documents\gitcode\CN_Language`
2. 在资源管理器里打开 `tools/vscode/cnlang-lsp` 这个子目录。
3. 按下 F5（或在“运行和调试”面板选择 “Run Extension”）。
   - 这会启动一个新的 VS Code 窗口（Extension Development Host）。

#### 步骤 4：在扩展开发窗口中验证功能

在弹出的 **Extension Development Host** 窗口里：

1. 打开你的 CN 源码，比如：
   - `examples/hello_world.cn`
   - `examples/function_examples.cn`
2. 确认语言 id 为 `cn`（右下角状态栏，会显示 “CN Language”）。
3. 这时扩展会：
   - 自动尝试从当前工作区根目录推断 `cnlsp` 路径：
     - Windows：`<workspace>/build/src/Debug/cnlsp.exe`
     - 非 Windows：`<workspace>/build/src/cnlsp`
   - 通过 stdio 启动语言服务器。

如果你的 `cnlsp` 不在上述默认路径，可以在 VS Code 设置中手工指定：

- 设置键：`cnlang.lsp.serverPath`
- 设置示例（Windows）：

  ```json
  "cnlang.lsp.serverPath": "C:\\Users\\ChenChao\\Documents\\gitcode\\CN_Language\\build\\src\\Debug\\cnlsp.exe"
  ```

---

### 3. 验证哪些能力已经接上？

在 Extension Development Host 里：

- **诊断**：保存 `.cn` 文件时，语法/语义错误会以红波浪线显示（来自 `publishDiagnostics`）。
- **跳转到定义**：在变量或函数上按 F12，会走 `textDocument/definition` → `cn_lsp_find_definition`。
- **查找引用**：右键 “查找所有引用”，走 `textDocument/references` → `cn_lsp_find_references`。
- **语义高亮（原型）**：如果你在 VS Code 的 `settings.json` 中开启对应支持，`textDocument/semanticTokens/full` 会返回关键字/变量的 token 数据，主题支持的话会比普通语法高亮更细致。

---

### 4. 小结

- 扩展已经放在：`tools/vscode/cnlang-lsp`，不依赖额外文档文件。
- 使用方式是标准 VS Code 扩展开发流程：**在该目录 npm install → F5 运行扩展 → 新窗口中打开 `.cn` 文件**。
- 如果你愿意，下一步我可以帮你补一个简单的 **language-configuration.json**（比如注释规则、括号匹配），以及给出一个更精确的测试步骤清单（对应各个 LSP 方法的预期行为）。