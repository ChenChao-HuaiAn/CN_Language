# CN_Language C 代码风格规范（首版）

> 本规范适用于 CN_Language 编译器、运行时、工具链的 **C 语言实现代码**。
> 目标是：统一风格、提升可读性，并控制单个文件/函数的复杂度。

## 1. 基本约束

1. **实现语言**：
   - 使用 C99/C11 标准（与构建系统配置保持一致，目前为 C11）。

2. **文件/函数大小约束**（必须严格遵守）：
   - 每个 `.c` 文件 **不超过 500 行**（含空行和注释）。
   - 每个函数 **不超过 50 行**（含空行和注释）。
   - 当超过上述限制时：
     - 优先拆分为多个更小的函数；
     - 如仍过大，则拆分为子模块，新建子目录存放实现文件。

3. **头文件暴露原则**：
   - 只在 `include/cnlang/<module>/` 目录下暴露对外可见的接口头文件；
   - 模块内部的实现细节头文件放在 `src/<module>/internal/` 或模块目录下的 `internal/` 子目录，仅供本模块使用；
   - 头文件中只放 **声明**，不放函数定义或全局变量定义（除 `extern` 声明外）。

4. **中间文件与构建产物**：
   - 所有 `.o` 等中间文件必须输出到 `build/` 目录下的对应子目录；
   - 源码目录（`src/`、`include/`）中不应出现编译生成的文件。

## 2. 文件与命名规范

### 2.1 文件组织

1. **源文件布局**：
   - 一个源文件主要负责一个相对独立的逻辑单元（例如：`lexer/token.c`、`parser/parser.c`）。
   - 禁止出现“杂烩文件”（同时包含前端、语义、IR 等不相关逻辑）。

2. **模块目录对应关系**：
   - `src/frontend/*` 对应前端实现（lexer/parser/ast）。
   - `src/semantics/*` 对应语义分析与类型系统实现。
   - `src/ir/*` 对应 IR 及其优化 Pass。
   - `src/backend/*` 对应后端和代码生成。
   - `src/runtime/*` 对应运行时和基础标准库。
   - `src/support/*` 对应通用工具、诊断、容器、配置等。
   - `src/cli/*` 对应 `cnc`、`cnrepl` 等命令行入口。

### 2.2 文件命名

1. **C 源文件与头文件**：
   - 使用小写 + 下划线命名：
     - 例如：`token.c`、`token.h`、`parser.c`、`parser.h`、`diagnostics.c`。
   - 文件名应体现其职责范围，不使用含糊名称：
     - 推荐：`symbol_table.c`、`type_checker.c`；
     - 不推荐：`util.c`、`misc.c`。

2. **内部头文件**：
   - 命名同样使用小写 + 下划线：`token_internal.h`、`parser_internal.h`；
   - 放在模块内部 `internal/` 子目录。

## 3. 代码风格

### 3.1 缩进与空白

1. **缩进**：
   - 使用 **4 个空格** 作为缩进，不使用制表符（Tab）。

2. **行宽**：
   - 推荐每行不超过 **100 列**；超出时优先通过拆分表达式或抽取辅助函数解决。

3. **空行使用**：
   - 函数之间用 1 行空行分隔；
   - 逻辑块之间可以使用空行提高可读性，但避免连续多个空行。

### 3.2 括号与大括号

1. **函数定义**：

   ```c
   int function_name(int arg1, int arg2)
   {
       /* body */
   }
   ```

   - 左大括号单独一行，与函数名同缩进层级。

2. **控制语句**（`if/else/for/while/switch` 等）：

   ```c
   if (condition) {
       /* body */
   } else {
       /* body */
   }
   ```

   - 即使只有一条语句，也必须使用大括号，避免歧义。

3. **条件表达式**：
   - 条件应始终使用括号括起：`if (x == 0)`。

### 3.3 空格规则

- 关键字后加空格：`if (cond)`、`while (cond)`；
- 运算符两侧加空格：`a + b`、`a * b`、`a && b`；
- 函数调用不在函数名和左括号之间加空格：`foo(x, y)`；
- 逗号后必须有空格：`foo(a, b, c)`。

## 4. 命名约定

### 4.1 标识符命名风格

1. **类型与结构体名**：
   - 使用 `CamelCase` 或 `PascalCase`：`Token`, `AstNode`, `SymbolTable`; 
   - 结构体别名前缀可使用 `Cn` 或模块前缀：`CnToken`, `CnAstNode`。

2. **函数名**：
   - 使用小写 + 下划线：
     - 例如：`lexer_next_token`, `parser_parse_statement`, `type_check_expression`；
   - 遵循“动词 + 宾语”风格，如 `create_*`、`destroy_*`、`add_*`、`remove_*`。

3. **变量名**：
   - 使用小写 + 下划线：`current_token`, `symbol`, `type_info`；
   - 禁用单字母命名（除非常局部的循环计数，如 `i`, `j`）。

4. **宏名**：
   - 使用全大写 + 下划线：`CN_MAX_TOKENS`、`CN_ASSERT`。

5. **枚举值**：
   - 使用大写 + 下划线，并带有统一前缀：

     ```c
     typedef enum CnTokenKind {
         CN_TOKEN_IDENT,
         CN_TOKEN_INTEGER,
         CN_TOKEN_STRING,
         CN_TOKEN_EOF,
     } CnTokenKind;
     ```

### 4.2 模块前缀

- 为避免符号冲突，公共 API 应带模块前缀：
  - 前端：`cn_frontend_*` / `CnFrontend*`
  - 语义：`cn_sem_*` / `CnSem*`
  - IR：`cn_ir_*` / `CnIr*`
  - 后端：`cn_backend_*` / `CnBackend*`
  - 运行时：`cn_rt_*` / `CnRuntime*`
  - 支持库：`cn_support_*` / `CnSupport*`

## 5. 函数设计规范

1. **单一职责**：
   - 每个函数只做一件相对清晰的事情；
   - 出现大量条件分支或嵌套时，应考虑拆分为多个小函数。

2. **参数数量**：
   - 建议函数参数不超过 5 个；
   - 若超过，考虑封装为结构体或上下文对象。

3. **错误返回方式**：
   - 模块应尽量采用统一的错误返回约定（例如返回 `bool` + 输出参数，或返回错误码枚举）；
   - 诊断信息统一通过 `diagnostics` 模块输出，而不是随处 `printf`。

4. **早返回优先**：
   - 尽量使用“早返回”减少嵌套层级：

     ```c
     if (!condition) {
         return false;
     }
     /* 正常路径 */
     ```

## 6. 注释规范

1. **注释语言**：
   - 推荐使用简明中文描述业务含义、语义约束；
   - 对接口/类型/算法等关键部分，如有必要，可同时给出英文术语，便于与资料对照。

2. **注释风格**：
   - 行注释使用 `//`；块注释使用 `/* ... */`；
   - 不使用花哨 ASCII 艺术，只在必要时使用简单分隔线。

3. **注释内容**：
   - 注释应解释“做什么”和“为什么这样做”，而不是逐行翻译代码；
   - 复杂算法或非直观实现，必须在函数头部写明高层设计与关键不变量。

4. **TODO/FIXME 标记**：
   - 使用统一格式：`// TODO: 描述`、`// FIXME: 描述`；
   - 必要时附上 issue/任务编号。

## 7. 头文件与依赖管理

1. **头文件保护**：

   ```c
   #ifndef CN_TOKEN_H
   #define CN_TOKEN_H

   /* declarations */

   #endif /* CN_TOKEN_H */
   ```

2. **包含顺序**：
   - 先包含对应模块的公共头文件，再包含 C 标准库头文件，最后是本模块内部头文件；
   - 避免在头文件中包含不必要的其他模块头文件，减少编译依赖。

3. **前向声明**：
   - 当只需要指针/引用时，优先使用前向声明，减少头文件耦合。

## 8. 测试代码风格

1. **测试代码位置**：
   - 所有测试代码放在 `tests/` 目录的对应模块子目录下（`unit/`、`integration/`、`system/`）；
   - 测试代码的命名和风格可以略微宽松，但仍建议遵守本文规范。

2. **测试命名**：
   - 单元测试可采用 `test_<模块>_<行为>` 风格命名测试函数或可执行文件。

---

本规范为首版，可在开发过程中根据实际经验迭代更新，但**修改需在评审后统一调整整个代码库**，避免风格混乱。
