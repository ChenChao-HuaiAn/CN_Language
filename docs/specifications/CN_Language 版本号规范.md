# CN_Language 版本号规范

## 1. 概述

本文档定义 CN_Language 编译器及其工具链的版本号命名规范，为项目的长期维护与演进提供版本管理依据。

---

## 2. 版本号格式

CN_Language 采用**语义化版本控制 2.0.0**（Semantic Versioning 2.0.0，简称 SemVer）规范。

### 2.1 标准格式

```
主版本号.次版本号.修订号[-预发布标识][+构建元数据]
```

**示例**：
- `0.1.0` - 初始开发版本
- `1.0.0` - 首个稳定版本
- `1.2.3` - 主版本 1，次版本 2，修订版 3
- `1.3.0-alpha.1` - 1.3.0 的第 1 个 alpha 预发布版本
- `2.0.0-rc.1+build.20260124` - 2.0.0 的候选版本，附带构建元数据

### 2.2 版本号组成部分

| 组成部分 | 格式 | 说明 |
|---------|------|------|
| **主版本号** (MAJOR) | `X.*.*` | 不兼容的 API/语言特性变更 |
| **次版本号** (MINOR) | `*.X.*` | 向后兼容的功能新增 |
| **修订号** (PATCH) | `*.*.X` | 向后兼容的问题修正 |
| **预发布标识** | `-alpha.N`、`-beta.N`、`-rc.N` | 预发布版本标识（可选） |
| **构建元数据** | `+build.YYYYMMDD`、`+sha.HASH` | 构建信息（可选，不影响版本优先级） |

---

## 3. 版本号递增规则

### 3.1 主版本号（MAJOR）递增条件

**触发条件**（满足其一即需递增）：

1. **语言规范不兼容变更**
   - 移除或修改现有关键字语义
   - 更改核心语法结构（如函数声明、类型系统规则）
   - 删除已有的语言特性

2. **编译器 API 不兼容变更**
   - 删除或修改公共 API 函数签名（如 `lexer.h`、`parser.h` 中的公开接口）
   - 更改数据结构布局（影响 ABI 兼容性）

3. **运行时不兼容变更**
   - 修改运行时函数调用约定
   - 移除或更改标准库核心模块接口（如 `cnrt.h`）

**递增规则**：
- 主版本号 +1
- 次版本号和修订号归零
- 示例：`1.5.3` → `2.0.0`

---

### 3.2 次版本号（MINOR）递增条件

**触发条件**（满足其一即可递增）：

1. **向后兼容的语言特性新增**
   - 新增关键字或语法结构（不影响现有代码）
   - 扩展类型系统（如新增内置类型）

2. **向后兼容的 API 功能新增**
   - 新增公共 API 函数（不修改现有接口）
   - 扩展数据结构字段（保持向后兼容）

3. **工具链功能新增**
   - 新增命令行工具（如 `cnfmt`、`cncheck`）
   - 新增编译器优化选项或后端支持

4. **标准库模块新增**
   - 新增运行时库模块（如新的 `cnrt_*` 功能）

**递增规则**：
- 次版本号 +1
- 修订号归零
- 示例：`1.2.5` → `1.3.0`

---

### 3.3 修订号（PATCH）递增条件

**触发条件**（仅限问题修正）：

1. **向后兼容的 Bug 修复**
   - 修复编译器崩溃或错误行为
   - 修复语义分析错误
   - 修复代码生成缺陷

2. **性能优化**（不改变功能）
   - 提升编译速度
   - 优化生成代码质量

3. **文档更新**
   - 修正文档错误
   - 补充使用说明

**递增规则**：
- 修订号 +1
- 示例：`1.2.3` → `1.2.4`

---

## 4. 预发布版本标识

### 4.1 预发布阶段定义

| 阶段 | 标识符 | 含义 | 用途 |
|------|-------|------|------|
| **Alpha** | `-alpha.N` | 内部测试版本，功能未完成，可能有严重缺陷 | 开发团队内部验证 |
| **Beta** | `-beta.N` | 功能完成，公开测试，可能有已知问题 | 早期用户测试反馈 |
| **RC** | `-rc.N` | 发布候选版本，接近最终版本，仅修复关键缺陷 | 正式发布前的最后验证 |

**示例**：
- `0.5.0-alpha.1` → Alpha 阶段第 1 个版本
- `1.0.0-beta.2` → Beta 阶段第 2 个版本
- `2.0.0-rc.3` → Release Candidate 第 3 个版本

### 4.2 预发布版本优先级

按 SemVer 规范，版本优先级从低到高：
```
1.0.0-alpha.1 < 1.0.0-alpha.2 < 1.0.0-beta.1 < 1.0.0-rc.1 < 1.0.0
```

---

## 5. 版本号与开发阶段对应

### 5.1 当前阶段版本号约定

| 开发阶段 | 版本范围 | 稳定性承诺 |
|---------|---------|-----------|
| **阶段 1-3**（前端、语义、IR/C后端） | `0.1.x` ~ `0.3.x` | 实验性，API 可能频繁变更 |
| **阶段 4**（运行时与标准库） | `0.4.x` | 基础功能稳定，API 趋于稳定 |
| **阶段 5**（OS 开发支持） | `0.5.x` | 核心功能完善，向 1.0 收敛 |
| **阶段 6**（工具链与生态） | `0.6.x` ~ `0.9.x` | 功能完整，API 冻结 |
| **阶段 7**（性能优化与稳定版） | `1.0.0+` | 正式发布，提供长期支持 |

### 5.2 版本号 `0.y.z` 的特殊约定

- **主版本号为 `0` 表示项目处于初始开发阶段**，任何内容随时可能变更
- 在 `0.y.z` 版本中：
  - **次版本号变更可能包含不兼容改动**
  - 不保证向后兼容性
- **首个稳定版本标记为 `1.0.0`**，此后严格遵循 SemVer 兼容性承诺

---

## 6. 版本兼容性承诺

### 6.1 源代码兼容性

| 版本变更 | 兼容性要求 |
|---------|-----------|
| **PATCH 更新** (`1.2.3` → `1.2.4`) | 完全兼容，已编译代码无需重新编译 |
| **MINOR 更新** (`1.2.0` → `1.3.0`) | 源代码兼容，需重新编译 |
| **MAJOR 更新** (`1.x.x` → `2.0.0`) | 可能不兼容，需代码迁移 |

### 6.2 ABI 兼容性

- **PATCH 版本**：保证 ABI 兼容，动态库可直接替换
- **MINOR 版本**：仅保证源代码兼容，不保证 ABI 兼容
- **MAJOR 版本**：不保证 ABI 兼容

### 6.3 工具链兼容性

- **cnc 编译器**：高版本编译器可编译低版本语言规范的代码（向后兼容）
- **运行时库**：建议使用与编译器相同 MINOR 版本的运行时库
- **工具链工具**（`cnfmt`/`cncheck`/`cnlsp`）：与编译器同步更新版本号

---

## 7. 版本号管理实施

### 7.1 版本号存储位置

版本号应在以下位置统一维护：

1. **CMakeLists.txt**
   ```cmake
   project(CN_Language VERSION 0.7.0)
   set(CN_LANG_VERSION_MAJOR 0)
   set(CN_LANG_VERSION_MINOR 7)
   set(CN_LANG_VERSION_PATCH 0)
   set(CN_LANG_VERSION_PRERELEASE "alpha.1")  # 可选
   ```

2. **include/cnlang/support/version.h**
   ```c
   #define CN_LANG_VERSION_MAJOR 0
   #define CN_LANG_VERSION_MINOR 7
   #define CN_LANG_VERSION_PATCH 0
   #define CN_LANG_VERSION_STRING "0.7.0-alpha.1"
   ```

3. **Git 标签**
   ```bash
   git tag -a v0.7.0-alpha.1 -m "Release version 0.7.0-alpha.1"
   ```

### 7.2 版本号更新流程

1. **确定变更类型**（MAJOR/MINOR/PATCH）
2. **更新 CMakeLists.txt 和 version.h**
3. **更新 CHANGELOG.md**（记录变更内容）
4. **创建 Git 标签**
5. **构建发布包**

---

## 8. 变更日志规范

每次版本发布必须更新 `CHANGELOG.md`，按以下格式组织：

```markdown
## [1.2.0] - 2026-01-24

### Added（新增）
- 新增 `cnfmt` 代码格式化工具

### Changed（变更）
- 优化词法分析器性能，提升 20%

### Fixed（修复）
- 修复解析器在处理嵌套数组时的崩溃问题

### Removed（移除）
- 移除已废弃的 `--legacy-mode` 选项
```

---

## 9. 长期维护策略

### 9.1 LTS（长期支持）版本

- **定义**：每个 **MAJOR 版本的最后一个 MINOR 版本** 作为 LTS 版本
- **支持周期**：至少 2 年安全补丁和 Bug 修复支持
- **示例**：`1.9.x` 作为 1.x 系列的 LTS 版本

### 9.2 版本生命周期

| 阶段 | 持续时间 | 支持内容 |
|------|---------|---------|
| **活跃开发** | 发布后 6-12 个月 | 新功能、Bug 修复、性能优化 |
| **维护期** | 活跃开发结束后 12-18 个月 | 仅 Bug 修复和安全补丁 |
| **终止支持** | 维护期结束后 | 不再提供更新 |

---

## 10. 示例场景

### 场景 1：新增语法特性
- **变更内容**：新增 `模块` 关键字，支持模块系统
- **版本变更**：`0.5.3` → `0.6.0`（MINOR 递增）
- **理由**：向后兼容的语言特性新增

### 场景 2：修复编译器 Bug
- **变更内容**：修复数组越界检查的误报问题
- **版本变更**：`1.2.4` → `1.2.5`（PATCH 递增）
- **理由**：向后兼容的 Bug 修复

### 场景 3：重构类型系统
- **变更内容**：完全重写类型推导算法，部分类型签名不兼容
- **版本变更**：`1.5.2` → `2.0.0`（MAJOR 递增）
- **理由**：不兼容的语言规范变更

### 场景 4：发布正式版本
- **变更内容**：完成所有阶段 7 目标，发布首个稳定版本
- **版本变更**：`0.9.5` → `1.0.0`
- **理由**：项目达到生产就绪状态

---

## 11. 参考资源

- [Semantic Versioning 2.0.0](https://semver.org/)
- [Keep a Changelog](https://keepachangelog.com/)
- CN_Language 开发计划：`docs/design/CN_Language 开发计划.md`

---

## 附录：版本号快速决策流程

```
变更是否破坏兼容性？
├─ 是 → MAJOR 版本 +1
└─ 否
   └─ 是否新增功能？
      ├─ 是 → MINOR 版本 +1
      └─ 否 → PATCH 版本 +1
```

---

**文档版本**：v1.0  
**最后更新**：2026-01-24  
**维护者**：CN_Language 开发团队
