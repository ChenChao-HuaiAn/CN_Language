# 数字字面量扩展支持 TODO 列表

> **对应阶段 9 第 7-8 行**：添加十六进制数字（0x1000）、科学计数法、单精度标记等数字字面量支持

## 📋 任务概览

本 TODO 列表针对 CN_Language 数字字面量系统的扩展，主要包括：
1. **十六进制整数字面量**：支持 `0x1000`、`0xFF` 等形式
2. **二进制整数字面量**：支持 `0b1010`、`0B0101` 等形式
3. **八进制整数字面量**：支持 `0o755`、`0O644` 等形式
4. **科学计数法浮点数**：支持 `1.5e10`、`2.3E-5` 等形式
5. **单精度浮点标记**：支持 `3.14f`、`2.0F` 等形式
6. **长整数标记**：支持 `123L`、`456LL` 等形式
7. **数字分隔符**：支持 `1_000_000`、`0xFF_AB_CD` 等形式（可选）

---

## 🎯 第一阶段：十六进制整数字面量支持

### 1. 词法分析器扩展

- [ ] **任务 1.1**：在词法分析器中添加十六进制数字识别逻辑
  - **文件**：`src/frontend/lexer/lexer.c`
  - **位置**：`cn_frontend_lexer_next_token` 函数中的数字扫描部分（第 418-433 行）
  - **实现要点**：
    - 检测 `0x` 或 `0X` 前缀
    - 扫描后续的十六进制数字（0-9, a-f, A-F）
    - 至少需要一个有效的十六进制数字，否则报错
  - **验证**：能正确识别 `0x1000`、`0xFF`、`0XABCD` 等格式

- [ ] **任务 1.2**：添加十六进制字面量的 Token 类型
  - **文件**：`include/cnlang/frontend/lexer.h`
  - **实现要点**：
    - 可以复用 `CN_TOKEN_INTEGER`，或新增 `CN_TOKEN_HEX_INTEGER`
    - Token 应保留原始字符串（如 "0x1000"）用于后续转换
  - **验证**：Token 类型正确标识

- [ ] **任务 1.3**：实现十六进制到十进制的转换
  - **文件**：`src/frontend/lexer/lexer.c` 或新文件 `src/frontend/lexer/literal_parser.c`
  - **实现要点**：
    - 使用 `strtoll` 或手动实现转换逻辑
    - 支持大小写前缀（0x / 0X）
    - 处理溢出情况
  - **验证**：`0x1000` 正确转换为 4096

### 2. 语法分析器适配

- [ ] **任务 1.4**：确保语法分析器正确处理十六进制字面量
  - **文件**：`src/frontend/parser/parser.c`
  - **位置**：`parse_primary_expression` 函数
  - **实现要点**：
    - 十六进制字面量应被识别为整数表达式
    - 正确解析并创建 AST 节点
  - **验证**：能解析包含十六进制数字的表达式

### 3. 后端代码生成

- [ ] **任务 1.5**：C 代码生成器处理十六进制字面量
  - **文件**：`src/backend/cgen/cgen.c`
  - **实现要点**：
    - 可以输出为十进制数或保留十六进制格式
    - 确保与 C 语言的兼容性
  - **验证**：生成的 C 代码能正确编译和运行

### 4. 测试与验证

- [ ] **任务 1.6**：添加十六进制字面量单元测试
  - **文件**：`tests/unit/lexer/test_lexer_hex.c`（新建）
  - **测试用例**：
    - 基础十六进制：`0x0`、`0x1`、`0xFF`
    - 大小写混合：`0XAbc`、`0xDeF`
    - 大数值：`0xFFFFFFFF`、`0x7FFFFFFFFFFFFFFF`
    - 边界情况：`0x` 后无数字应报错
  - **验证**：所有测试通过

- [ ] **任务 1.7**：添加集成测试示例
  - **文件**：`examples/syntax/literals/hex_literals.cn`（新建）
  - **示例代码**：
    ```cn
    函数 主程序() {
        整数 基地址 = 0x1000;
        整数 颜色 = 0xFF00AA;
        整数 掩码 = 0xFFFFFFFF;
        打印("基地址: " + 基地址);
        返回 0;
    }
    ```
  - **验证**：示例能正确编译和运行

---

## 🎯 第二阶段：二进制和八进制整数字面量

### 5. 二进制字面量支持

- [ ] **任务 2.1**：添加二进制字面量词法识别
  - **文件**：`src/frontend/lexer/lexer.c`
  - **实现要点**：
    - 检测 `0b` 或 `0B` 前缀
    - 扫描后续的二进制数字（0-1）
    - 至少需要一个有效的二进制数字
  - **验证**：能识别 `0b1010`、`0B0101` 等

- [ ] **任务 2.2**：实现二进制到十进制的转换
  - **文件**：`src/frontend/lexer/literal_parser.c`
  - **验证**：`0b1010` 正确转换为 10

### 6. 八进制字面量支持

- [ ] **任务 2.3**：添加八进制字面量词法识别
  - **文件**：`src/frontend/lexer/lexer.c`
  - **实现要点**：
    - 检测 `0o` 或 `0O` 前缀（区别于传统 C 的 `0` 前缀）
    - 扫描后续的八进制数字（0-7）
  - **验证**：能识别 `0o755`、`0O644` 等

- [ ] **任务 2.4**：实现八进制到十进制的转换
  - **文件**：`src/frontend/lexer/literal_parser.c`
  - **验证**：`0o755` 正确转换为 493

### 7. 测试覆盖

- [ ] **任务 2.5**：添加二进制和八进制的单元测试
  - **文件**：`tests/unit/lexer/test_lexer_binary_octal.c`（新建）
  - **测试用例**：
    - 二进制：`0b0`、`0b1111`、`0B10101010`
    - 八进制：`0o0`、`0o777`、`0O644`
    - 错误情况：`0b2`、`0o8` 应报错
  - **验证**：所有测试通过

- [ ] **任务 2.6**：添加集成测试示例
  - **文件**：`examples/syntax/literals/binary_octal_literals.cn`（新建）
  - **示例代码**：
    ```cn
    函数 主程序() {
        整数 标志位 = 0b11110000;
        整数 权限 = 0o755;
        整数 掩码 = 0b10101010;
        打印("标志位: " + 标志位);
        打印("权限: " + 权限);
        返回 0;
    }
    ```

---

## 🎯 第三阶段：科学计数法浮点数支持

### 8. 科学计数法词法识别

- [ ] **任务 3.1**：扩展浮点数识别以支持科学计数法
  - **文件**：`src/frontend/lexer/lexer.c`
  - **位置**：浮点数扫描逻辑（第 424-430 行）
  - **实现要点**：
    - 识别指数部分：`e` 或 `E`
    - 指数后可选的符号：`+` 或 `-`
    - 指数部分必须是十进制整数
    - 语法形式：`数字部分[.小数部分][e|E[+|-]指数部分]`
  - **验证**：能识别 `1.5e10`、`2.3E-5`、`6.02e23`

- [ ] **任务 3.2**：实现科学计数法的解析
  - **文件**：`src/frontend/lexer/literal_parser.c`
  - **实现要点**：
    - 使用 `strtod` 或手动实现解析
    - 正确处理指数的正负号
    - 处理边界值（极大/极小值）
  - **验证**：`1.5e10` 正确转换为 15000000000.0

### 9. 测试与验证

- [ ] **任务 3.3**：添加科学计数法单元测试
  - **文件**：`tests/unit/lexer/test_lexer_scientific.c`（新建）
  - **测试用例**：
    - 基础形式：`1e10`、`1.5e10`、`2E-5`
    - 边界情况：`1e+0`、`1e-0`、`1.0e308`
    - 错误情况：`1e`、`1e+`、`1ee10` 应报错
  - **验证**：所有测试通过

- [ ] **任务 3.4**：添加集成测试示例
  - **文件**：`examples/syntax/literals/scientific_notation.cn`（新建）
  - **示例代码**：
    ```cn
    函数 主程序() {
        小数 阿伏伽德罗常数 = 6.02214076e23;
        小数 光速 = 2.99792458e8;
        小数 普朗克常数 = 6.62607015e-34;
        打印("阿伏伽德罗常数: " + 阿伏伽德罗常数);
        返回 0;
    }
    ```

---

## 🎯 第四阶段：类型后缀标记支持

### 10. 单精度浮点后缀

- [ ] **任务 4.1**：添加 `f/F` 后缀识别
  - **文件**：`src/frontend/lexer/lexer.c`
  - **实现要点**：
    - 在浮点数扫描后检测 `f` 或 `F` 后缀
    - 创建单精度浮点类型标记
  - **验证**：能识别 `3.14f`、`2.0F`

- [ ] **任务 4.2**：类型系统支持单精度浮点
  - **文件**：`include/cnlang/frontend/ast.h`、`src/semantics/checker/type_checker.c`
  - **实现要点**：
    - 添加 `单精度` 或 `float` 类型标识
    - 与现有 `小数` (double) 类型区分
  - **验证**：类型检查器能正确识别单精度类型

### 11. 整数后缀

- [ ] **任务 4.3**：添加长整数后缀识别
  - **文件**：`src/frontend/lexer/lexer.c`
  - **实现要点**：
    - 支持 `L`/`l` 后缀（long）
    - 支持 `LL`/`ll` 后缀（long long）
    - 支持 `U`/`u` 后缀（unsigned）
    - 支持组合：`UL`、`ULL` 等
  - **验证**：能识别 `123L`、`456LL`、`789U`

- [ ] **任务 4.4**：类型系统支持不同整数大小
  - **文件**：类型系统相关文件
  - **实现要点**：
    - 添加 `长整数`、`超长整数`、`无符号整数` 等类型
    - 后端生成对应的 C 类型（long, long long, unsigned）
  - **验证**：不同整数类型能正确处理

### 12. 测试覆盖

- [ ] **任务 4.5**：添加类型后缀单元测试
  - **文件**：`tests/unit/lexer/test_lexer_suffixes.c`（新建）
  - **测试用例**：
    - 浮点后缀：`3.14f`、`2.0F`、`1e10f`
    - 整数后缀：`123L`、`456LL`、`789U`、`100ULL`
    - 错误情况：`123Lf`、`3.14LL` 应报错
  - **验证**：所有测试通过

- [ ] **任务 4.6**：添加集成测试示例
  - **文件**：`examples/syntax/literals/type_suffixes.cn`（新建）
  - **示例代码**：
    ```cn
    函数 主程序() {
        单精度 圆周率 = 3.14159f;
        长整数 大数 = 9223372036854775807LL;
        无符号整数 掩码 = 0xFFFFFFFFU;
        打印("单精度圆周率: " + 圆周率);
        返回 0;
    }
    ```

---

## 🎯 第五阶段（可选）：数字分隔符支持

### 13. 数字分隔符

- [ ] **任务 5.1**：添加下划线分隔符支持
  - **文件**：`src/frontend/lexer/lexer.c`
  - **实现要点**：
    - 允许在数字中使用 `_` 作为视觉分隔符
    - 分隔符不能出现在数字开头、结尾或连续出现
    - 分隔符不影响数字的实际值
  - **验证**：能识别 `1_000_000`、`0xFF_AB_CD`

- [ ] **任务 5.2**：测试数字分隔符
  - **文件**：`tests/unit/lexer/test_lexer_separator.c`（新建）
  - **测试用例**：
    - 有效分隔符：`1_000`、`0xFF_00_AA`、`1.5e1_0`
    - 错误情况：`_100`、`100_`、`1__000` 应报错
  - **验证**：所有测试通过

---

## 🎯 第六阶段：规范文档更新

### 14. 语言规范更新

- [ ] **任务 6.1**：更新语言规范中的字面量章节
  - **文件**：`docs/specifications/CN_Language 语言规范草案（核心子集）.md`
  - **位置**：2.4 节"字面量"（第 173-196 行）
  - **更新内容**：
    - 添加十六进制整数规范：`0x[0-9a-fA-F]+`
    - 添加二进制整数规范：`0b[01]+`
    - 添加八进制整数规范：`0o[0-7]+`
    - 添加科学计数法规范：`[0-9]+(\.[0-9]+)?[eE][+-]?[0-9]+`
    - 添加类型后缀规范：`f/F/l/L/ll/LL/u/U` 等
    - 添加数字分隔符规范（如果实现）
  - **验证**：规范文档描述清晰完整

- [ ] **任务 6.2**：添加字面量示例
  - **文件**：同上
  - **示例代码**：
    ```cn
    // 整数字面量（不同进制）
    整数 十进制 = 1000;
    整数 十六进制 = 0x3E8;
    整数 二进制 = 0b1111101000;
    整数 八进制 = 0o1750;
    
    // 浮点字面量（不同形式）
    小数 标准形式 = 3.14159;
    小数 科学计数法 = 6.02e23;
    单精度 单精度浮点 = 2.718f;
    
    // 带后缀的整数
    长整数 大整数 = 9223372036854775807LL;
    无符号整数 无符号数 = 4294967295U;
    ```

### 15. 测试规范更新

- [ ] **任务 6.3**：更新测试规范
  - **文件**：`docs/specifications/CN_Language 测试规范.md`
  - **更新内容**：
    - 添加字面量测试的要求和标准
    - 明确各种字面量形式的测试覆盖范围
  - **验证**：测试规范与实现一致

---

## 🎯 第七阶段：错误处理与诊断

### 16. 错误处理增强

- [ ] **任务 7.1**：添加详细的字面量错误诊断
  - **文件**：`include/cnlang/support/diagnostics.h`、`src/support/diagnostics/diagnostics.c`
  - **错误代码**：
    - `CN_DIAG_CODE_LEX_INVALID_HEX`：无效的十六进制字面量
    - `CN_DIAG_CODE_LEX_INVALID_BINARY`：无效的二进制字面量
    - `CN_DIAG_CODE_LEX_INVALID_OCTAL`：无效的八进制字面量
    - `CN_DIAG_CODE_LEX_INVALID_SCIENTIFIC`：无效的科学计数法
    - `CN_DIAG_CODE_LEX_INVALID_SUFFIX`：无效的类型后缀
    - `CN_DIAG_CODE_LEX_LITERAL_OVERFLOW`：字面量溢出
  - **验证**：错误诊断信息清晰友好

- [ ] **任务 7.2**：添加字面量溢出检测
  - **文件**：`src/frontend/lexer/literal_parser.c`
  - **实现要点**：
    - 检测整数字面量是否超出类型范围
    - 检测浮点字面量是否超出表示范围
    - 提供友好的错误提示和建议
  - **验证**：溢出情况能正确检测并报告

### 17. 错误恢复

- [ ] **任务 7.3**：实现字面量错误恢复策略
  - **文件**：`src/frontend/lexer/lexer.c`
  - **实现要点**：
    - 遇到无效字面量时跳过到下一个 token
    - 尽可能继续词法分析，发现更多错误
  - **验证**：能在错误后继续分析

---

## 🎯 第八阶段：性能优化与文档完善

### 18. 性能优化

- [ ] **任务 8.1**：优化字面量解析性能
  - **文件**：`src/frontend/lexer/literal_parser.c`
  - **优化方向**：
    - 使用查表法加速进制转换
    - 减少字符串操作和内存分配
    - 对常见情况做快速路径优化
  - **验证**：性能测试显示改进

### 19. API 文档

- [ ] **任务 8.2**：编写字面量解析 API 文档
  - **文件**：`docs/api/frontend/literal_parser.md`（新建）
  - **内容**：
    - 各种字面量格式的语法定义
    - 解析函数的接口说明
    - 错误处理机制
  - **验证**：文档完整准确

### 20. 用户指南

- [ ] **任务 8.3**：更新用户指南中的字面量部分
  - **文件**：`docs/user-guide/CN_Language_1.0_新特性指南.md`
  - **内容**：
    - 数字字面量的各种写法
    - 常见场景和最佳实践
    - 常见错误和解决方法
  - **验证**：用户指南易于理解

---

## 📊 验收标准

### 功能验收
- [ ] 所有单元测试通过
- [ ] 所有集成测试通过
- [ ] 示例程序能正确编译和运行
- [ ] 生成的 C 代码符合标准

### 质量验收
- [ ] 代码符合 `CN_Language C 代码风格规范.md`
- [ ] 错误诊断信息清晰友好
- [ ] 性能没有明显退化

### 文档验收
- [ ] 语言规范已更新
- [ ] 测试规范已更新
- [ ] API 文档已完善
- [ ] 用户指南已更新

---

## 📝 实施建议

### 实施顺序
1. **优先级 P0**：十六进制字面量（最常用，影响 OS 开发）
2. **优先级 P1**：科学计数法（科学计算场景需要）
3. **优先级 P2**：二进制和八进制字面量（位操作场景）
4. **优先级 P3**：类型后缀（类型精度控制）
5. **优先级 P4**：数字分隔符（可读性改进，可选）

### 开发建议
- 每完成一个阶段后进行完整测试
- 确保向后兼容，不破坏现有功能
- 文档与代码同步更新
- 参考 C/C++、Rust、Go 等语言的成熟实现

### 测试策略
- 单元测试覆盖所有格式和边界情况
- 集成测试验证实际使用场景
- 添加性能基准测试
- 包含错误情况测试

---

## 🔗 相关文件

### 核心实现文件
- `src/frontend/lexer/lexer.c`：词法分析器主逻辑
- `src/frontend/lexer/literal_parser.c`：字面量解析（可能需要新建）
- `include/cnlang/frontend/lexer.h`：词法分析器接口

### 测试文件
- `tests/unit/lexer/test_lexer_hex.c`
- `tests/unit/lexer/test_lexer_binary_octal.c`
- `tests/unit/lexer/test_lexer_scientific.c`
- `tests/unit/lexer/test_lexer_suffixes.c`
- `tests/unit/lexer/test_lexer_separator.c`

### 示例文件
- `examples/syntax/literals/hex_literals.cn`
- `examples/syntax/literals/binary_octal_literals.cn`
- `examples/syntax/literals/scientific_notation.cn`
- `examples/syntax/literals/type_suffixes.cn`

### 规范文档
- `docs/specifications/CN_Language 语言规范草案（核心子集）.md`
- `docs/specifications/CN_Language 测试规范.md`
- `docs/specifications/CN_Language C 代码风格规范.md`

---

## 📅 预估时间

- **第一阶段（十六进制）**：2-3 天
- **第二阶段（二进制/八进制）**：1-2 天
- **第三阶段（科学计数法）**：1-2 天
- **第四阶段（类型后缀）**：2-3 天
- **第五阶段（数字分隔符）**：1 天（可选）
- **第六阶段（文档更新）**：1 天
- **第七阶段（错误处理）**：1-2 天
- **第八阶段（优化与文档）**：1-2 天

**总计**：10-16 天（不含可选功能）

---

**备注**：
- 本 TODO 列表可根据实际开发进度调整
- 建议先实现 P0/P1 优先级功能，确保核心需求满足
- 遇到技术难点可参考其他语言的实现
- 保持与语言规范的一致性
