# 阶段 4：最小运行时与基础标准库 TODO 列表

根据 `CN_Language 开发计划.md` 第 137-158 行定义的阶段 4 目标，细分以下具体任务。

## 4.1 运行时初始化
- [x] **4.1.1 设计运行时初始化接口**：在 `include/cnlang/runtime/runtime.h` 中定义 `cn_rt_init()` 和 `cn_rt_exit()`。
- [x] **4.1.2 实现程序入口包装**：在 `src/runtime/core/runtime.c` 中实现 `cn_rt_init()` 全局初始化逻辑。
- [x] **4.1.3 实现退出流程**：在 `src/runtime/core/runtime.c` 中实现 `cn_rt_exit()` 资源清理。
- [x] **4.1.4 全局状态管理**：添加运行时全局状态结构体（如错误状态、堆统计）。
- [x] **4.1.5 C 后端集成**：确保 `cgen.c` 生成的代码在 `main()` 中调用 `cn_rt_init/exit`。

## 4.2 内存管理
- [ ] **4.2.1 设计内存管理接口**：新建 `include/cnlang/runtime/memory.h` 定义统一内存分配接口。
- [ ] **4.2.2 实现基础分配器**：在 `src/runtime/memory/memory.c` 中封装 `cn_rt_malloc/free/realloc`。
- [ ] **4.2.3 添加内存分配追踪**：可选调试模式，追踪分配/释放统计。
- [ ] **4.2.4 预留自定义分配器钩子**：为 OS 开发场景预留页分配器接口。
- [ ] **4.2.5 迁移现有分配调用**：将现有模块中的 `malloc/free` 替换为运行时统一接口。
- [ ] **4.2.6 更新 CMakeLists**：将 memory 模块加入构建。

## 4.3 基础标准库
### 字符串处理
- [ ] **4.3.1 补充字符串函数**：添加 `cn_rt_string_index_of`, `cn_rt_string_trim` 等。
- [ ] **4.3.2 字符串格式化**：实现简单格式化输出 `cn_rt_format`。
### 简单 I/O
- [ ] **4.3.3 设计 I/O 接口**：新建 `include/cnlang/runtime/io.h`。
- [ ] **4.3.4 实现控制台输入**：实现 `cn_rt_read_line`, `cn_rt_read_int`。
- [ ] **4.3.5 实现基础文件操作**：封装文件打开/读/写/关闭。
### 数学函数
- [ ] **4.3.6 设计数学接口**：新建 `include/cnlang/runtime/math.h`。
- [ ] **4.3.7 实现数学函数**：封装 `cn_rt_abs`, `cn_rt_min`, `cn_rt_max`, `cn_rt_pow` 等。

## 4.4 与语言特性绑定
- [ ] **4.4.1 文档化运行时依赖**：明确哪些语言特性依赖运行时。
- [ ] **4.4.2 字符串类型绑定**：确保 C 后端生成正确的运行时调用。
- [ ] **4.4.3 数组类型绑定**：确保数组操作使用运行时接口。
- [ ] **4.4.4 内置函数映射**：将语言内置函数（如 `长度()`）映射到运行时调用。

## 4.5 测试覆盖
- [ ] **4.5.1 创建运行时单元测试目录**：建立 `tests/unit/runtime/`。
- [ ] **4.5.2 内存管理单元测试**：测试分配/释放/追踪功能。
- [ ] **4.5.3 字符串函数单元测试**：测试所有字符串操作函数。
- [ ] **4.5.4 数组函数单元测试**：测试数组分配/越界检查。
- [ ] **4.5.5 I/O 函数单元测试**：测试输入输出函数。
- [ ] **4.5.6 运行时集成测试**：编写依赖运行时的 `.cn` 示例并验证。
- [ ] **4.5.7 更新测试 CMakeLists**：将运行时测试加入构建。
