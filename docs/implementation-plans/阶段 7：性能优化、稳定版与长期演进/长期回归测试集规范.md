# CN_Language 长期回归测试集规范

> 本文档定义 CN_Language 项目的长期回归测试集构成、维护规则与执行流程。
> 创建日期：2026-01-24
> 最后更新：2026-01-24

## 1. 总览

### 1.1 目标

长期回归测试集旨在确保：
1. **关键功能不退化**：核心编译流程、运行时能力、工具链功能不因新特性/优化/重构而破坏
2. **性能不劣化**：关键路径性能指标保持稳定或改进，避免意外性能下降
3. **历史问题不复现**：已修复的 bug 不会因后续变更而重新出现

### 1.2 测试集覆盖范围

回归测试集包含以下类别：

| 类别 | 描述 | 优先级 |
|------|------|--------|
| **功能回归** | 核心编译器功能、运行时功能 | P0 |
| **性能回归** | 关键路径性能基准验证 | P0 |
| **历史问题** | 已修复 bug 的防复现测试 | P1 |
| **边界场景** | 极端输入、错误处理 | P1 |

## 2. 功能回归测试

### 2.1 核心功能清单

基于现有测试体系，以下功能必须纳入长期回归测试：

#### 2.1.1 前端功能（词法、语法、语义）

**文件**: `tests/unit/regression_test.c`（已实施）

**覆盖项**:
- ✅ 词法分析器基本功能（关键字、标识符、字面量）
- ✅ UTF-8 中文标识符与关键字处理
- ✅ 多 token 序列解析
- ✅ 诊断系统基本功能（错误/警告报告）

**扩展需求**（待补充）:
- [ ] 语法分析器核心结构（函数、控制流、数组）
- [ ] 语义分析核心检查（符号解析、类型检查）
- [ ] 错误恢复机制（解析错误后能否继续）

#### 2.1.2 中端与后端功能（IR、代码生成）

**现有覆盖**:
- 数组字面量与索引访问（`integration_array_test`）
- 字符串数组处理（`integration_string_array_test`）
- 端到端编译流程（`integration_compile_full_test`）

**扩展需求**:
- [ ] IR 常量折叠回归测试
- [ ] IR 死代码消除回归测试
- [ ] C 代码生成正确性验证（关键结构）
- [ ] Freestanding 模式编译链路

#### 2.1.3 运行时库功能

**现有覆盖**:
- 内存管理（`runtime_memory_test`）
- 字符串操作（`runtime_string_test`）
- 数组操作（`runtime_array_test`）
- 数学函数（`runtime_math_test`）

**扩展需求**:
- [ ] 内核 I/O 回调机制回归（freestanding 场景）
- [ ] 边界条件处理（空数组、空字符串、溢出）

#### 2.1.4 工具链功能

**现有覆盖**:
- REPL 基本功能（表达式求值、语句执行、会话管理）
- 格式化工具（`cnfmt`）
- 静态检查工具（`cncheck`）

**扩展需求**:
- [ ] LSP 功能回归（代码补全、诊断、跳转）
- [ ] 性能分析工具（`cnperf`）基本功能

### 2.2 维护规则

1. **新增功能时**：
   - 必须同步添加回归测试用例到对应模块测试文件
   - 测试用例必须覆盖核心正向路径与典型负向场景

2. **修改功能时**：
   - 必须确保相关回归测试通过
   - 若行为变更，需同步更新测试与文档

3. **重构时**：
   - 所有功能回归测试必须 100% 通过

## 3. 性能回归测试

### 3.1 性能基准场景

#### 3.1.1 前端性能基准

**测试文件**: `tests/unit/lexer_performance_test.c`（已实施）

**基准指标**:
- 词法分析吞吐量：≥ 500 tokens/ms
- `next_token` 调用耗时：< 5 μs/次

**扩展场景**（待补充）:
- [ ] 语法分析大型文件性能（1000+ 行代码）
- [ ] 语义分析符号表查找性能（100+ 符号）

#### 3.1.2 内存管理性能基准

**测试文件**: 
- `tests/unit/arena_stress_test.c`（已实施）
- `tests/unit/memory_leak_test.c`（已实施）

**基准指标**:
- Arena 分配速度：< 1 μs/次
- Arena vs malloc 加速比：> 2x
- Arena reset 耗时：< 10 μs/次
- 内存泄漏检测准确率：100%

#### 3.1.3 端到端编译性能（大项目）

**扩展需求**（待补充）:
- [ ] 编译 500 行代码项目：< 100 ms
- [ ] 编译 1000 行代码项目：< 300 ms
- [ ] 多文件项目编译（10+ 文件）

#### 3.1.4 IR 与代码生成性能

**扩展需求**（待补充）:
- [ ] IR 生成大型 AST 性能
- [ ] C 代码生成 1000+ IR 节点性能
- [ ] 优化 Pass 执行时间（常量折叠、死代码消除）

### 3.2 维护规则

1. **性能基准更新**：
   - 每次性能优化后，必须更新对应基准文档
   - 基准值变更需在 commit message 中说明原因

2. **性能劣化处理**：
   - 任何导致性能劣化 > 10% 的变更，必须在 PR 中明确说明原因
   - 若无合理解释，不允许合并

3. **性能测试执行频率**：
   - 本地开发：按需执行（修改性能相关代码时）
   - CI 流程：每次 PR 自动执行（标记为 `stage7;performance`）
   - 夜间构建：运行完整性能测试套件

## 4. 历史问题回归测试

### 4.1 已修复问题清单

基于项目历史，记录以下已修复问题（持续更新）：

| 问题编号 | 问题描述 | 修复版本 | 回归测试位置 |
|----------|----------|----------|--------------|
| #001 | UTF-8 中文标识符长度计算错误 | v0.1.0 | `regression_test.c::test_utf8_handling_regression` |
| #002 | Arena 分配器大对象内存泄漏 | v0.2.0 | `arena_stress_test.c::test_arena_large_allocation` |
| #003 | 诊断系统错误计数不准确 | v0.2.0 | `regression_test.c::test_diagnostics_functionality_regression` |
| （待补充） | - | - | - |

### 4.2 维护规则

1. **Bug 修复流程**：
   ```
   发现 Bug → 编写复现测试（测试失败）→ 修复代码 → 测试通过 → 记录到历史问题清单
   ```

2. **测试用例位置**：
   - 优先添加到现有 `regression_test.c`
   - 若涉及特定模块，可添加到模块专项测试文件
   - 必须使用明确的测试函数名：`test_bugfix_<编号>_<简要描述>`

3. **历史问题清单更新**：
   - 每次 Bug 修复后，必须在本节表格中添加记录
   - 包含：问题编号、描述、修复版本、测试文件路径
   - 问题编号格式：`#NNN`（三位数字，从 #001 开始递增）

## 5. 边界场景与错误处理回归

### 5.1 边界输入场景

**待补充测试**：
- [ ] 空源文件编译
- [ ] 超大文件编译（10,000+ 行）
- [ ] 深度嵌套结构（100+ 层）
- [ ] 大量符号（1,000+ 变量/函数）
- [ ] 极端字面量（最大/最小整数、超长字符串）

### 5.2 错误恢复场景

**待补充测试**：
- [ ] 解析错误后继续编译
- [ ] 多个语义错误同时报告
- [ ] 内存不足时优雅降级

### 5.3 维护规则

1. 每发现一个边界 bug，必须添加对应的边界测试
2. 错误恢复测试必须验证：
   - 程序不崩溃
   - 错误诊断信息准确
   - 后续编译流程能正常处理或安全终止

## 6. 回归测试集执行流程

详见《长期回归测试集执行指南.md》（本目录下），包括：
- 本地开发执行流程
- CI 自动化执行配置
- 结果记录与报告格式

## 7. 附录：测试标签体系

所有回归测试使用 CMake `set_tests_properties()` 设置标签，便于分类执行。

### 7.1 标签定义

| 标签 | 含义 |
|------|------|
| `regression` | 回归测试（核心功能防退化） |
| `performance` | 性能测试（基准验证） |
| `stress` | 压力测试（极端场景） |
| `memory` | 内存管理测试 |
| `leak` | 内存泄漏检测 |
| `stage7` | 阶段 7 相关测试 |
| `unit` | 单元测试 |
| `integration` | 集成测试 |

### 7.2 执行示例

```bash
# 运行所有回归测试
ctest -L regression -V

# 运行性能回归测试
ctest -L "performance" -V

# 运行阶段 7 所有测试
ctest -L stage7 -V

# 运行回归+性能（交集）
ctest -L "regression" -L "performance" -V
```

---

**本规范随项目演进持续更新**，新增测试场景、性能基准、历史问题等信息均应及时补充到本文档。
