# CN_Language 长期回归测试集执行指南

> 本文档定义长期回归测试集的执行流程、结果记录与报告格式。
> 创建日期：2026-01-24
> 最后更新：2026-01-24

## 1. 测试执行流程概览

长期回归测试集的执行场景包括：

| 场景 | 执行时机 | 执行范围 | 结果处理 |
|------|----------|----------|----------|
| **本地开发** | 开发者修改代码后 | 相关模块测试 | 本地验证，失败则修复 |
| **PR 构建** | 提交 Pull Request 时 | 所有回归测试（快速） | CI 自动执行，失败则阻止合并 |
| **夜间构建** | 每日夜间定时 | 完整测试套件（含大规模） | 生成报告，异常时告警 |
| **版本发布前** | 正式版本发布前 | 完整测试套件 + 手动验证 | 记录基准，更新文档 |

---

## 2. 本地开发执行流程

### 2.1 基本流程

开发者在修改代码后，应根据变更类型执行对应测试：

```bash
# 1. 切换到构建目录
cd build

# 2. 重新构建（若修改了代码）
cmake --build .

# 3. 运行相关测试
# 场景 A：修改了前端（词法/语法/语义）
ctest -R "lexer|parser|semantic" -V

# 场景 B：修改了内存管理
ctest -L memory -V

# 场景 C：修改了性能相关代码
ctest -L performance -V

# 场景 D：运行所有回归测试
ctest -L regression -V

# 场景 E：运行所有阶段 7 测试
ctest -L stage7 -V
```

### 2.2 快速验证（推荐）

对于快速迭代开发，可使用以下命令组合：

```bash
# 只运行关键回归测试（< 1 秒）
ctest -R regression_test -V

# 运行单个测试
ctest -R lexer_performance_test -V

# 运行多个标签交集（回归 + 性能）
ctest -L regression -L performance -V
```

### 2.3 结果验证

**成功标志**：
```
100% tests passed, 0 tests failed out of N
```

**失败处理**：
1. 查看失败测试的输出日志
2. 定位失败原因：
   - 功能回归 → 修复代码逻辑
   - 性能劣化 → 分析性能瓶颈（使用 profiler）
   - 测试用例过时 → 更新测试用例（需评审）
3. 修复后重新运行测试
4. 确认所有测试通过后再提交代码

---

## 3. CI 自动化执行配置

### 3.1 GitHub Actions 配置示例

（待实施）创建 `.github/workflows/regression_tests.yml`：

```yaml
name: 长期回归测试

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  regression-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        build_type: [Release]

    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 配置 CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

      - name: 构建
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: 运行回归测试
        run: |
          cd build
          ctest -L regression -V --output-on-failure

      - name: 运行性能测试
        run: |
          cd build
          ctest -L performance -V --output-on-failure

      - name: 上传测试结果
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.os }}
          path: build/Testing/Temporary/LastTest.log
```

### 3.2 性能劣化检测（待实施）

扩展 CI 配置，添加性能基准对比：

```yaml
      - name: 性能基准对比
        run: |
          cd build
          # 运行性能测试并导出结果
          ctest -R performance -V > perf_results.txt
          # 对比历史基准（需实现对比脚本）
          python ../tools/compare_perf.py perf_results.txt baseline.txt
```

### 3.3 CI 结果处理

**通过标准**：
- 所有回归测试 100% 通过
- 性能测试无劣化 > 10%（或已在 PR 描述中说明）

**失败处理**：
- CI 状态显示为失败，阻止合并
- 开发者根据 CI 日志定位问题并修复
- 重新推送后 CI 自动重新运行

---

## 4. 夜间构建执行流程

### 4.1 执行范围

夜间构建应运行完整测试套件，包括：
- 所有功能回归测试
- 所有性能回归测试（含大规模场景）
- 所有内存泄漏检测测试
- 所有压力测试

### 4.2 执行脚本示例

创建 `tools/nightly_tests.ps1`（Windows）：

```powershell
# CN_Language 夜间回归测试脚本

param(
    [string]$BuildDir = "build",
    [string]$ReportDir = "test_reports"
)

Write-Host "===== CN_Language 夜间回归测试 =====" -ForegroundColor Cyan
Write-Host "时间: $(Get-Date)" -ForegroundColor Cyan
Write-Host ""

# 1. 清理并重新构建
Write-Host "[1/4] 清理并构建..." -ForegroundColor Yellow
Remove-Item -Recurse -Force $BuildDir -ErrorAction SilentlyContinue
cmake -B $BuildDir -DCMAKE_BUILD_TYPE=Release
cmake --build $BuildDir --config Release

# 2. 运行所有回归测试
Write-Host "[2/4] 运行所有回归测试..." -ForegroundColor Yellow
Set-Location $BuildDir
$result_regression = ctest -L regression -V --output-on-failure
$exit_regression = $LASTEXITCODE

# 3. 运行所有性能测试
Write-Host "[3/4] 运行所有性能测试..." -ForegroundColor Yellow
$result_performance = ctest -L performance -V --output-on-failure
$exit_performance = $LASTEXITCODE

# 4. 运行所有阶段 7 测试
Write-Host "[4/4] 运行所有阶段 7 测试..." -ForegroundColor Yellow
$result_stage7 = ctest -L stage7 -V --output-on-failure
$exit_stage7 = $LASTEXITCODE

Set-Location ..

# 5. 生成报告
Write-Host "生成测试报告..." -ForegroundColor Yellow
New-Item -ItemType Directory -Force -Path $ReportDir | Out-Null
$report_file = "$ReportDir/nightly_report_$(Get-Date -Format 'yyyyMMdd_HHmmss').txt"

@"
===== CN_Language 夜间回归测试报告 =====
时间: $(Get-Date)
构建目录: $BuildDir

--- 回归测试结果 ---
退出码: $exit_regression
$result_regression

--- 性能测试结果 ---
退出码: $exit_performance
$result_performance

--- 阶段 7 测试结果 ---
退出码: $exit_stage7
$result_stage7

=======================================
"@ | Out-File -FilePath $report_file -Encoding utf8

# 6. 结果判断与告警
if ($exit_regression -ne 0 -or $exit_performance -ne 0 -or $exit_stage7 -ne 0) {
    Write-Host "❌ 测试失败！请查看报告: $report_file" -ForegroundColor Red
    exit 1
} else {
    Write-Host "✅ 所有测试通过！" -ForegroundColor Green
    exit 0
}
```

创建 `tools/nightly_tests.sh`（Linux/macOS）：

```bash
#!/bin/bash

# CN_Language 夜间回归测试脚本

BUILD_DIR="build"
REPORT_DIR="test_reports"

echo "===== CN_Language 夜间回归测试 ====="
echo "时间: $(date)"
echo ""

# 1. 清理并重新构建
echo "[1/4] 清理并构建..."
rm -rf $BUILD_DIR
cmake -B $BUILD_DIR -DCMAKE_BUILD_TYPE=Release
cmake --build $BUILD_DIR

# 2. 运行所有回归测试
echo "[2/4] 运行所有回归测试..."
cd $BUILD_DIR
ctest -L regression -V --output-on-failure
exit_regression=$?

# 3. 运行所有性能测试
echo "[3/4] 运行所有性能测试..."
ctest -L performance -V --output-on-failure
exit_performance=$?

# 4. 运行所有阶段 7 测试
echo "[4/4] 运行所有阶段 7 测试..."
ctest -L stage7 -V --output-on-failure
exit_stage7=$?

cd ..

# 5. 生成报告
echo "生成测试报告..."
mkdir -p $REPORT_DIR
report_file="$REPORT_DIR/nightly_report_$(date +%Y%m%d_%H%M%S).txt"

cat > $report_file << EOF
===== CN_Language 夜间回归测试报告 =====
时间: $(date)
构建目录: $BUILD_DIR

--- 回归测试结果 ---
退出码: $exit_regression

--- 性能测试结果 ---
退出码: $exit_performance

--- 阶段 7 测试结果 ---
退出码: $exit_stage7

=======================================
EOF

# 6. 结果判断与告警
if [ $exit_regression -ne 0 ] || [ $exit_performance -ne 0 ] || [ $exit_stage7 -ne 0 ]; then
    echo "❌ 测试失败！请查看报告: $report_file"
    exit 1
else
    echo "✅ 所有测试通过！"
    exit 0
fi
```

### 4.3 夜间构建结果处理

**成功情况**：
- 保留测试报告归档
- 更新性能基准数据库（若实施）

**失败情况**：
- 发送邮件/Slack 通知给团队
- 在项目看板中创建 Issue
- 尽快定位并修复问题

---

## 5. 版本发布前执行流程

### 5.1 执行清单

在正式版本发布前，必须完成以下测试：

- [ ] **运行所有回归测试**：`ctest -L regression -V`
- [ ] **运行所有性能测试**：`ctest -L performance -V`
- [ ] **运行所有阶段 7 测试**：`ctest -L stage7 -V`
- [ ] **运行所有集成测试**：`ctest -L integration -V`
- [ ] **运行所有单元测试**：`ctest -L unit -V`
- [ ] **手动验证关键场景**：编译示例程序、REPL 基本功能、格式化工具
- [ ] **对比性能基准**：与上一版本对比，记录变化
- [ ] **生成测试报告**：归档所有测试结果
- [ ] **更新文档**：更新 `长期回归测试集规范.md` 和 `性能回归测试场景清单.md`

### 5.2 性能基准对比

```bash
# 1. 运行性能测试并保存结果
cd build
ctest -L performance -V > ../perf_results_v0.x.x.txt

# 2. 对比上一版本（手动或使用脚本）
# 比较 perf_results_v0.x.x.txt 与 perf_results_v0.(x-1).(x-1).txt
# 关注以下指标：
# - Arena 分配速度
# - 词法分析器吞吐量
# - 内存泄漏检测准确率
# - 端到端编译时间（若已实施）

# 3. 记录到发布说明
# 示例：
#   性能改进：
#   - 词法分析器吞吐量提升 15%（500 tokens/ms → 575 tokens/ms）
#   - Arena 分配速度提升 50%（2 μs → 1 μs）
#   性能劣化：
#   - 无
```

### 5.3 测试报告归档

```bash
# 创建版本专属报告目录
mkdir -p test_reports/v0.x.x

# 保存测试结果
cp build/Testing/Temporary/LastTest.log test_reports/v0.x.x/
cp perf_results_v0.x.x.txt test_reports/v0.x.x/

# 生成汇总报告
cat > test_reports/v0.x.x/summary.md << EOF
# CN_Language v0.x.x 回归测试报告

## 测试时间
$(date)

## 测试环境
- OS: Windows 11 / Ubuntu 22.04
- 编译器: MSVC 2022 / GCC 11
- 构建类型: Release

## 测试结果
- 回归测试: ✅ 通过
- 性能测试: ✅ 通过
- 集成测试: ✅ 通过

## 性能对比
| 指标 | v0.(x-1).(x-1) | v0.x.x | 变化 |
|------|---------------|---------|------|
| 词法分析吞吐量 | 500 tokens/ms | 575 tokens/ms | +15% |
| Arena 分配速度 | 2 μs | 1 μs | +50% |

## 发现的问题
无

## 结论
所有回归测试通过，可发布 v0.x.x 版本。
EOF
```

---

## 6. 测试结果记录格式

### 6.1 单次测试执行记录

每次执行测试后，使用以下格式记录：

```markdown
## 测试执行记录 - [日期]

### 基本信息
- **执行人**: [姓名/CI]
- **执行时间**: 2026-01-24 15:30:00
- **分支**: main / feature/xxx
- **Commit**: abc123def456
- **执行场景**: 本地开发 / PR 构建 / 夜间构建 / 版本发布前

### 执行命令
```bash
cd build
ctest -L regression -V
```

### 测试结果
- **总测试数**: 10
- **通过**: 10
- **失败**: 0
- **跳过**: 0
- **耗时**: 1.23 秒

### 详细结果
```
Start 39: regression_test               ✓ Passed (0.01 sec)
Start 40: arena_stress_test             ✓ Passed (0.02 sec)
Start 41: lexer_performance_test        ✓ Passed (0.01 sec)
...
```

### 问题与备注
无问题，所有测试通过。
```

### 6.2 性能基准记录

每次更新性能基准时，使用以下格式记录：

```markdown
## 性能基准更新 - [日期]

### 变更信息
- **Commit**: abc123def456
- **原因**: 优化了 Arena 块分配策略

### 基准变化

#### Arena 分配器性能
| 指标 | 旧基准 | 新基准 | 变化 |
|------|--------|--------|------|
| 分配速度 | < 2 μs/次 | < 1 μs/次 | +50% |
| Reset 耗时 | < 10 μs/次 | < 10 μs/次 | 不变 |

#### 词法分析器性能
| 指标 | 旧基准 | 新基准 | 变化 |
|------|--------|--------|------|
| 吞吐量 | ≥ 500 tokens/ms | ≥ 575 tokens/ms | +15% |

### 验证结果
运行 10 次取中位数，性能提升稳定复现。

### 文档更新
- [x] 更新 `性能回归测试场景清单.md`
- [x] 更新测试文件中的基准常量
```

### 6.3 历史问题记录

每次修复 bug 并添加回归测试时，使用以下格式记录：

```markdown
## 历史问题回归测试 - Bug #NNN

### 问题描述
UTF-8 中文标识符长度计算错误，导致解析器崩溃。

### 复现步骤
1. 创建包含中文标识符的源文件：`变量 中文变量 = 100;`
2. 运行词法分析器
3. 观察崩溃

### 修复内容
- **Commit**: abc123def456
- **修复文件**: `src/frontend/lexer/lexer.c`
- **修复说明**: 使用 UTF-8 字节长度而非字符长度计算偏移量

### 回归测试
- **测试文件**: `tests/unit/regression_test.c`
- **测试函数**: `test_utf8_handling_regression()`
- **验证内容**: 中文标识符能正确解析，长度计算准确

### 记录更新
- [x] 添加到 `长期回归测试集规范.md` 历史问题清单
- [x] 问题编号: #001
```

---

## 7. 测试失败分析模板

当测试失败时，使用以下模板进行分析：

```markdown
## 测试失败分析 - [测试名称]

### 失败信息
- **测试名称**: lexer_performance_test
- **失败时间**: 2026-01-24 16:00:00
- **执行环境**: Windows 11 / MSVC 2022 / Release
- **失败输出**:
```
Expected: >= 500 tokens/ms
Actual: 320 tokens/ms
Test failed at line 45
```

### 原因分析
1. **初步判断**: 性能劣化 36%
2. **可能原因**:
   - 最近修改了 `next_token()` 实现，增加了额外检查
   - 编译器优化选项错误（确认为 Release 构建）
   - 测试环境异常（CPU 降频、后台任务占用）

3. **定位步骤**:
   - 使用 profiler 分析热点：`gprof` / `perf` / Visual Studio Profiler
   - 对比变更前后的汇编代码
   - 回退最近 commit 验证

### 解决方案
- **方案 A**: 优化 `next_token()` 中的新增检查逻辑
- **方案 B**: 若检查必需且性能影响无法避免，评估是否调整基准值（需评审）

### 修复验证
- [ ] 修复后重新运行测试
- [ ] 确认性能恢复到预期水平
- [ ] 提交 PR 并在描述中说明

### 后续跟踪
若问题难以定位，创建专项 Issue 并分配给性能优化负责人。
```

---

## 8. 附录：常用命令速查

### 8.1 测试执行命令

```bash
# 运行所有回归测试
ctest -L regression -V

# 运行所有性能测试
ctest -L performance -V

# 运行所有阶段 7 测试
ctest -L stage7 -V

# 运行所有内存测试
ctest -L memory -V

# 运行单个测试
ctest -R regression_test -V

# 运行匹配模式的测试
ctest -R "lexer|parser" -V

# 运行测试并只显示失败输出
ctest -L regression --output-on-failure
```

### 8.2 测试结果查询

```bash
# 查看最后一次测试日志
cat build/Testing/Temporary/LastTest.log

# 查看特定测试输出
# 输出位置：build/Testing/Temporary/LastTestsFailed.log（仅失败测试）

# 统计测试数量
ctest -N  # 显示测试列表但不执行
ctest -N -L regression  # 统计回归测试数量
```

### 8.3 测试标签管理

```bash
# 查看测试及其标签
ctest --print-labels

# 运行标签交集（AND）
ctest -L "regression;performance" -V

# 运行标签并集（OR）
ctest -L "regression|performance" -V
```

---

**本指南随项目演进持续更新**，新增测试执行场景、报告模板、命令速查等信息均应补充到本文档。
