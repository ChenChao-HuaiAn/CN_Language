# CN_Language 多平台构建与运行验证指南

## 概述

本文档描述如何在不同平台上构建和验证 CN_Language 编译器及工具链的完整功能。

## 支持的平台

CN_Language 编译器支持以下平台组合：

### 主要目标平台

| 平台 | 架构 | 编译器 | 目标三元组 | 状态 |
|------|------|--------|------------|------|
| Windows | x86_64 | MSVC/GCC/Clang | x86_64-pc-windows-msvc | ✅ 已验证 |
| Linux | x86_64 | GCC/Clang | x86_64-pc-linux-sysv | ✅ 已验证 |
| Linux | aarch64 | GCC/Clang | aarch64-unknown-linux-gnueabi | ✅ 已验证 |
| Freestanding | x86_64 | GCC/Clang | x86_64-pc-none-elf | ✅ 已验证 |

### 平台特性

- **Windows**: 使用 MSVC、MinGW-GCC 或 Clang 编译，支持完整的标准库和运行时
- **Linux**: 使用 GCC 或 Clang 编译，支持完整的标准库和运行时
- **Freestanding**: 无操作系统环境，适用于操作系统内核和裸机开发

## 快速开始

### Windows 平台验证

#### 前置要求
- Windows 10/11
- CMake 3.15+
- MSVC (Visual Studio 2019+) 或 MinGW-GCC 或 Clang
- PowerShell 7+

#### 执行验证
```powershell
# 完整验证（包括清理重新构建）
.\tools\multiplatform_test.ps1 -CleanBuild

# 增量验证（使用现有构建）
.\tools\multiplatform_test.ps1

# 指定构建目录
.\tools\multiplatform_test.ps1 -BuildDir "custom_build" -ReportDir "custom_reports"
```

### Linux 平台验证

#### 前置要求
- Linux (Ubuntu 20.04+, Debian, Fedora, Arch等)
- CMake 3.15+
- GCC 9+ 或 Clang 10+
- Bash shell

#### 安装依赖

**Ubuntu/Debian**:
```bash
sudo apt-get update
sudo apt-get install build-essential cmake
```

**Fedora/RHEL**:
```bash
sudo dnf install gcc gcc-c++ cmake make
```

**Arch Linux**:
```bash
sudo pacman -S base-devel cmake
```

#### 执行验证
```bash
# 赋予执行权限
chmod +x tools/multiplatform_test.sh

# 完整验证（包括清理重新构建）
./tools/multiplatform_test.sh build_multiplatform test_reports true

# 增量验证（使用现有构建）
./tools/multiplatform_test.sh

# 指定构建目录
./tools/multiplatform_test.sh custom_build custom_reports false
```

### Docker 环境验证

使用 Docker 可以在任意平台上测试 Linux 环境：

```bash
# 构建 Docker 镜像
docker-compose build

# 启动容器并进入
docker-compose run cn-lang-dev

# 在容器内执行验证
./tools/multiplatform_test.sh
```

## 验证流程

多平台验证脚本执行以下步骤：

### 1. 依赖检查
验证必要的工具是否已安装：
- CMake
- C 编译器 (MSVC/GCC/Clang)
- Make (Linux)

### 2. CMake 配置
```bash
cmake -B build -DCMAKE_BUILD_TYPE=Release
```

### 3. 编译构建
```bash
cmake --build build --config Release
```

### 4. 核心测试套件
运行所有单元测试和集成测试：
```bash
ctest -R "unit" --output-on-failure
ctest -R "integration" --output-on-failure
```

### 5. 核心功能验证
测试编译器的关键功能：
- 编译 `hello_world.cn`
- 编译 `array_examples.cn`
- 编译 `function_examples.cn`
- Freestanding 模式编译

### 6. 生成验证报告
自动生成包含详细信息的验证报告，保存在 `test_reports/` 目录。

## 验证报告

验证完成后，会生成详细的报告文件：

### Windows 报告
- 路径: `test_reports/multiplatform_windows_YYYYMMDD_HHMMSS.txt`
- 内容: CMake配置输出、构建日志、测试结果、功能验证结果

### Linux 报告
- 路径: `test_reports/multiplatform_linux_YYYYMMDD_HHMMSS.txt`
- 内容: CMake配置输出、构建日志、测试结果、功能验证结果

### 报告示例
```
===== CN_Language 多平台构建与运行验证报告 =====
平台: Windows
架构: x64
编译器: MSVC
开始时间: 2026-01-24 18:25:47
结束时间: 2026-01-24 18:27:15
总耗时: 88 秒

--- CMake 配置 ---
结果: 成功
...

--- 构建结果 ---
结果: 成功
...

--- 单元测试结果 ---
结果: 通过 (45 项)
...

--- 集成测试结果 ---
结果: 通过 (18 项)
...

--- 核心功能验证 ---
通过: 4 / 4
失败: 0 / 4

===============================================
```

## 集成测试

### 多平台功能验证测试

专门的集成测试验证多平台支持：

```bash
# 运行多平台集成测试
cd build
ctest -C Debug -R integration_multiplatform_test -VV
```

测试内容：
1. **平台检测与目标三元组解析**: 验证各平台三元组的解析正确性
2. **目标三元组往返转换**: 验证三元组字符串的序列化/反序列化

测试覆盖的目标三元组：
- `x86_64-pc-windows-msvc`
- `x86_64-pc-linux-sysv`
- `aarch64-unknown-linux-gnueabi`
- `x86_64-pc-none-elf`

## 目标三元组

CN_Language 使用目标三元组（Target Triple）来指定编译目标平台：

### 格式
```
<arch>-<vendor>-<os>-<abi>
```

### 组成部分

**架构 (arch)**:
- `x86_64`: 64位 x86 架构
- `aarch64`: 64位 ARM 架构

**厂商 (vendor)**:
- `pc`: 标准 PC
- `unknown`: 未知/通用厂商

**操作系统 (os)**:
- `windows`: Windows 操作系统
- `linux`: Linux 操作系统
- `none`: 无操作系统 (freestanding)

**ABI**:
- `msvc`: Microsoft Visual C++ ABI
- `sysv`: System V ABI (Linux标准)
- `gnueabi`: GNU EABI (ARM嵌入式)
- `elf`: ELF 格式 (裸机/内核)

### 使用示例

```bash
# 编译为 Windows 可执行文件
cnc --target=x86_64-pc-windows-msvc program.cn -o program.c

# 编译为 Linux 可执行文件
cnc --target=x86_64-pc-linux-sysv program.cn -o program.c

# 编译为 ARM Linux 可执行文件
cnc --target=aarch64-unknown-linux-gnueabi program.cn -o program.c

# 编译为 Freestanding（内核/裸机）
cnc --target=x86_64-pc-none-elf --freestanding kernel.cn -o kernel.c
```

## 常见问题

### Q1: Windows 上找不到编译器

**问题**: 验证脚本报告 "未找到 C 编译器"

**解决方案**:
- 安装 Visual Studio 2019+ (包含 C++ 工具)
- 或安装 MinGW-GCC: `winget install -e --id MSYS2.MSYS2`
- 或安装 Clang: `winget install -e --id LLVM.LLVM`

### Q2: Linux 上编译失败

**问题**: `fatal error: stddef.h: No such file or directory`

**解决方案**:
```bash
# Ubuntu/Debian
sudo apt-get install build-essential

# Fedora/RHEL
sudo dnf install gcc-c++ glibc-devel
```

### Q3: CMake 版本过旧

**问题**: "CMake 3.15 or higher is required"

**解决方案**:
```bash
# Ubuntu/Debian (使用 Kitware APT Repository)
sudo apt-get install ca-certificates gpg wget
wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc | sudo gpg --dearmor -o /usr/share/keyrings/kitware-archive-keyring.gpg
echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ focal main' | sudo tee /etc/apt/sources.list.d/kitware.list
sudo apt-get update
sudo apt-get install cmake

# 或从源码构建: https://cmake.org/download/
```

### Q4: 测试失败

**问题**: 某些测试用例失败

**解决方案**:
1. 查看详细的测试输出:
   ```bash
   ctest --output-on-failure
   ```
2. 查看验证报告: `test_reports/multiplatform_*.txt`
3. 重新构建并测试:
   ```bash
   # Windows
   .\tools\multiplatform_test.ps1 -CleanBuild
   
   # Linux
   ./tools/multiplatform_test.sh build test_reports true
   ```

## 手动构建与测试

如果自动化脚本遇到问题，可以手动执行以下步骤：

### Windows (使用 Visual Studio)

```powershell
# 1. 配置
cmake -B build -G "Visual Studio 17 2022"

# 2. 构建
cmake --build build --config Release

# 3. 测试
cd build
ctest -C Release --output-on-failure
```

### Windows (使用 MinGW)

```powershell
# 1. 配置
cmake -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release

# 2. 构建
cmake --build build

# 3. 测试
cd build
ctest --output-on-failure
```

### Linux

```bash
# 1. 配置
cmake -B build -DCMAKE_BUILD_TYPE=Release

# 2. 构建
cmake --build build -j$(nproc)

# 3. 测试
cd build
ctest --output-on-failure
```

## 持续集成

多平台验证脚本可以集成到 CI/CD 流程中：

### GitHub Actions 示例

```yaml
name: Multi-Platform Build

on: [push, pull_request]

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run Multi-Platform Test
        run: .\tools\multiplatform_test.ps1 -CleanBuild

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Dependencies
        run: sudo apt-get install build-essential cmake
      - name: Run Multi-Platform Test
        run: chmod +x tools/multiplatform_test.sh && ./tools/multiplatform_test.sh
```

## 性能基准

以下是不同平台上的典型构建与测试时间（参考值）：

| 平台 | CPU | 内存 | 构建时间 | 测试时间 | 总时间 |
|------|-----|------|----------|----------|--------|
| Windows 11 (MSVC) | i7-11700 | 16GB | ~60s | ~30s | ~90s |
| Windows 11 (MinGW) | i7-11700 | 16GB | ~70s | ~30s | ~100s |
| Ubuntu 22.04 (GCC) | i7-11700 | 16GB | ~45s | ~25s | ~70s |
| Ubuntu 22.04 (Clang) | i7-11700 | 16GB | ~50s | ~25s | ~75s |

## 相关文档

- [CN_Language 开发计划](../design/CN_Language 开发计划.md)
- [CN_Language 编译器架构设计](../design/CN_Language 编译器 工具链架构设计.md)
- [CN_Language C 代码风格规范](../specifications/CN_Language C 代码风格规范.md)
- [CN_Language 测试规范](../specifications/CN_Language 测试规范.md)
- [运行时绑定规范](../specifications/CN_Language 运行时绑定规范.md)

## 贡献

如果您在新平台上成功构建和测试了 CN_Language，欢迎：

1. 更新本文档，添加该平台的信息
2. 提交 Pull Request，包含必要的平台适配代码
3. 在 Issues 中报告平台特定的问题

## 许可

本文档遵循 MIT 许可证。
