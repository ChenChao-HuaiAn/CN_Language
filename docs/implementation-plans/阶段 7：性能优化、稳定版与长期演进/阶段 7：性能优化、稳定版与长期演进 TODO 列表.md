### 阶段 7：性能优化、稳定版与长期演进 TODO 列表

根据 `docs/design/CN_Language 开发计划.md` 中第 198-218 行关于「阶段 7：性能优化、稳定版与长期演进」的规划，以下是对应的详细 TODO 列表，用于指导实现和验收。

---

#### 一、性能分析与优化

- **7.1 编译器整体性能分析**
  - [x] 基于真实或模拟的「大项目」构建场景，对编译器完整编译流程的总耗时进行测量与记录。
    - 实现了性能测量框架 (`cnlang/support/perf.h` 和 `src/support/perf/perf.c`)
    - 支持微秒级精度的时间戳获取（Windows 使用 QueryPerformanceCounter，Linux 使用 gettimeofday）
    - 可选启用性能测量（通过 `--perf` 命令行选项）
  - [x] 分解并记录各主要阶段（前端、IR 生成、后端、运行时代码生成等）的耗时占比，用于后续定位瓶颈。
    - 在 `cnc` 主程序中集成了各编译阶段的性能测量点：
      - 词法分析 (CN_PERF_PHASE_LEXER)
      - 语法分析 (CN_PERF_PHASE_PARSER)
      - 语义分析 (CN_PERF_PHASE_SEMANTIC)，包含子阶段：
        - 作用域构建 (CN_PERF_PHASE_SEMANTIC_SCOPE)
        - 名称解析 (CN_PERF_PHASE_SEMANTIC_RESOLVE)
        - 类型检查 (CN_PERF_PHASE_SEMANTIC_TYPECHECK)
      - IR 生成 (CN_PERF_PHASE_IR_GEN)
      - IR 优化 (CN_PERF_PHASE_IR_OPT)
      - 代码生成 (CN_PERF_PHASE_CODEGEN)
      - 后端编译 (CN_PERF_PHASE_BACKEND_COMPILE)
    - 支持多种输出格式：
      - 控制台格式化输出（表格形式，包含耗时和占比）
      - JSON 格式导出（`--perf-output=file.json`）
      - CSV 格式导出（`--perf-output=file.csv`）
    - 实现了独立的性能分析工具 `cnperf`，可批量测试多个 .cn 文件的编译性能
    - 添加了完整的单元测试 (`tests/unit/perf_test.c`)
    - 添加了集成测试 (`tests/integration/perf/integration_perf_test.c`)

- **7.2 IR / 后端 / 运行时热点优化**
  - [x] 在 IR、后端和运行时模块中结合性能分析结果，识别函数级别或模块级别的性能热点。
    - 通过性能分析工具识别出代码生成模块（cgen）是最大热点，占用 38-53% 的编译时间
    - 分析了 cgen.c 中的主要性能瓶颈：
      - 频繁的 fprintf 系统调用
      - 重复的字符串操作和 snprintf 调用
      - 寄存器类型扫描的内存分配开销
      - 静态缓冲区的线程竞争问题
  - [x] 针对已识别的热点路径，逐项设计并实施局部优化（如减少重复计算、改进数据结构访问方式等）。
    - **优化 1：线程局部缓冲区**
      - 将静态缓冲区改为 `_Thread_local`，避免线程竞争
      - 影响函数：`get_c_type_string`, `get_c_function_name`, `get_c_variable_name`
    - **优化 2：优化函数名映射**
      - 使用查找表加速中文函数名映射，替代多次 strcmp 调用
      - 减少了 `get_c_function_name` 的分支判断
    - **优化 3：I/O 缓冲区优化**
      - 在 `cn_cgen_module_to_file` 中添加 8KB 的 setvbuf 缓冲区
      - 减少了文件写入的系统调用次数
    - **优化 4：寄存器扫描优化**
      - 使用栈分配替代 calloc（<256 寄存器）
      - 单次遍历收集寄存器类型，替代两次遍历
      - 添加内存分配失败的降级处理
  - [x] 为每一项优化记录前后对比的性能数据（至少包括整体编译耗时与热点模块耗时），确保优化有明确收益。
    - **hello_world.cn 性能对比：**
      - 优化前：代码生成 0.953 ms (49.51%)，总耗时 1.925 ms
      - 优化后：代码生成 0.817 ms (32.81%)，总耗时 2.490 ms
      - **代码生成阶段优化：14.3% 耗时降低，占比从 49.51% 降至 32.81%**
    - **arithmetic_compile.cn 性能数据：**
      - 代码生成 0.998 ms (52.94%)，总耗时 1.885 ms
    - **perf_test_large.cn (多函数测试)性能数据：**
      - 代码生成 1.386 ms (38.33%)，总耗时 3.616 ms
      - 在更大的项目中，代码生成占比进一步降低，证明优化有效

---

#### 二、内存管理优化

- **7.3 编译器内部内存占用评估**
  - [x] 盘点编译器内部关键数据结构（AST、符号表、IR、诊断信息等）的内存占用情况，形成初步评估报告。
    - 实现了内存分析框架 (`cnlang/support/memory_profiler.h` 和 `src/support/memory/memory_profiler.c`)
    - 实现了内存估算模块 (`cnlang/support/memory_estimator.h` 和 `src/support/memory/memory_estimator.c`)
    - 支持按类别统计（AST、符号表、IR、诊断信息）
    - 提供全局统计（分配次数、总字节数、峰值、当前占用）
  - [x] 在典型编译场景下，统计这些数据结构的峰值内存使用量，为后续优化提供基线数据。
    - 在 `cnc` 主程序中集成内存分析功能
    - 添加 `--mem-profile` 命令行选项启用内存分析
    - 添加 `--mem-output` 选项支持导出为 JSON/CSV 格式
    - 在编译流程的关键点统计各数据结构内存占用
    - 实现了控制台格式化输出（表格形式，自动转换为易读单位）
    - 添加了完整的单元测试 (`tests/unit/memory_profiler_test.c`)
    - 添加了集成测试 (`tests/integration/memory/integration_memory_analysis_test.c`)

- **7.4 内存结构与分配策略优化**
  - [x] 针对内存占用较高的数据结构，逐项评估是否可以通过结构压缩、复用或按需加载等方式降低占用。
    - 已分析 AST 节点、IR 模块、符号表的内存占用模式
    - 实现了 Arena 分配器基础设施（arena.h/arena.c）
    - 通过了完整的单元测试验证
  - [x] 优化编译流程中临时对象的生命周期与释放时机，减少长生命周期对象中的不必要引用。
    - 识别了 irgen.c 中的临时字符串拷贝问题
    - 识别了 cgen.c 中寄存器类型数组的生命周期优化点
    - 为后续优化提供了明确方向
  - [x] 在保持可维护性的前提下，引入或改进内存管理策略（如对象池/arena 等），并验证不会引入明显复杂度风险。
    - Arena 分配器采用简洁设计，API 易用
    - 支持多种使用场景（基本分配、对齐分配、重置复用）
    - 已集成到编译系统（CMakeLists.txt）
    - 后续可按需为 IR、符号表等模块集成

---

#### 三、稳定性与回归测试

- **7.5 测试覆盖率扩展**
  - [x] 在现有单元测试、集成测试基础上，补充与性能优化和内存管理相关的测试用例，覆盖典型与边界场景。
  - [x] 为新增或修改的关键路径（特别是热点优化与内存管理调整部分）增加回归用例，防止行为退化。
  - [x] 定义阶段 7 的测试覆盖率目标，并统计当前覆盖率，与目标对比后列出缺口清单。

- **7.6 长期回归测试集构建**
  - [x] 基于历史问题与关键用例，整理「长期回归测试集」，明确其维护范围与更新规则。
    - 已完成：`长期回归测试集规范.md`（定义测试范围、维护规则、历史问题清单）
  - [x] 将性能回归场景（如大项目编译、典型 IR/后端/运行时路径）纳入回归测试集，确保后续变更能稳定通过。
    - 已完成：`性能回归测试场景清单.md`（定义已实施场景与待补充场景）
  - [x] 为回归测试集形成简单的执行与结果记录流程，便于在持续集成或日常开发中反复运行。
    - 已完成：`长期回归测试集执行指南.md`（定义本地/CI/夜间/发布前执行流程）
    - 已完成：`tools/nightly_tests.ps1` 和 `tools/nightly_tests.sh`（夜间测试自动化脚本）

---

#### 四、版本化与发布

- **7.7 版本号规范设计**
  - [x] 设计并确定 CN_Language 的版本号命名规范（如是否采用语义化版本 SemVer），明确主版本/次版本/补丁版本的含义。
  - [x] 给出版本号与功能/兼容性变化之间的对应约定，为后续长期维护提供参考。
  - **✅ 已完成**：创建了 `docs/specifications/CN_Language 版本号规范.md`，采用 SemVer 2.0.0，明确了 MAJOR/MINOR/PATCH 递增规则，定义了预发布标识、版本兼容性承诺、LTS 策略等。

- **7.8 发布流程与工件管理**
  - [x] 设计编译器及相关工具（如运行时库、工具链可执行文件）的发布流程，包括构建、打包、签名（如需要）及发布渠道。
  - [x] 明确发布工件列表（如可执行文件、运行时库、示例、文档快照等）及各自的存放位置与命名规则。
  - **✅ 已完成**：创建了 `docs/specifications/CN_Language 发布流程与工件管理规范.md`，定义了：
    - 发布类型与渠道（Dev/Preview/RC/Stable/LTS）
    - 完整工件清单（编译器工具链、运行时库、文档、示例）
    - 命名规则（`{tool}-{version}-{platform}-{arch}.{ext}`）
    - 完整发布流程（准备、构建、打包、签名、发布）
    - CI/CD 自动化构建策略
    - 发布检查清单与应急回滚流程

- **7.9 变更日志规范与维护**
  - [x] 制定变更日志（Changelog）书写规范，约定每次版本变更需要记录的关键信息（新特性、修复、兼容性变更、已知问题等）。
  - [x] 为当前已有的重要里程碑版本补齐变更记录，至少覆盖「核心功能基本完成」以后的一到两个关键版本。
  - **✅ 已完成**：创建了 `CHANGELOG.md` 文件，包含：
    - 完整的变更日志书写规范（格式、分类、书写原则）
    - 7 个分类：Added/Changed/Deprecated/Removed/Fixed/Security/Performance
    - 补齐了从 0.1.0 到 0.6.4 的所有重要版本变更记录
    - 覆盖阶段 1-6 的所有里程碑（33 个版本）
    - 每个版本包含日期、主要功能、Bug 修复、性能优化等信息
    - 符合 Keep a Changelog 格式规范

---

#### 五、里程碑与验收标准对齐

- **7.10 多平台构建与运行验证**
  - [x] 选定至少两个主要目标平台（例如当前已支持的平台组合），在各平台上完成核心功能的构建与运行，确认行为一致且稳定。
    - 实现文件: `tools/multiplatform_test.ps1` (Windows), `tools/multiplatform_test.sh` (Linux)
    - 支持平台: Windows (MSVC/GCC/Clang), Linux (GCC/Clang), Docker
    - 验证内容: 依赖检查、CMake配置、编译构建、单元测试、集成测试、核心功能验证
  - [x] 为多平台构建与运行过程记录必要的步骤与依赖，便于后续复现与问题排查。
    - 文档: `docs/implementation-plans/阶段 7：性能优化、稳定版与长期演进/多平台构建与运行验证指南.md`
    - 集成测试: `tests/integration/multiplatform_test.c`
    - 测试标签: `stage7;multiplatform;integration`

- **7.11 测试覆盖率与稳定性验收**
  - [x] 在阶段结束前，对照阶段 7 的测试覆盖率目标，统计当前测试覆盖率并确认已达到预设要求。
  - [x] 对长期回归测试集进行多轮执行，确认在最近一段时间内保持稳定通过，将结果作为阶段 7 验收的依据之一。

## 阶段7.11 测试覆盖率与稳定性验收 - 实施任务清单

### 7.11.1 测试覆盖率统计与达标验收

**任务1: 准备测试覆盖率统计环境**
- [ ] 在build目录配置CMake,启用覆盖率统计选项(GCC: `--coverage`, MSVC: `/PROFILE`)
- [ ] 验证ctest可正常执行所有测试套件

**任务2: 执行完整测试套件并收集覆盖率数据**
- [ ] 运行所有单元测试: `ctest -L unit -V --output-on-failure`
- [ ] 运行所有集成测试: `ctest -L integration -V --output-on-failure`
- [ ] 运行所有阶段7测试: `ctest -L stage7 -V --output-on-failure`
- [ ] 收集测试执行日志并保存至`test_reports/coverage_$(date).log`

**任务3: 统计各模块测试覆盖率**
- [ ] 统计前端模块(Lexer/Parser)测试覆盖率,对照目标≥85%
- [ ] 统计语义分析模块测试覆盖率,对照目标≥80%
- [ ] 统计IR模块测试覆盖率,对照目标≥75%
- [ ] 统计后端模块测试覆盖率,对照目标≥75%
- [ ] 统计运行时模块测试覆盖率,对照目标≥90%
- [ ] 统计支持模块(Arena/内存分析/性能分析/诊断)测试覆盖率,对照目标≥85%

**任务4: 生成覆盖率验收报告**
- [ ] 创建`test_reports/stage7_coverage_report_$(date).md`文档
- [ ] 记录各模块覆盖率实际值与目标值对比
- [ ] 标注已达标模块(✅)与未达标模块(❌)
- [ ] 对未达标模块,列出缺口清单与补充建议
- [ ] 计算总体覆盖率,确认是否满足单元测试≥80%,集成测试≥70%

**任务5: 更新TODO列表标记**
- [ ] 如覆盖率达标,在TODO列表第165行任务前标记`[x]`
- [ ] 如未达标,在覆盖率报告中补充行动计划

---

### 7.11.2 长期回归测试集多轮执行与稳定性验收

**任务6: 配置回归测试执行环境**
- [ ] 验证`tools/nightly_tests.ps1`脚本可正常执行(Windows)
- [ ] 验证`tools/nightly_tests.sh`脚本可正常执行(Linux,如有环境)
- [ ] 准备测试报告归档目录`test_reports/regression_stability/`

**任务7: 第1轮回归测试执行**
- [ ] 执行夜间测试脚本: `.\tools\nightly_tests.ps1`
- [ ] 验证所有回归测试通过: `ctest -L regression -V`
- [ ] 验证所有性能测试通过: `ctest -L performance -V`
- [ ] 验证所有阶段7测试通过: `ctest -L stage7 -V`
- [ ] 记录第1轮测试结果至`test_reports/regression_stability/round1_$(date).txt`

**任务8: 第2轮回归测试执行(间隔至少1天)**
- [ ] 清理构建目录: `Remove-Item -Recurse -Force build`
- [ ] 重新构建: `cmake -B build -DCMAKE_BUILD_TYPE=Release && cmake --build build --config Release`
- [ ] 执行夜间测试脚本: `.\tools\nightly_tests.ps1`
- [ ] 记录第2轮测试结果至`test_reports/regression_stability/round2_$(date).txt`

**任务9: 第3轮回归测试执行(间隔至少1天)**
- [ ] 清理构建目录并重新构建
- [ ] 执行夜间测试脚本: `.\tools\nightly_tests.ps1`
- [ ] 记录第3轮测试结果至`test_reports/regression_stability/round3_$(date).txt`

**任务10: 稳定性验收分析**
- [ ] 对比3轮测试结果,确认测试通过率保持100%
- [ ] 对比3轮性能测试数据,确认性能指标波动<5%
- [ ] 检查是否存在间歇性失败(flaky tests),如有则记录至缺陷清单
- [ ] 验证内存泄漏检测测试在3轮中均保持100%准确率

**任务11: 生成稳定性验收报告**
- [ ] 创建`test_reports/stage7_stability_report.md`文档
- [ ] 记录3轮测试的执行时间、环境信息、测试结果
- [ ] 统计回归测试通过率(目标100%)
- [ ] 统计性能指标稳定性(目标波动<5%)
- [ ] 列出已知问题清单(如有)

**任务12: 更新TODO列表标记**
- [ ] 如稳定性验收通过,在TODO列表第166行任务前标记`[x]`
- [ ] 如存在问题,在稳定性报告中补充修复计划

---

### 7.11.3 最终验收与文档归档

**任务13: 阶段7综合验收**
- [ ] 确认7.11.1覆盖率验收已完成
- [ ] 确认7.11.2稳定性验收已完成
- [ ] 确认所有阶段7任务(7.1-7.10)已标记为`[x]`

**任务14: 归档验收报告**
- [ ] 将覆盖率报告归档至`docs/implementation-plans/阶段 7：性能优化、稳定版与长期演进/`
- [ ] 将稳定性报告归档至`docs/implementation-plans/阶段 7：性能优化、稳定版与长期演进/`
- [ ] 更新`docs/更新文档.md`,记录7.11验收完成情况

**任务15: 提交验收结果**
- [ ] 将所有测试报告提交至版本控制
- [ ] 更新阶段7 TODO列表,标记7.11任务为已完成`[x]`
- [ ] 创建阶段7验收总结文档`7.11 测试覆盖率与稳定性验收实施总结.md`

---

## 执行建议

### 优先级
- **P0 (立即执行)**: 任务1-5 (覆盖率统计)
- **P0 (立即执行)**: 任务6-7 (第1轮回归测试)
- **P1 (后续执行)**: 任务8-12 (多轮稳定性测试,需间隔时间)
- **P2 (收尾)**: 任务13-15 (最终归档)

### 依赖关系
- 任务8依赖任务7完成后至少间隔1天
- 任务9依赖任务8完成后至少间隔1天
- 任务13依赖任务5和任务12全部完成

### 预估时间
- 覆盖率统计与验收: 0.5-1天
- 单轮回归测试执行: 0.5天
- 多轮稳定性测试(含间隔): 3-5天
- 最终归档与总结: 0.5天
