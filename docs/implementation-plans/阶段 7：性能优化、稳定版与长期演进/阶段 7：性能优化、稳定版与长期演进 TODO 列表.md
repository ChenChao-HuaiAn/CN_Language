### 阶段 7：性能优化、稳定版与长期演进 TODO 列表

根据 `docs/design/CN_Language 开发计划.md` 中第 198-218 行关于「阶段 7：性能优化、稳定版与长期演进」的规划，以下是对应的详细 TODO 列表，用于指导实现和验收。

---

#### 一、性能分析与优化

- **7.1 编译器整体性能分析**
  - [x] 基于真实或模拟的「大项目」构建场景，对编译器完整编译流程的总耗时进行测量与记录。
    - 实现了性能测量框架 (`cnlang/support/perf.h` 和 `src/support/perf/perf.c`)
    - 支持微秒级精度的时间戳获取（Windows 使用 QueryPerformanceCounter，Linux 使用 gettimeofday）
    - 可选启用性能测量（通过 `--perf` 命令行选项）
  - [x] 分解并记录各主要阶段（前端、IR 生成、后端、运行时代码生成等）的耗时占比，用于后续定位瓶颈。
    - 在 `cnc` 主程序中集成了各编译阶段的性能测量点：
      - 词法分析 (CN_PERF_PHASE_LEXER)
      - 语法分析 (CN_PERF_PHASE_PARSER)
      - 语义分析 (CN_PERF_PHASE_SEMANTIC)，包含子阶段：
        - 作用域构建 (CN_PERF_PHASE_SEMANTIC_SCOPE)
        - 名称解析 (CN_PERF_PHASE_SEMANTIC_RESOLVE)
        - 类型检查 (CN_PERF_PHASE_SEMANTIC_TYPECHECK)
      - IR 生成 (CN_PERF_PHASE_IR_GEN)
      - IR 优化 (CN_PERF_PHASE_IR_OPT)
      - 代码生成 (CN_PERF_PHASE_CODEGEN)
      - 后端编译 (CN_PERF_PHASE_BACKEND_COMPILE)
    - 支持多种输出格式：
      - 控制台格式化输出（表格形式，包含耗时和占比）
      - JSON 格式导出（`--perf-output=file.json`）
      - CSV 格式导出（`--perf-output=file.csv`）
    - 实现了独立的性能分析工具 `cnperf`，可批量测试多个 .cn 文件的编译性能
    - 添加了完整的单元测试 (`tests/unit/perf_test.c`)
    - 添加了集成测试 (`tests/integration/perf/integration_perf_test.c`)

- **7.2 IR / 后端 / 运行时热点优化**
  - [ ] 在 IR、后端和运行时模块中结合性能分析结果，识别函数级别或模块级别的性能热点。
  - [ ] 针对已识别的热点路径，逐项设计并实施局部优化（如减少重复计算、改进数据结构访问方式等）。
  - [ ] 为每一项优化记录前后对比的性能数据（至少包括整体编译耗时与热点模块耗时），确保优化有明确收益。

---

#### 二、内存管理优化

- **7.3 编译器内部内存占用评估**
  - [ ] 盘点编译器内部关键数据结构（AST、符号表、IR、诊断信息等）的内存占用情况，形成初步评估报告。
  - [ ] 在典型编译场景下，统计这些数据结构的峰值内存使用量，为后续优化提供基线数据。

- **7.4 内存结构与分配策略优化**
  - [ ] 针对内存占用较高的数据结构，逐项评估是否可以通过结构压缩、复用或按需加载等方式降低占用。
  - [ ] 优化编译流程中临时对象的生命周期与释放时机，减少长生命周期对象中的不必要引用。
  - [ ] 在保持可维护性的前提下，引入或改进内存管理策略（如对象池/arena 等），并验证不会引入明显复杂度风险。

---

#### 三、稳定性与回归测试

- **7.5 测试覆盖率扩展**
  - [ ] 在现有单元测试、集成测试基础上，补充与性能优化和内存管理相关的测试用例，覆盖典型与边界场景。
  - [ ] 为新增或修改的关键路径（特别是热点优化与内存管理调整部分）增加回归用例，防止行为退化。
  - [ ] 定义阶段 7 的测试覆盖率目标，并统计当前覆盖率，与目标对比后列出缺口清单。

- **7.6 长期回归测试集构建**
  - [ ] 基于历史问题与关键用例，整理「长期回归测试集」，明确其维护范围与更新规则。
  - [ ] 将性能回归场景（如大项目编译、典型 IR/后端/运行时路径）纳入回归测试集，确保后续变更能稳定通过。
  - [ ] 为回归测试集形成简单的执行与结果记录流程，便于在持续集成或日常开发中反复运行。

---

#### 四、版本化与发布

- **7.7 版本号规范设计**
  - [ ] 设计并确定 CN_Language 的版本号命名规范（如是否采用语义化版本 SemVer），明确主版本/次版本/补丁版本的含义。
  - [ ] 给出版本号与功能/兼容性变化之间的对应约定，为后续长期维护提供参考。

- **7.8 发布流程与工件管理**
  - [ ] 设计编译器及相关工具（如运行时库、工具链可执行文件）的发布流程，包括构建、打包、签名（如需要）及发布渠道。
  - [ ] 明确发布工件列表（如可执行文件、运行时库、示例、文档快照等）及各自的存放位置与命名规则。

- **7.9 变更日志规范与维护**
  - [ ] 制定变更日志（Changelog）书写规范，约定每次版本变更需要记录的关键信息（新特性、修复、兼容性变更、已知问题等）。
  - [ ] 为当前已有的重要里程碑版本补齐变更记录，至少覆盖「核心功能基本完成」以后的一到两个关键版本。

---

#### 五、里程碑与验收标准对齐

- **7.10 多平台构建与运行验证**
  - [ ] 选定至少两个主要目标平台（例如当前已支持的平台组合），在各平台上完成核心功能的构建与运行，确认行为一致且稳定。
  - [ ] 为多平台构建与运行过程记录必要的步骤与依赖，便于后续复现与问题排查。

- **7.11 测试覆盖率与稳定性验收**
  - [ ] 在阶段结束前，对照阶段 7 的测试覆盖率目标，统计当前测试覆盖率并确认已达到预设要求。
  - [ ] 对长期回归测试集进行多轮执行，确认在最近一段时间内保持稳定通过，将结果作为阶段 7 验收的依据之一。
