# CN Language 编译器性能分析工具使用指南

## 概述

CN Language 编译器提供了内置的性能分析功能，可以测量和记录编译过程中各个阶段的耗时，帮助开发者识别性能瓶颈并优化编译器性能。

## 功能特性

### 1. 编译阶段性能测量

编译器可以测量以下编译阶段的耗时：

- **词法分析（Lexer）**：源代码分词阶段
- **语法分析（Parser）**：构建抽象语法树（AST）阶段
- **语义分析（Semantic）**：
  - 作用域构建：构建符号作用域
  - 名称解析：解析标识符引用
  - 类型检查：验证类型正确性
- **IR 生成（IR Generation）**：生成中间表示
- **IR 优化（IR Optimization）**：运行优化 Pass
- **代码生成（Code Generation）**：生成 C 代码
- **后端编译（Backend Compilation）**：调用外部 C 编译器

### 2. 性能数据输出格式

支持三种输出格式：

1. **控制台输出**：格式化表格，直接在终端显示
2. **JSON 格式**：结构化数据，便于程序处理
3. **CSV 格式**：表格数据，便于导入 Excel 等工具分析

## 使用方法

### 基本用法

#### 1. 启用性能分析

在编译命令中添加 `--perf` 选项：

```bash
cnc hello.cn --perf
```

输出示例：
```
函数: 主程序，语句数: 2

========== 编译性能分析报告 ==========
源文件: hello.cn
源文件大小: 78 字节
======================================

总耗时                       1.194 ms   100.0%
--------------------------------------
词法分析                    0.002 ms    0.17%
语法分析                    0.040 ms    3.35%
语义分析                    0.017 ms    1.42%
  - 作用域构建             0.012 ms    1.01%
  - 名称解析                0.003 ms    0.25%
  - 类型检查                0.001 ms    0.08%
IR 生成                       0.046 ms    3.85%
IR 优化                       0.018 ms    1.51%
代码生成                    0.606 ms   50.75%
======================================
```

#### 2. 导出 JSON 格式

```bash
cnc hello.cn --perf --perf-output=perf_result.json
```

生成的 JSON 文件内容：
```json
{
  "source_file": "hello.cn",
  "source_size": 78,
  "total_duration_ms": 1.194,
  "phases": [
    {
      "name": "词法分析",
      "duration_ms": 0.002,
      "percentage": 0.17
    },
    {
      "name": "语法分析",
      "duration_ms": 0.040,
      "percentage": 3.35
    }
    // ... 更多阶段数据
  ]
}
```

#### 3. 导出 CSV 格式

```bash
cnc hello.cn --perf --perf-output=perf_result.csv
```

生成的 CSV 文件内容：
```csv
Phase,Duration_ms,Percentage
总耗时,1.194,100.00
词法分析,0.002,0.17
语法分析,0.040,3.35
...
```

### 高级用法

#### 批量性能测试工具 cnperf

`cnperf` 工具可以批量测试多个 .cn 文件的编译性能：

##### 测试单个文件

```bash
cnperf test.cn
```

##### 测试目录下所有 .cn 文件

```bash
cnperf examples/
```

输出示例：
```
正在扫描文件...
找到 15 个 .cn 文件

[1/15] 正在测试: examples/hello_world.cn ... 完成 (1.234 ms)
[2/15] 正在测试: examples/array_examples.cn ... 完成 (3.456 ms)
...

========== 编译性能汇总报告 ==========
测试文件数: 15
总源代码大小: 12345 字节 (12.05 KB)
总编译耗时: 123.456 ms (0.123 s)
平均编译耗时: 8.230 ms
最短编译耗时: 1.234 ms
最长编译耗时: 15.678 ms
======================================

文件名                                          大小(字节)      耗时(ms)
--------------------------------------------------------------------------------
examples/hello_world.cn                              78         1.234
examples/array_examples.cn                          256         3.456
...
```

##### 导出汇总报告到 CSV

```bash
cnperf examples/ --output=perf_summary.csv
```

##### 指定编译器路径

```bash
cnperf examples/ --cnc=/path/to/cnc
```

## 性能分析最佳实践

### 1. 识别性能瓶颈

通过查看各阶段的耗时占比，可以快速识别性能瓶颈。例如，如果代码生成阶段占用超过 50% 的时间，就应该重点优化这个阶段。

### 2. 对比优化前后性能

在进行优化前后分别运行性能分析，并导出为 JSON 或 CSV 格式，便于对比优化效果：

```bash
# 优化前
cnc large_project.cn --perf --perf-output=before.json

# 进行优化...

# 优化后
cnc large_project.cn --perf --perf-output=after.json
```

### 3. 批量测试

使用 `cnperf` 工具批量测试多个文件，可以获得更全面的性能画像：

```bash
cnperf tests/ --output=test_perf.csv
```

### 4. 持续性能监控

将性能测试集成到持续集成（CI）流程中，定期运行性能测试并记录结果，及时发现性能退化。

## API 接口

对于需要在代码中集成性能测量的场景，可以直接使用性能分析 API：

### C API

```c
#include "cnlang/support/perf.h"

// 初始化性能统计
CnPerfStats stats;
cn_perf_stats_init(&stats, "source.cn", 1024);
cn_perf_stats_set_enabled(&stats, true);

// 开始测量总耗时
cn_perf_start(&stats, CN_PERF_PHASE_TOTAL);

// 测量词法分析阶段
cn_perf_start(&stats, CN_PERF_PHASE_LEXER);
// ... 词法分析代码 ...
cn_perf_end(&stats, CN_PERF_PHASE_LEXER);

// 结束总耗时测量
cn_perf_end(&stats, CN_PERF_PHASE_TOTAL);

// 打印统计结果
cn_perf_print_stats(&stats, stdout);

// 导出为 JSON
cn_perf_export_json(&stats, "result.json");

// 导出为 CSV
cn_perf_export_csv(&stats, "result.csv");
```

### 可用的阶段枚举

```c
typedef enum {
    CN_PERF_PHASE_TOTAL,              // 总耗时
    CN_PERF_PHASE_LEXER,              // 词法分析
    CN_PERF_PHASE_PARSER,             // 语法分析
    CN_PERF_PHASE_SEMANTIC,           // 语义分析
    CN_PERF_PHASE_SEMANTIC_SCOPE,     // 作用域构建
    CN_PERF_PHASE_SEMANTIC_RESOLVE,   // 名称解析
    CN_PERF_PHASE_SEMANTIC_TYPECHECK, // 类型检查
    CN_PERF_PHASE_IR_GEN,             // IR 生成
    CN_PERF_PHASE_IR_OPT,             // IR 优化
    CN_PERF_PHASE_CODEGEN,            // 代码生成
    CN_PERF_PHASE_BACKEND_COMPILE,    // 后端编译
    CN_PERF_PHASE_COUNT               // 阶段数量
} CnPerfPhase;
```

## 性能数据精度

- **Windows 平台**：使用 `QueryPerformanceCounter` API，精度通常为微秒级
- **Linux/Unix 平台**：使用 `gettimeofday`，精度为微秒级

## 注意事项

1. 性能测量会引入极小的额外开销（通常小于 1%），但对于准确识别瓶颈已经足够
2. 对于非常小的文件（如几十字节），测量结果可能会受到系统调度和缓存的影响
3. 建议使用较大的项目或批量测试来获得更稳定和可靠的性能数据
4. 性能测量默认是禁用的，只有使用 `--perf` 选项时才会启用

## 故障排查

### 性能数据显示为 0

如果某些阶段的耗时显示为 0，可能的原因：
1. 该阶段实际耗时极短（小于 1 微秒）
2. 性能测量未正确启用
3. 时间戳获取失败（极少见）

### JSON/CSV 文件无法生成

检查：
1. 文件路径是否正确
2. 是否有写入权限
3. 磁盘空间是否充足

## 示例场景

### 场景 1：优化大项目编译速度

```bash
# 1. 测量当前性能
cnperf large_project/ --output=baseline.csv

# 2. 查看报告，识别瓶颈阶段

# 3. 针对瓶颈阶段进行优化

# 4. 重新测量并对比
cnperf large_project/ --output=optimized.csv
```

### 场景 2：监控单个关键文件

```bash
# 持续监控关键文件的编译性能
cnc critical_module.cn --perf --perf-output=monitor_$(date +%Y%m%d_%H%M%S).json
```

### 场景 3：CI 集成

```bash
#!/bin/bash
# 在 CI 流程中运行性能测试
cnperf tests/ --output=ci_perf_report.csv

# 检查是否有性能退化
# （可以编写脚本对比历史数据）
```

## 总结

CN Language 的性能分析工具提供了全面的编译过程性能监控能力，帮助开发者：

1. **识别瓶颈**：快速定位性能热点
2. **验证优化**：量化优化效果
3. **持续监控**：及时发现性能退化
4. **批量分析**：全面了解项目性能特征

通过合理使用这些工具，可以显著提升编译器的性能和开发效率。
