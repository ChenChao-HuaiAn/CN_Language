### 阶段 6：工具链与生态 TODO 列表

根据 `docs/design/CN_Language 开发计划.md` 中第 179-198 行关于「阶段 6：工具链与生态（REPL / 格式化 / 检查器）」的规划，以下是对应的详细 TODO 列表，用于指导实现和验收。

---

#### 一、REPL 工具（`cnrepl`）

- **6.1 REPL 可执行程序与基础结构**
  - [x] 在 `src/cli/` 下为 REPL 新增子目录（如 `src/cli/cnrepl/`），实现独立入口 `main` 函数，并在顶层 `CMakeLists.txt` 中增加 `cnrepl` 可执行目标。
  - [x] 设计 REPL 的参数与启动方式：
    - [x] 支持不带参数直接进入交互模式。
    - [x] 预留从文件加载初始化脚本的参数（可后续实现）。
  - [x] 复用现有编译管线所需的对外 API（lexer/parser/semantics/IR/backend），避免在 REPL 中直接拼装内部细节。

- **6.2 交互循环（Read–Eval–Print Loop）基础能力**
  - [x] 实现最小 REPL 循环：
    - [x] 从标准输入读取一行或多行代码；
    - [x] 调用前端完成词法/语法/语义分析；
    - [x] 在无致命错误时触发后续执行路径；
    - [x] 将结果或错误信息打印到标准输出。
  - [x] 明确 REPL 支持的代码粒度：
    - [x] 支持单个表达式求值（用于快速试验语法和表达式）；
    - [x] 最少支持「小段程序」形式，如包含若干变量声明和简单语句块。

- **6.3 REPL 执行模型与状态管理**
  - [x] 设计 REPL 内部执行模型：
    - [x] 明确是在每次输入后重启完整编译 + 运行流程，还是维护长生命周期的「会话状态」（符号表/环境）。
    - [x] 在不破坏现有阶段边界的前提下，优先选择实现成本较低、行为清晰的方案，并在代码中留出后续扩展空间。
  - [x] 支持在 REPL 会话内连续输入多条语句：
    - [x] 保证前一次定义的变量/函数在后续输入中可见。

- **6.4 REPL 诊断与用户体验**
  - [x] 通过 `src/support/diagnostics` 模块输出语法/语义错误，而不是直接使用 `printf`。
  - [x] 在 REPL 中为常见错误提供更友好的提示（如显示出错位置的代码片段）。
  - [x] 约定并实现 REPL 专用的退出命令（如 `:quit` 或 `:q`），在帮助信息中说明。

- **6.5 REPL 测试与验收**
  - [x] 在 `tests/integration/` 下新增 REPL 相关测试（可新建 `integration_repl_test.c` 或等效文件）：
    - [x] 覆盖单表达式求值场景（如简单算术/逻辑表达式）。
    - [x] 覆盖包含若干变量声明和语句的小段程序场景。
  - [x] 为 REPL 的核心逻辑（如会话状态管理、命令解析）增加基础单元测试，确保行为可回归。
  - [x] 确认 REPL 满足「可用于快速试验语法和小段程序」的验收标准，并在测试中锁定关键行为。

---

#### 二、代码格式化工具

- **6.6 格式化工具形态与入口设计**
  - [x] 确定格式化工具形态：
    - [x] 作为独立可执行工具（如 `cnfmt`），或在 `cnc` 中增加 `--format` / `format` 子命令（二选一即可）。
  - [x] 在 `src/cli/` 下为格式化工具增加相应入口与目录结构，并在 CMake 中添加构建目标。
  - [x] 设计命令行接口：
    - [x] 支持对单个 `.cn` 文件进行格式化；
    - [x] 支持对目录进行递归格式化（至少覆盖 `examples/`）；
    - [x] 支持「原地修改」与「输出到标准输出」两种模式（可通过参数控制）。

- **6.7 格式化规则与实现策略**
  - [x] 将 `docs/specifications/CN_Language C 代码风格规范.md` 中与源代码布局相关的规则整理为格式化器内部的配置或常量（缩进、括号位置、空格、空行等）。
  - [x] 选择并实现格式化策略：
    - [x] 基于已有 Parser/AST 的结构化重排；或
    - [x] 基于 Token 流的规则驱动重写。
  - [x] 覆盖核心语法结构：
    - [x] 变量声明、表达式、控制流语句（if/while/for 等）；
    - [x] 函数定义与调用；
    - [x] 数组/结构体等常用语言构造。

- **6.8 格式化稳定性与项目级应用**
  - [x] 确保格式化结果具备幂等性：对同一文件多次格式化，输出保持完全一致。
  - [x] 在 `examples/` 目录上跑一轮格式化，将结果与风格规范对齐并用于验证实现效果。
  - [x] 预留在 CI 或本地开发流程中集成格式化检查的接口（如「仅检查不改写」模式，返回非零退出码用于拒绝不规范代码）。

- **6.9 格式化工具测试与验收**
  - [x] 为格式化核心逻辑编写单元测试（可放在 `tests/unit/` 下新建对应模块），覆盖：
    - [x] 不同缩进层级与嵌套结构；
    - [x] 注释与空行的保留/调整策略；
    - [x] 特殊边界情况（空文件、仅有注释的文件等）。
  - [x] 在 `tests/integration/` 中增加对样例项目的格式化集成测试：
    - [x] 对若干 `.cn` 示例执行格式化，并与期望输出进行比对；
    - [x] 验证结果稳定可复现，满足开发计划中的里程碑要求。

---

#### 三、静态检查工具（风格与潜在问题检查）

- **6.10 静态检查工具入口与命令行接口**
  - [x] 设计并实现静态检查工具入口：
    - [x] 可以是独立可执行（如 `cncheck`），也可以是 `cnc` 中的一个子命令；
    - [x] 明确与格式化工具的职责边界（格式化只改排版，静态检查报告潜在问题）。
  - [x] 设计基础命令行参数：
    - [x] 接受一个或多个待检查的 `.cn` 文件/目录；
    - [x] 提供「仅检查返回码」模式，用于 CI 中作为质量门槛。

- **6.11 基础静态检查规则**
  - [x] 实现与开发计划中提到的核心检查：
    - [x] 未使用的局部变量/参数检测；
    - [x] 过于复杂的函数/表达式的简单复杂度限制（可基于语句数量、嵌套层级等粗粒度指标）。
  - [x] 为后续扩展预留检查框架：
    - [x] 将每类检查实现为独立的「规则」，方便未来增加更多静态检查项；
    - [x] 支持按规则类别启用/禁用（可以先通过简单配置或命令行开关实现）。

- **6.12 诊断输出与与现有管线的衔接**
  - [x] 使用 `src/support/diagnostics` 模块输出静态检查告警/错误，统一格式和位置显示。
  - [x] 为静态检查定义专用诊断代码（例如「未使用变量」「复杂度超限」），便于后续在文档和工具中引用。
  - [x] 确保静态检查与现有编译错误区分开来（例如使用不同前缀或严重级别）。

- **6.13 静态检查测试与验收**
  - [x] 在 `tests/unit/` 中为静态检查规则新增单元测试：
    - [x] 构造含未使用变量的最小示例，验证能被正确检测；
    - [x] 构造接近复杂度阈值的函数，验证超限时给出预期告警。
  - [x] 在 `tests/integration/` 中增加静态检查集成测试：
    - [x] 对一组示例 `.cn` 文件运行静态检查，验证输出中包含预期告警信息；
    - [x] 验证在存在严重问题时静态检查工具返回非零退出码，满足 CI 使用需求。

---

#### 四、语言服务（LSP，后续能力）

> 开发计划中将语言服务标注为「后续」能力，本小节以设计和规划为主，可根据实际进度延后实现。

- **6.14 语言服务架构与协议设计** ✅
  - [x] 基于 LSP（Language Server Protocol）草拟 CN_Language 的语言服务支持范围：
    - [x] 最小子集：语法高亮、诊断信息、基本跳转（定义/引用）；
    - [x] 后续扩展：补全、重构等高级能力。
  - [x] 设计语言服务进程模型：
    - [x] 采用标准 JSON-RPC over stdio 的 LSP 服务器模式；
    - [x] 明确与现有编译前端模块的交互接口（尽量复用 Parser/语义分析）。

- **6.15 语言服务原型实现（可选）** ✅
  - [x] 预留一个最小的 LSP Server 原型：
    - [x] 实现初始化、打开文档、关闭文档等基础 LSP 消息处理；
    - [x] 复用编译前端进行语法/语义诊断，并以 LSP 的 `publishDiagnostics` 形式返回。
  - [x] 在项目文档中记录已支持/计划支持的 LSP 能力，避免与实际实现偏离（可在后续阶段再细化）。

---

#### 五、整体测试与阶段验收

- **6.16 阶段 6 综合测试清单**
  - [ ] 为 REPL、格式化工具、静态检查工具分别整理测试清单，确保：
    - [ ] 每个工具都有对应的单元测试和至少一个集成测试场景；
    - [ ] 覆盖典型使用路径和主要错误场景。
  - [ ] 在 `ctest` 配置中纳入新增加的测试目标，保证一键执行即可验证阶段 6 的主要能力。

- **6.17 与里程碑的对应关系**
  - [ ] 明确标记哪些测试/用例对应开发计划中的里程碑：
    - [ ] REPL：能在命令行快速试验语法和小段程序；
    - [ ] 格式化工具：能对样例项目进行统一格式化，结果稳定可复现；
    - [ ] 静态检查工具：能在简单场景下发现未使用变量、复杂度超限等问题。
  - [ ] 在阶段结束前，对照本 TODO 列表逐项检查完成情况，并在需要时更新 `CN_Language 开发计划.md` 的进度标记。