# 阶段 6：工具链与生态 - 综合测试清单

本文档整理阶段 6 各工具的测试覆盖情况，确保所有工具都有完整的单元测试和集成测试。

---

## 1. REPL（交互式解释器）测试清单

### 1.1 单元测试

#### 测试文件：`tests/unit/repl_command_test.c`
**测试场景：**
- ✅ 基本命令识别（:help, :quit, :reset）
- ✅ 命令别名（:h, :q, :v）
- ✅ 配置切换命令（:verbose, :ast, :ir）
- ✅ 带前导空白的命令处理
- ✅ 未知命令处理

**CMake 目标：** `repl_command_test`

#### 测试文件：`tests/unit/repl_session_test.c`
**测试场景：**
- ✅ 会话初始化和清理
- ✅ 变量定义和查询
- ✅ 符号表管理
- ✅ 作用域管理

**CMake 目标：** `repl_session_test`

**覆盖的主要功能：**
- 命令解析和执行
- 会话状态管理
- 符号表操作

### 1.2 集成测试

#### 测试文件：`tests/integration/integration_repl_expr_test.c`
**测试场景：**
- ✅ 单表达式求值
- ✅ 算术表达式计算
- ✅ 变量引用
- ✅ 表达式错误处理

**CMake 目标：** `integration_repl_expr_test`

#### 测试文件：`tests/integration/integration_repl_statement_test.c`
**测试场景：**
- ✅ 变量声明和赋值
- ✅ 函数定义和调用
- ✅ 控制流语句
- ✅ 多语句执行

**CMake 目标：** `integration_repl_statement_test`

#### 测试文件：`tests/integration/integration_repl_session_test.c`
**测试场景：**
- ✅ 跨多次输入的状态保持
- ✅ 符号可见性和生命周期
- ✅ 重置命令功能

**CMake 目标：** `integration_repl_session_test`

**覆盖的主要使用路径：**
- 表达式求值流程
- 语句执行流程
- 会话状态持久化

**主要错误场景覆盖：**
- 语法错误
- 语义错误
- 未定义变量/函数

---

## 2. 格式化工具（cnfmt）测试清单

### 2.1 单元测试

#### 测试文件：`tests/unit/formatter_test.c`
**测试场景：**
- ✅ 简单函数格式化
- ✅ 变量声明格式化
- ✅ 表达式格式化（空格规范化）
- ✅ if 语句格式化
- ✅ 循环语句格式化
- ✅ 函数调用格式化
- ✅ 数组字面量格式化
- ✅ 缩进一致性检查
- ✅ 空行处理
- ✅ 注释保留

**CMake 目标：** `formatter_test`

**覆盖的主要功能：**
- AST 到格式化文本的转换
- 缩进管理
- 运算符空格规范
- 换行策略

### 2.2 集成测试

#### 测试文件：`tests/integration/format/integration_format_test.c`
**测试场景：**
- ✅ Hello World 程序格式化
- ✅ 算术表达式格式化
- ✅ 嵌套循环格式化
- ✅ 完整程序格式化
- ✅ 格式化幂等性（多次格式化结果一致）

**测试数据文件：**
- `test_hello_world.cn` / `test_hello_world_expected.cn`
- `test_arithmetic.cn` / `test_arithmetic_expected.cn`
- `test_nested_loops.cn` / `test_nested_loops_expected.cn`
- `test_input.cn` / `test_expected.cn`

**CMake 目标：** `integration_format_test`

**覆盖的主要使用路径：**
- 从文件读取并格式化
- 格式化输出到文件
- 命令行工具调用流程

**主要错误场景覆盖：**
- 语法错误的源文件处理
- 空文件处理
- 大文件格式化

---

## 3. 静态检查工具（cncheck）测试清单

### 3.1 单元测试

#### 测试文件：`tests/unit/static_check_test.c`
**测试场景：**
- ✅ 未使用的局部变量检查
- ✅ 未使用的函数参数检查
- ✅ 函数复杂度检查（语句数）
- ✅ 函数嵌套层级检查
- ✅ 禁用规则配置
- ✅ 告警级别配置

**CMake 目标：** `static_check_test`

**覆盖的主要功能：**
- 未使用符号检查
- 复杂度分析
- 代码风格检查
- 规则配置系统

### 3.2 集成测试

#### 测试文件：`tests/integration/check/integration_check_test.c`
**测试场景：**
- ✅ 完整源文件静态检查
- ✅ 多个告警同时报告
- ✅ 配置文件加载
- ✅ 命令行参数处理

**CMake 目标：** `integration_check_test`

**覆盖的主要使用路径：**
- 从文件读取并检查
- 报告格式化输出
- 命令行工具调用流程

**主要错误场景覆盖：**
- 语法错误源文件
- 空文件检查
- 配置文件错误

---

## 4. 测试执行指南

### 4.1 单元测试执行

```bash
cd build

# 执行所有单元测试
ctest -R "^(repl_|formatter_|static_check_)" -V

# 或分别执行各工具的单元测试
ctest -R "^repl_" -V              # REPL 单元测试
ctest -R "^formatter_test$" -V    # 格式化器单元测试
ctest -R "^static_check_test$" -V # 静态检查单元测试
```

### 4.2 集成测试执行

```bash
cd build

# 执行所有集成测试
ctest -R "^integration_(repl|format|check)" -V

# 或分别执行各工具的集成测试
ctest -R "^integration_repl_" -V    # REPL 集成测试
ctest -R "^integration_format_" -V  # 格式化器集成测试
ctest -R "^integration_check_" -V   # 静态检查集成测试
```

### 4.3 一键执行阶段 6 所有测试

```bash
cd build

# 执行阶段 6 所有相关测试（单元 + 集成）
ctest -R "(repl_|formatter_|static_check_|integration_repl_|integration_format_|integration_check_)" -V

# 或者使用标签（需要在 CMakeLists.txt 中配置测试标签）
ctest -L stage6 -V
```

---

## 5. 测试覆盖统计

### 5.1 REPL 测试统计
- **单元测试数量：** 2 个测试文件，约 10+ 测试场景
- **集成测试数量：** 3 个测试文件，覆盖表达式、语句、会话管理
- **测试 CMake 目标：** 
  - `repl_command_test`
  - `repl_session_test`
  - `integration_repl_expr_test`
  - `integration_repl_statement_test`
  - `integration_repl_session_test`

### 5.2 格式化工具测试统计
- **单元测试数量：** 1 个测试文件，约 15+ 测试场景
- **集成测试数量：** 1 个测试文件 + 4 组测试数据
- **测试 CMake 目标：**
  - `formatter_test`
  - `integration_format_test`

### 5.3 静态检查工具测试统计
- **单元测试数量：** 1 个测试文件，约 8+ 测试场景
- **集成测试数量：** 1 个测试文件
- **测试 CMake 目标：**
  - `static_check_test`
  - `integration_check_test`

---

## 6. 测试质量保证

### 6.1 测试覆盖要求
- ✅ 每个工具都有单元测试覆盖核心功能
- ✅ 每个工具至少有 1 个集成测试场景
- ✅ 覆盖典型使用路径
- ✅ 覆盖主要错误场景

### 6.2 测试可维护性
- ✅ 测试代码符合项目编码规范
- ✅ 测试用例命名清晰
- ✅ 测试数据独立于测试代码
- ✅ 测试输出易于理解

### 6.3 持续集成
- ✅ 所有测试纳入 ctest 配置
- ✅ 测试可以在构建后一键执行
- ✅ 测试失败时能准确定位问题

---

## 7. 测试改进计划

### 7.1 短期改进（可选）
- [ ] 为测试添加标签（stage6, repl, format, check）以便分类执行
- [ ] 增加测试覆盖率报告
- [ ] 添加性能基准测试

### 7.2 长期改进（可选）
- [ ] 集成到 CI/CD 流程
- [ ] 添加模糊测试（fuzzing）
- [ ] 添加压力测试

---

## 8. 验收标准

阶段 6 综合测试清单完成的验收标准：

✅ **已完成：**
1. 为 REPL、格式化工具、静态检查工具分别整理测试清单
2. 每个工具都有对应的单元测试和至少一个集成测试场景
3. 覆盖典型使用路径和主要错误场景
4. 在 ctest 配置中纳入新增加的测试目标
5. 可以一键执行验证阶段 6 的主要能力

**测试命令：**
```bash
cd build
cmake ..
cmake --build .
ctest -V  # 执行所有测试
```

---

## 9. 与开发计划里程碑的对应关系

本章节明确标记哪些测试/用例对应开发计划中的里程碑：

### 9.1 REPL 里程碑：能在命令行快速试验语法和小段程序

**里程碑定义**（来源：`docs/design/CN_Language 开发计划.md` 阶段 6）：
> REPL 可用于快速试验语法和小段程序。

**对应测试**：

#### 单元测试：
- ✅ `repl_command_test` - 验证 REPL 命令解析功能
  - 测试命令识别：`:help`, `:quit`, `:reset`, `:verbose`, `:ast`, `:ir`
  - 测试命令别名：`:h`, `:q`, `:v`
  - 验证配置切换功能
  - **里程碑贡献**：确保 REPL 交互命令正确执行

- ✅ `repl_session_test` - 验证会话状态管理
  - 测试会话初始化和清理
  - 测试变量定义和查询
  - 测试符号表管理
  - **里程碑贡献**：确保 REPL 可以保持状态，支持连续输入

#### 集成测试：
- ✅ `integration_repl_expr_test` - 验证单表达式求值
  - 测试算术表达式：`1 + 2`, `10 + 20 * 3 - 5`, `(5 + 3) * 2`
  - 测试比较表达式：`10 > 5`, `3 == 3`
  - 测试逻辑表达式：`1 && 1`, `0 || 1`
  - **里程碑贡献**：直接验证“快速试验语法”能力

- ✅ `integration_repl_statement_test` - 验证小段程序执行
  - 测试变量声明：`整数 x = 10;`, `变量 y = 42;`
  - 测试函数调用：`打印("Hello");`
  - 测试控制流：`如果 (1 > 0) { 打印("true"); }`
  - 测试循环：`当 (i < 3) { 打印(i); i = i + 1; }`
  - **里程碑贡献**：直接验证“小段程序”执行能力

- ✅ `integration_repl_session_test` - 验证跨多次输入的状态保持
  - 测试符号可见性和生命周期
  - 测试重置命令功能
  - **里程碑贡献**：确保 REPL 支持多轮交互

**验收状态**：✅ **已完成**
- 所有 REPL 单元测试通过（100%）
- 所有 REPL 集成测试通过
- 可以通过命令行快速试验表达式和语句

---

### 9.2 格式化工具里程碑：能对样例项目进行统一格式化，结果稳定可复现

**里程碑定义**（来源：`docs/design/CN_Language 开发计划.md` 阶段 6）：
> 格式化工具可对样例项目进行统一格式化，结果稳定可复现。

**对应测试**：

#### 单元测试：
- ✅ `formatter_test` - 验证格式化器核心功能
  - 测试简单函数格式化
  - 测试变量声明格式化（空格规范化）
  - 测试表达式格式化
  - 测试控制流语句格式化
  - 测试缩进一致性
  - **里程碑贡献**：确保格式化规则正确实现

#### 集成测试：
- ✅ `integration_format_test` - 验证完整文件格式化
  - 测试 Hello World 程序格式化
  - 测试算术表达式程序格式化
  - 测试嵌套循环程序格式化
  - 测试格式化幂等性（多次格式化结果一致）
  - **里程碑贡献**：直接验证“统一格式化”和“结果稳定可复现”

**验收状态**：✅ **已完成**
- 所有格式化工具测试通过（100%）
- 支持对样例项目进行统一格式化
- 格式化结果稳定（幂等性测试通过）

---

### 9.3 静态检查工具里程碑：能在简单场景下发现未使用变量、复杂度超限等问题

**里程碑定义**（来源：根据 TODO 6.17 描述）：
> 静态检查工具：能在简单场景下发现未使用变量、复杂度超限等问题。

**对应测试**：

#### 单元测试：
- ✅ `static_check_test` - 验证静态检查核心功能
  - 测试未使用的局部变量检查
  - 测试未使用的函数参数检查
  - 测试函数复杂度检查（语句数）
  - 测试函数嵌套层级检查
  - 测试规则禁用配置
  - **里程碑贡献**：直接验证“发现未使用变量、复杂度超限”能力

#### 集成测试：
- ✅ `integration_check_test` - 验证完整文件静态检查
  - 测试检查单个文件（有问题）
  - 测试检查单个文件（无问题）
  - 测试 check-only 模式（CI 模式）
  - 测试自定义复杂度阈值
  - 测试禁用特定规则
  - **里程碑贡献**：验证在“简单场景”下发现问题的能力

**验收状态**：✅ **已完成**
- 所有静态检查工具测试通过（100%）
- 可以发现未使用变量、未使用参数
- 可以检测函数复杂度超限（语句数、嵌套层级）

---

### 9.4 里程碑总结

| 工具 | 里程碑 | 对应测试 | 状态 |
|------|------|-----------|------|
| REPL | 快速试验语法和小段程序 | 2 个单元测试 + 3 个集成测试 | ✅ 已达成 |
| 格式化工具 | 统一格式化，结果稳定可复现 | 1 个单元测试 + 1 个集成测试 | ✅ 已达成 |
| 静态检查工具 | 发现未使用变量、复杂度超限 | 1 个单元测试 + 1 个集成测试 | ✅ 已达成 |

**阶段 6 总体里程碑状态**：✅ **全部达成**

---

**文档版本：** v2.0  
**创建日期：** 2026-01-24  
**最后更新：** 2026-01-24  
**更新内容：** 添加与开发计划里程碑的对应关系说明


