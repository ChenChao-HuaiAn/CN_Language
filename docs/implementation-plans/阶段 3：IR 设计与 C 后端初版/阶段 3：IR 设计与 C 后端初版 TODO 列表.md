
根据 `development_plan.md` 中第 113-137 行关于 **“阶段 3：IR 设计与 C 后端初版”** 的规划，以下是为您整理的详细 TODO 列表：

### 阶段 3：IR 设计与 C 后端初版 TODO 列表

#### 1. IR (中间表示) 设计与实现
- [ ] **定义 IR 指令集**：设计支持三地址码或类似结构的指令集（如 `ADD`, `SUB`, `LOAD`, `STORE`, `CALL` 等）。
- [ ] **定义基本块与控制流图 (CFG)**：设计 IR 的组织结构，支持基本块 (Basic Block) 的划分。
- [ ] **实现 IR 数据结构**：在 `src/ir/` 中实现相关结构体，确保其能良好映射 AST 信息与类型系统。

### 1. 细化后的 TODO 列表 (针对原 5-10 行)

#### 1.1 定义 IR 指令集 (三地址码风格)
- [x] **算术与逻辑指令**：`ADD`, `SUB`, `MUL`, `DIV`, `MOD`, `AND`, `OR`, `XOR`, `SHL`, `SHR`。
- [x] **比较指令**：`EQ` (等于), `NE` (不等), `LT` (小于), `LE` (小等), `GT` (大于), `GE` (大等)。
- [x] **内存操作指令**：
    - [x] `ALLOCA`：在栈上分配局部变量空间。
    - [x] `LOAD`：从内存地址加载值到寄存器（虚拟寄存器）。
    - [x] `STORE`：将值存入内存地址。
- [x] **控制流指令**：
    - [x] `LABEL`：定义跳转目标点。
    - [x] `JUMP`：无条件跳转。
    - [x] `BRANCH`：条件跳转（根据寄存器值跳转到不同 Label）。
    - [x] `CALL`：函数调用。
    - [x] `RET`：函数返回。
- [x] **其他指令**：`NEG` (取负), `NOT` (逻辑非), `PHI` (若后续考虑 SSA 形式)。

#### 1.2 定义基本块与控制流图 (CFG)
- [x] **基本块 (Basic Block)**：
    - [x] 设计 `CnIrBasicBlock` 结构，包含一系列指令。
    - [x] 规定基本块必须以跳转指令或返回指令结尾（Terminator）。
- [x] **控制流图 (CFG)**：
    - [x] 在 `CnIrBasicBlock` 中维护前驱 (Predecessors) 和后继 (Successors) 指针。
    - [x] 实现基本块的拆分与连接算法。
- [x] **函数表示**：
    - [x] 设计 `CnIrFunction` 结构，包含入口基本块、参数列表及局部变量表。

#### 1.3 实现 IR 数据结构 (`src/ir/`)
- [x] **目录初始化**：创建 `src/ir/core/` 目录。
- [x] **指令结构体定义**：在 `include/cnlang/ir/ir.h` 中定义 `CnIrInst`，使用 `union` 存储不同指令的参数。
- [x] **操作数定义**：定义 `CnIrOperand`，支持虚拟寄存器、立即数（整型、字符串字面量）和全局符号。
- [ ] **IR 打印工具**：实现将 IR 序列化为文本的函数（如 `cn_ir_dump`），便于调试观察 `AST -> IR` 的结果。

#### 2. AST 到 IR 的转换 (Lowering)
- [ ] **表达式转换规则**：实现算术、逻辑、赋值等表达式到 IR 指令的生成逻辑。
- [ ] **语句与控制流转换**：实现 `if`、`while`、`for` 等控制流语句到 IR 跳转指令的转换。
- [ ] **函数定义转换**：处理函数参数、局部变量作用域及返回值的 IR 生成。

#### 3. IR 优化 (Optional/Initial)
- [ ] **常量折叠 (Constant Folding)**：实现基础的编译时常量计算优化。
- [ ] **死代码删除 (Dead Code Elimination)**：初步实现移除不可达代码或无用赋值的 Pass。

#### 4. C 代码后端实现
- [ ] **约定 C 接口 ABI**：明确函数命名混淆规则、类型映射表（如 `CN int` -> `int32_t`）。
- [ ] **IR 转换 C 代码逻辑**：编写将 IR 指令序列翻译为合法 C 语法的生成器。
- [ ] **输出模块**：实现将生成的 C 代码写入 `.c` 文件的功能。

#### 5. 构建与集成
- [ ] **自动化编译流程**：在 `cnc` 中集成调用外部 C 编译器（如 `clang` 或 `gcc`）的功能。
- [ ] **链接运行时库**：确保生成的代码能正确链接基础运行时支持。

#### 6. 验收与验证
- [ ] **端到端测试**：在 `tests/integration/compiler/` 下新增测试用例，验证从 `.cn` 到可执行文件并运行结果正确。
- [ ] **文档同步**：根据实现情况微调 `IR` 规范文档。

---
**提示**：您可以根据实际进度，要求我为您拆解其中某个具体子任务的实现细节。