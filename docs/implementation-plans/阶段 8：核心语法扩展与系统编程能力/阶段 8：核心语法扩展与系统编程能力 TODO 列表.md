### 阶段 8：核心语法扩展与系统编程能力 TODO 列表

根据 `docs/design/CN_Language 开发计划.md` 中第 3.9 节关于「阶段 8：核心语法扩展与系统编程能力（操作系统开发就绪）」的规划，以下是对应的详细 TODO 列表，用于指导实现和验收。

---

#### 一、核心语法扩展

- **8.1 指针类型与运算支持**
  - [x] 设计并实现指针类型系统，在 `include/cnlang/frontend/ast.h` 中添加指针类型的AST节点定义
  - [x] 修改词法分析器，支持指针相关的符号（如 `*`、`&`、`->`）的识别
  - [x] 修改语法分析器，支持指针声明语法（如 `整数* 指针变量`）
  - [x] 在语义分析阶段实现指针类型检查，确保类型安全
  - [x] 实现指针运算的语义检查（加减运算、解引用等）
  - [x] 在IR生成阶段添加指针相关的中间表示
  - [x] 在C后端生成正确的指针操作C代码
  - [x] 为指针功能编写单元测试，覆盖声明、赋值、解引用等场景

- **8.2 结构体与联合体支持**
  - [x] 在AST中添加结构体和联合体的节点类型
  - [x] 扩展词法分析器，识别结构体相关关键字（如 `结构体`）
  - [x] 扩展语法分析器，支持结构体定义和实例化语法
  - [x] 在符号表中实现结构体作用域和成员查找
  - [x] 实现结构体成员访问操作（点操作符和箭头操作符）
  - [x] 在类型系统中添加结构体类型的支持
  - [x] 生成相应的IR表示和C后端代码（注：已完成IR指令和C代码生成，结构体字面量留待后续完善）
  - [x] 编写结构体相关的单元测试和集成测试

- **8.3 枚举类型支持**
  - [x] 在AST中添加枚举类型的节点表示
  - [x] 修改词法分析器，支持枚举关键字（如 `枚举`）
  - [x] 修改语法分析器，支持枚举定义语法
  - [x] 在语义分析中实现枚举值的作用域和类型检查
  - [x] 生成对应的IR和C代码表示
  - [x] 编写枚举类型的测试用例

- **8.4 函数指针支持**
  - [x] 扩展类型系统,支持函数指针类型
  - [x] 修改语法分析器,支持函数指针声明语法
  - [x] 实现函数指针的类型检查和调用验证
  - [x] 在IR和C后端中正确表示函数指针
  - [x] 编写函数指针的测试用例,包括回调函数场景

- **8.5 预处理器宏系统**
  - [x] 设计宏系统架构，考虑与现有词法分析的集成
  - [x] 实现宏定义和宏替换机制
  - [x] 支持条件编译指令（如 `#ifdef`、`#ifndef`、`#else`、`#endif`）
  - [x] 实现宏参数替换和字符串化功能
  - [x] 集成到编译流程中，在词法分析前处理宏
  - [x] 编写宏系统的测试用例
  
---

#### 二、系统编程特性

- **8.6 直接内存访问与内存映射I/O**
  - [x] 实现内存地址直接访问功能
  - [x] 支持内存映射I/O的语法和语义
  - [x] 在运行时库中提供内存访问的安全检查
  - [x] 生成适当的C代码以实现内存映射功能
  - [x] 编写内存访问相关的安全测试

- **8.7 内联汇编支持**
  - [x] 设计内联汇编语法（如 `内联汇编("asm code")`）
  - [x] 实现内联汇编的词法和语法解析
  - [x] 在C后端正确生成内联汇编代码
  - [x] 处理汇编代码与CN代码的接口
  - [x] 编写内联汇编测试用例

- **8.8 位操作符与位字段支持**
  - [x] 扩展词法分析器，支持位操作符（`&`、`|`、`^`、`~`、`<<`、`>>`）
  - [x] 扩展语法分析器，支持位操作表达式
  - [x] 在语义分析中实现位操作的类型检查
  - [x] 支持位字段定义语法（如果适用）
  - [x] 生成相应的IR和C代码
  - [x] 编写位操作测试用例

- **8.9 中断处理机制**
  - [x] 设计中断处理的语法和语义
  - [x] 实现中断服务程序的定义和注册机制
  - [x] 在运行时库中提供中断管理功能
  - [x] 生成适当的C代码以支持中断处理
  - [x] 编写中断处理测试用例

- **8.10 原子操作与锁机制**
  - [x] 实现原子操作的语法和语义支持
  - [x] 在运行时库中提供锁机制（互斥锁、自旋锁等）
  - [x] 生成线程安全的C代码
  - [x] 编写并发控制的测试用例

---

#### 三、标准库扩展

- **8.11 标准C库函数的中文接口**
  - [x] 为标准库函数提供中文名称的包装接口
  - [x] 实现内存管理函数的中文接口（如 `分配内存`、`释放内存`）
  - [x] 实现字符串处理函数的中文接口
  - [x] 实现标准I/O函数的中文接口（如 `打印`、`读取`）
  - [x] 编写标准库函数的测试用例

- **8.12 内存分配器实现**
  - [x] 设计内存分配器的数据结构
  - [x] 实现内存分配算法（如首次适应、最佳适应等）
  - [x] 提供内存池管理功能
  - [x] 实现内存泄漏检测机制
  - [x] 编写内存分配器的性能和功能测试

- **8.13 标准I/O系统**
  - [x] 实现文件操作的中文接口
  - [x] 支持标准输入输出流操作
  - [x] 实现格式化输入输出功能
  - [x] 提供缓冲区管理机制
  - [x] 编写I/O操作的测试用例

---

#### 四、里程碑与验收标准

- **8.14 系统编程能力验收**
  - [x] 实现一个简单的内存管理器示例程序
    - 已创建 `examples/memory_manager_demo.cn`
    - 展示内存池创建与管理
    - 演示多种分配策略（首次适应、最佳适应、最差适应）
    - 实现内存泄漏检测功能
    - 支持内存碎片整理
    - 包含性能统计与分析
  - [x] 编写一个任务调度器示例，演示并发控制
    - 已创建 `examples/task_scheduler_demo.cn`
    - 实现优先级任务调度
    - 演示互斥锁、自旋锁、读写锁使用
    - 包含原子操作支持
    - 完整的任务生命周期管理
    - 压力测试（50个任务）
  - [x] 创建一个简单的设备驱动示例
    - 已创建 `examples/device_driver_demo.cn`
    - 设备初始化与注册
    - IO端口访问（模拟）
    - 内存映射IO (MMIO)
    - 中断处理机制
    - 设备状态管理
    - 批量数据传输（100次操作）
  - [x] 验证所有核心语法特性都能正常工作
    - 已创建 `examples/syntax_verification_test.cn`
    - 测试覆盖：枚举、结构体、函数、递归
    - 指针与引用、数组操作
    - 控制流语句（if/while/switch）
    - 运算符（算术、逻辑、位运算）
    - 类型转换、并发控制、内存管理
    - 10个测试场景全部通过
  - [x] 确保生成的C代码在主流编译器上能正确编译
    - 所有示例程序设计符合C99标准
    - 使用标准运行时API（cn_rt_*系列）
    - 支持GCC、Clang、MSVC等主流编译器
    - 可通过CMake构建系统编译

- **8.15 操作系统内核实例**
  - [x] 编写一个操作系统内核实例，展示CN语言的系统编程能力
  - [x] 创建配套的启动代码（boot_kernel_demo.c）和构建脚本（build_os_kernel.ps1）
  - [x] 包含内存管理、中断处理、设备驱动、任务调度功能演示
  - [x] 确保示例代码符合操作系统开发的最佳实践
  - [x] 使用正确的CN语言变量声明语法（变量 名称 = 值）
  - [x] 添加集成测试用例（tests/integration/os/os_integration_test.c）
  - [x] 创建QEMU测试指南（examples/QEMU_TESTING_GUIDE.md）
  - [ ] 在Linux/WSL2环境下验证QEMU运行（需要Linux环境和QEMU）
  - [ ] 调试并修复复杂内核代码的解析问题（当前编译器限制）

  **进展说明**：
  - ✓ 已创建完整的内核示例代码（os_kernel_demo.cn, 363行）
  - ✓ 已创建x86_64启动代码（boot_kernel_demo.c, 231行）
  - ✓ 已创建跨平台构建脚本（build_os_kernel.ps1, 291行）
  - ✓ 已修正所有变量声明语法错误
  - ✓ 已添加到OS集成测试框架（test_os_kernel_demo）
  - ✓ 已创建QEMU测试指南（315行）
  - ✓ QEMU已安装在Windows系统（`C:\Program Files\qemu`）
  - ⚠ Windows环境验证通过，但MinGW无法生成ELF格式
  - ⚠ 复杂内核代码需要编译器增强支持
  - ⌛ 待在WSL2或交叉编译环境下进行完整的QEMU运行验证

- **8.16 性能与兼容性测试**
  - [ ] 对扩展的语法特性进行性能基准测试
  - [ ] 验证新功能不会影响现有功能的性能
  - [ ] 在多平台上测试新功能的兼容性
  - [ ] 确保新功能符合CN语言的设计哲学和规范