# CN Language ç³»ç»Ÿç¼–ç¨‹ API æ–‡æ¡£

> **ç‰ˆæœ¬**: CN_Language é˜¶æ®µ9 - ç²¾ç®€å…³é”®å­—å  
> **çŠ¶æ€**: å·²å®ç°  
> **å¤´æ–‡ä»¶**: `cnlang/runtime/system_api.h`

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°æ›¿ä»£å·²åˆ é™¤å…³é”®å­—çš„è¿è¡Œæ—¶ç³»ç»ŸAPIã€‚è¿™äº›APIæä¾›ä¸åŸå…³é”®å­—ç›¸åŒçš„åŠŸèƒ½,ä½†é€šè¿‡è¿è¡Œæ—¶åº“å‡½æ•°å®ç°,æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ã€‚

### å…³é”®å­—è¿ç§»å¯¹ç…§è¡¨

| å·²åˆ é™¤å…³é”®å­— | æ–°APIå‡½æ•° | åŠŸèƒ½æè¿° |
|------------|----------|---------|
| è¯»å–å†…å­˜ | `cn_rt_mem_read()` | è¯»å–æŒ‡å®šåœ°å€çš„å†…å­˜ |
| å†™å…¥å†…å­˜ | `cn_rt_mem_write()` | å†™å…¥æ•°æ®åˆ°æŒ‡å®šåœ°å€ |
| å†…å­˜å¤åˆ¶ | `cn_rt_mem_copy()` | å¤åˆ¶å†…å­˜å— |
| å†…å­˜è®¾ç½® | `cn_rt_mem_set()` | è®¾ç½®å†…å­˜å—çš„å€¼ |
| æ˜ å°„å†…å­˜ | `cn_rt_mem_map()` | æ˜ å°„è™šæ‹Ÿå†…å­˜ |
| è§£é™¤æ˜ å°„ | `cn_rt_mem_unmap()` | è§£é™¤å†…å­˜æ˜ å°„ |
| å†…è”æ±‡ç¼– | `cn_rt_inline_asm()` | æ‰§è¡Œå†…è”æ±‡ç¼–ä»£ç  |
| ä¸­æ–­å¤„ç† | `cn_rt_interrupt_register()` | æ³¨å†Œä¸­æ–­å¤„ç†ç¨‹åº |

---

## å†…å­˜æ“ä½œ API

### cn_rt_mem_read()

è¯»å–æŒ‡å®šåœ°å€çš„å†…å­˜å€¼ã€‚

**åŸå‹**:
```c
uintptr_t cn_rt_mem_read(uintptr_t addr, size_t size);
```

**å‚æ•°**:
- `addr`: è¦è¯»å–çš„å†…å­˜åœ°å€
- `size`: è¯»å–å¤§å°(1/2/4/8å­—èŠ‚)

**è¿”å›å€¼**:
- è¯»å–çš„å€¼(æ ¹æ®sizeè½¬æ¢ä¸ºå¯¹åº”ç±»å‹)
- å¤±è´¥è¿”å›0

**åŸè¯­æ³•å¯¹æ¯”**:
```cn
// å·²åˆ é™¤çš„è¯­æ³•:
å˜é‡ æ•´æ•° value = è¯»å–å†…å­˜(0x1000);

// æ–°è¯­æ³•:
å˜é‡ æ•´æ•° value = æ•´æ•°(cn_rt_mem_read(0x1000, 4));
```

**æ³¨æ„äº‹é¡¹**:
- å¯ç”¨å®‰å…¨æ£€æŸ¥æ—¶ä¼šéªŒè¯åœ°å€å¯¹é½å’Œå¯è¯»æ€§
- æ”¯æŒçš„å¤§å°: 1(å­—èŠ‚), 2(å­—), 4(åŒå­—), 8(å››å­—)
- å…¶ä»–å¤§å°å°†å¯¼è‡´é”™è¯¯

---

### cn_rt_mem_write()

å‘æŒ‡å®šåœ°å€å†™å…¥æ•°æ®ã€‚

**åŸå‹**:
```c
void cn_rt_mem_write(uintptr_t addr, uintptr_t value, size_t size);
```

**å‚æ•°**:
- `addr`: è¦å†™å…¥çš„å†…å­˜åœ°å€
- `value`: è¦å†™å…¥çš„å€¼
- `size`: å†™å…¥å¤§å°(1/2/4/8å­—èŠ‚)

**åŸè¯­æ³•å¯¹æ¯”**:
```cn
// å·²åˆ é™¤çš„è¯­æ³•:
å†™å…¥å†…å­˜(0x1000, 0x42);

// æ–°è¯­æ³•:
cn_rt_mem_write(0x1000, 0x42, 4);
```

**æ³¨æ„äº‹é¡¹**:
- å¯ç”¨å®‰å…¨æ£€æŸ¥æ—¶ä¼šéªŒè¯åœ°å€å¯¹é½å’Œå¯å†™æ€§
- ä½¿ç”¨volatileè¯­ä¹‰ç¡®ä¿å†™å…¥ä¸è¢«ä¼˜åŒ–

---

### cn_rt_mem_copy()

å¤åˆ¶å†…å­˜å—ã€‚

**åŸå‹**:
```c
void cn_rt_mem_copy(void* dest, const void* src, size_t size);
```

**å‚æ•°**:
- `dest`: ç›®æ ‡åœ°å€
- `src`: æºåœ°å€
- `size`: å¤åˆ¶å¤§å°(å­—èŠ‚)

**åŸè¯­æ³•å¯¹æ¯”**:
```cn
// å·²åˆ é™¤çš„è¯­æ³•:
å†…å­˜å¤åˆ¶(dest, src, 100);

// æ–°è¯­æ³•:
cn_rt_mem_copy(dest, src, 100);
```

**æ³¨æ„äº‹é¡¹**:
- å¯ç”¨å®‰å…¨æ£€æŸ¥æ—¶ä¼šéªŒè¯æºå’Œç›®æ ‡åœ°å€çš„å¯è¯»/å¯å†™æ€§
- åº•å±‚ä½¿ç”¨`memcpy`å®ç°
- æºå’Œç›®æ ‡åŒºåŸŸä¸åº”é‡å (ä½¿ç”¨`memmove`å¤„ç†é‡å æƒ…å†µ)

---

### cn_rt_mem_set()

è®¾ç½®å†…å­˜å—çš„å€¼ã€‚

**åŸå‹**:
```c
void cn_rt_mem_set(void* addr, int value, size_t size);
```

**å‚æ•°**:
- `addr`: ç›®æ ‡åœ°å€
- `value`: å¡«å……å€¼(å–ä½8ä½)
- `size`: è®¾ç½®å¤§å°(å­—èŠ‚)

**åŸè¯­æ³•å¯¹æ¯”**:
```cn
// å·²åˆ é™¤çš„è¯­æ³•:
å†…å­˜è®¾ç½®(buffer, 0, 256);

// æ–°è¯­æ³•:
cn_rt_mem_set(buffer, 0, 256);
```

**æ³¨æ„äº‹é¡¹**:
- å¯ç”¨å®‰å…¨æ£€æŸ¥æ—¶ä¼šéªŒè¯åœ°å€å¯å†™æ€§
- åº•å±‚ä½¿ç”¨`memset`å®ç°

---

### cn_rt_mem_map()

æ˜ å°„è™šæ‹Ÿå†…å­˜ã€‚

**åŸå‹**:
```c
void* cn_rt_mem_map(void* addr, size_t size, int prot, int flags);
```

**å‚æ•°**:
- `addr`: å»ºè®®çš„æ˜ å°„åœ°å€(NULLè¡¨ç¤ºç”±ç³»ç»Ÿé€‰æ‹©)
- `size`: æ˜ å°„å¤§å°(å­—èŠ‚,é€šå¸¸æ˜¯é¡µå¤§å°çš„å€æ•°)
- `prot`: ä¿æŠ¤æ ‡å¿—(PROT_READ | PROT_WRITE | PROT_EXEC)
- `flags`: æ˜ å°„æ ‡å¿—(MAP_SHARED | MAP_PRIVATE | MAP_ANONYMOUS)

**è¿”å›å€¼**:
- æˆåŠŸ: æ˜ å°„åçš„åœ°å€
- å¤±è´¥: NULL

**åŸè¯­æ³•å¯¹æ¯”**:
```cn
// å·²åˆ é™¤çš„è¯­æ³•:
å˜é‡ æ•´æ•° addr = æ˜ å°„å†…å­˜(ç©º, 4096, 0x3, 0x22);

// æ–°è¯­æ³•:
å˜é‡ æ•´æ•° addr = æ•´æ•°(cn_rt_mem_map(ç©º, 4096, 0x3, 0x22));
```

**ä¿æŠ¤æ ‡å¿—**:
- `PROT_NONE (0x0)`: é¡µä¸å¯è®¿é—®
- `PROT_READ (0x1)`: é¡µå¯è¯»
- `PROT_WRITE (0x2)`: é¡µå¯å†™
- `PROT_EXEC (0x4)`: é¡µå¯æ‰§è¡Œ

**æ˜ å°„æ ‡å¿—**:
- `MAP_SHARED (0x01)`: å…±äº«æ˜ å°„
- `MAP_PRIVATE (0x02)`: ç§æœ‰æ˜ å°„
- `MAP_ANONYMOUS (0x20)`: åŒ¿åæ˜ å°„(ä¸å…³è”æ–‡ä»¶)

**å¹³å°æ”¯æŒ**:
- Linux/Unix: å®Œæ•´æ”¯æŒ(åŸºäºmmap)
- Windows: ä¸æ”¯æŒ(è¿”å›NULL)
- Freestanding: ä¸æ”¯æŒ(è¿”å›NULL)

---

### cn_rt_mem_unmap()

è§£é™¤å†…å­˜æ˜ å°„ã€‚

**åŸå‹**:
```c
int cn_rt_mem_unmap(void* addr, size_t size);
```

**å‚æ•°**:
- `addr`: æ˜ å°„åœ°å€
- `size`: æ˜ å°„å¤§å°

**è¿”å›å€¼**:
- æˆåŠŸ: 0
- å¤±è´¥: -1

**åŸè¯­æ³•å¯¹æ¯”**:
```cn
// å·²åˆ é™¤çš„è¯­æ³•:
è§£é™¤æ˜ å°„(addr, 4096);

// æ–°è¯­æ³•:
cn_rt_mem_unmap(addr, 4096);
```

---

## å†…è”æ±‡ç¼– API

### cn_rt_inline_asm()

æ‰§è¡Œå†…è”æ±‡ç¼–ä»£ç ã€‚

**åŸå‹**:
```c
int cn_rt_inline_asm(
    const char* asm_code,
    const char* outputs,
    const char* inputs,
    const char* clobbers
);
```

**å‚æ•°**:
- `asm_code`: æ±‡ç¼–ä»£ç å­—ç¬¦ä¸²
- `outputs`: è¾“å‡ºæ“ä½œæ•°(æ ¼å¼ä¾èµ–äºå¹³å°)
- `inputs`: è¾“å…¥æ“ä½œæ•°(æ ¼å¼ä¾èµ–äºå¹³å°)
- `clobbers`: ç ´åçš„å¯„å­˜å™¨åˆ—è¡¨

**è¿”å›å€¼**:
- æˆåŠŸ: 0
- å¤±è´¥: -1

**åŸè¯­æ³•å¯¹æ¯”**:
```cn
// å·²åˆ é™¤çš„è¯­æ³•:
å†…è”æ±‡ç¼–("mov eax, 1", "", "", "");

// æ–°è¯­æ³•:
cn_rt_inline_asm("mov eax, 1", ç©º, ç©º, ç©º);
```

**å½“å‰çŠ¶æ€**:
- è¿™æ˜¯ä¸€ä¸ªå ä½å®ç°
- å®é™…çš„å†…è”æ±‡ç¼–éœ€è¦åç«¯(cgen.c)åœ¨ç”ŸæˆCä»£ç æ—¶ç›´æ¥ç”Ÿæˆ`__asm__`è¯­å¥
- è¿è¡Œæ—¶å‡½æ•°ä¸»è¦ç”¨äºè¯­æ³•æ£€æŸ¥å’Œæµ‹è¯•

**åç«¯å®ç°å»ºè®®**:
```c
// åœ¨cgen.cä¸­,é‡åˆ°cn_rt_inline_asmè°ƒç”¨æ—¶,ç”Ÿæˆ:
__asm__ volatile (
    "mov eax, 1"
    : /* outputs */
    : /* inputs */
    : /* clobbers */
);
```

---

## ä¸­æ–­å¤„ç† API

### cn_rt_interrupt_register()

æ³¨å†Œä¸­æ–­å¤„ç†ç¨‹åºã€‚

**åŸå‹**:
```c
int cn_rt_interrupt_register(
    uint32_t vector_num,
    CnRtInterruptHandler handler,
    const char* name
);
```

**å‚æ•°**:
- `vector_num`: ä¸­æ–­å‘é‡å·(0-31)
- `handler`: ä¸­æ–­å¤„ç†å‡½æ•°æŒ‡é’ˆ
- `name`: ä¸­æ–­åç§°(ç”¨äºè°ƒè¯•)

**è¿”å›å€¼**:
- æˆåŠŸ: 0
- å¤±è´¥: è´Ÿæ•°é”™è¯¯ç 
  - `-1`: å‘é‡å·è¶…å‡ºèŒƒå›´
  - `-2`: æ— æ•ˆçš„å¤„ç†ç¨‹åº
  - `-3`: å·²å­˜åœ¨ä¸­æ–­å¤„ç†ç¨‹åº

**åŸè¯­æ³•å¯¹æ¯”**:
```cn
// å·²åˆ é™¤çš„è¯­æ³•:
ä¸­æ–­å¤„ç† 0 () {
    // å¤„ç†é€»è¾‘
}

// æ–°è¯­æ³•:
å‡½æ•° timer_handler() {
    // å¤„ç†é€»è¾‘
}

å‡½æ•° setup_interrupts() {
    cn_rt_interrupt_register(0, timer_handler, "å®šæ—¶å™¨");
}
```

**é¢„å®šä¹‰ä¸­æ–­å‘é‡**:
- `CN_RT_IRQ_TIMER_0 (0)`: å®šæ—¶å™¨0
- `CN_RT_IRQ_TIMER_1 (1)`: å®šæ—¶å™¨1
- `CN_RT_IRQ_KEYBOARD (2)`: é”®ç›˜
- `CN_RT_IRQ_MOUSE (3)`: é¼ æ ‡
- `CN_RT_IRQ_SERIAL (4)`: ä¸²å£

**ä½¿ç”¨æµç¨‹**:
1. å®šä¹‰ä¸­æ–­å¤„ç†å‡½æ•°
2. è°ƒç”¨`cn_rt_interrupt_init()`åˆå§‹åŒ–
3. è°ƒç”¨`cn_rt_interrupt_register()`æ³¨å†Œå¤„ç†ç¨‹åº
4. è°ƒç”¨`cn_rt_interrupt_enable()`å¯ç”¨ç‰¹å®šä¸­æ–­
5. è°ƒç”¨`cn_rt_interrupt_enable_all()`å¯ç”¨å…¨å±€ä¸­æ–­

---

### å…¶ä»–ä¸­æ–­ç®¡ç†å‡½æ•°

#### cn_rt_interrupt_init()
åˆå§‹åŒ–ä¸­æ–­ç®¡ç†ç³»ç»Ÿã€‚

```c
void cn_rt_interrupt_init(void);
```

#### cn_rt_interrupt_unregister()
æ³¨é”€ä¸­æ–­å¤„ç†ç¨‹åºã€‚

```c
int cn_rt_interrupt_unregister(uint32_t vector_num);
```

#### cn_rt_interrupt_enable()
å¯ç”¨ç‰¹å®šä¸­æ–­ã€‚

```c
void cn_rt_interrupt_enable(uint32_t vector_num);
```

#### cn_rt_interrupt_disable()
ç¦ç”¨ç‰¹å®šä¸­æ–­ã€‚

```c
void cn_rt_interrupt_disable(uint32_t vector_num);
```

#### cn_rt_interrupt_enable_all()
å…¨å±€å¯ç”¨æ‰€æœ‰ä¸­æ–­ã€‚

```c
void cn_rt_interrupt_enable_all(void);
```

#### cn_rt_interrupt_disable_all()
å…¨å±€ç¦ç”¨æ‰€æœ‰ä¸­æ–­ã€‚

```c
void cn_rt_interrupt_disable_all(void);
```

#### cn_rt_interrupt_trigger()
è§¦å‘ä¸­æ–­(ç”¨äºæµ‹è¯•æˆ–è½¯ä»¶ä¸­æ–­)ã€‚

```c
void cn_rt_interrupt_trigger(uint32_t vector_num);
```

#### cn_rt_interrupt_is_enabled()
æ£€æŸ¥ä¸­æ–­æ˜¯å¦å·²å¯ç”¨ã€‚

```c
int cn_rt_interrupt_is_enabled(uint32_t vector_num);
```

#### cn_rt_interrupt_is_pending()
æ£€æŸ¥ä¸­æ–­æ˜¯å¦æŒ‚èµ·ã€‚

```c
int cn_rt_interrupt_is_pending(uint32_t vector_num);
```

#### cn_rt_interrupt_get_current()
è·å–å½“å‰ä¸­æ–­å‘é‡å·ã€‚

```c
uint32_t cn_rt_interrupt_get_current(void);
```

---

## å®Œæ•´ç¤ºä¾‹

### å†…å­˜æ“ä½œç¤ºä¾‹

```cn
å‡½æ•° memory_demo() {
    // åˆ†é…ç¼“å†²åŒº
    å˜é‡ æ•´æ•°[10] buffer;
    
    // æ¸…é›¶
    cn_rt_mem_set(&buffer, 0, 40);
    
    // å†™å…¥æ•°æ®
    å˜é‡ æ•´æ•° addr = æ•´æ•°(&buffer[0]);
    cn_rt_mem_write(addr, 0x12345678, 4);
    
    // è¯»å–æ•°æ®
    å˜é‡ æ•´æ•° value = æ•´æ•°(cn_rt_mem_read(addr, 4));
    
    // å¤åˆ¶åˆ°å¦ä¸€ä¸ªæ•°ç»„
    å˜é‡ æ•´æ•°[10] copy;
    cn_rt_mem_copy(&copy, &buffer, 40);
}
```

### ä¸­æ–­å¤„ç†ç¤ºä¾‹

```cn
å˜é‡ æ•´æ•° timer_count = 0;

å‡½æ•° timer_isr() {
    timer_count = timer_count + 1;
}

å‡½æ•° setup_timer() {
    cn_rt_interrupt_init();
    cn_rt_interrupt_register(0, timer_isr, "ç³»ç»Ÿå®šæ—¶å™¨");
    cn_rt_interrupt_enable(0);
    cn_rt_interrupt_enable_all();
}
```

---

## å®‰å…¨æ£€æŸ¥

æ‰€æœ‰å†…å­˜æ“ä½œå‡½æ•°éƒ½æ”¯æŒå¯é€‰çš„å®‰å…¨æ£€æŸ¥:

### å¯ç”¨/ç¦ç”¨å®‰å…¨æ£€æŸ¥

```c
void cn_rt_memory_set_safety_check(int enabled);
```

**å®‰å…¨æ£€æŸ¥åŒ…æ‹¬**:
- åœ°å€å¯¹é½éªŒè¯
- ç©ºæŒ‡é’ˆæ£€æµ‹
- åœ°å€å¯è¯»/å¯å†™æ€§æ£€æŸ¥

**æ€§èƒ½å½±å“**:
- å¯ç”¨å®‰å…¨æ£€æŸ¥ä¼šæœ‰å°å¹…æ€§èƒ½å¼€é”€
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ä»¥ç¦ç”¨ä»¥è·å¾—æœ€ä½³æ€§èƒ½
- åœ¨å¼€å‘å’Œè°ƒè¯•é˜¶æ®µå»ºè®®å¯ç”¨

---

## é”™è¯¯å¤„ç†

### å†…å­˜æ“ä½œé”™è¯¯
å†…å­˜æ“ä½œå¤±è´¥æ—¶ä¼šå‘`stderr`è¾“å‡ºé”™è¯¯æ¶ˆæ¯(å¦‚æœå¯ç”¨äº†å®‰å…¨æ£€æŸ¥):

```
å†…å­˜å¯¹é½é”™è¯¯ï¼šåœ°å€ 0x1001 æœªæŒ‰ 4 å­—èŠ‚å¯¹é½
å†…å­˜è®¿é—®é”™è¯¯ï¼šç©ºæŒ‡é’ˆè®¿é—®
å†…å­˜æ˜ å°„å¤±è´¥ï¼šåœ°å€=0x0, å¤§å°=4096
```

### ä¸­æ–­å¤„ç†é”™è¯¯
ä¸­æ–­æ³¨å†Œå¤±è´¥æ—¶è¿”å›è´Ÿæ•°é”™è¯¯ç ,åº”ç”¨ç¨‹åºåº”æ£€æŸ¥è¿”å›å€¼:

```cn
å˜é‡ æ•´æ•° result = cn_rt_interrupt_register(0, handler, "ä¸­æ–­");
å¦‚æœ (result < 0) {
    // å¤„ç†é”™è¯¯
}
```

---

## å¹³å°å…¼å®¹æ€§

| åŠŸèƒ½ | Linux | Windows | Freestanding |
|-----|-------|---------|--------------|
| å†…å­˜è¯»å†™ | âœ… | âœ… | âœ… |
| å†…å­˜å¤åˆ¶è®¾ç½® | âœ… | âœ… | âœ… |
| å†…å­˜æ˜ å°„ | âœ… | âŒ | âŒ |
| ä¸­æ–­å¤„ç† | âœ… | âœ… | âœ… |
| å†…è”æ±‡ç¼– | ğŸ”„ | ğŸ”„ | ğŸ”„ |

å›¾ä¾‹:
- âœ… å®Œæ•´æ”¯æŒ
- âŒ ä¸æ”¯æŒ
- ğŸ”„ éœ€è¦åç«¯å®ç°

---

## å‚è€ƒ

- [CN Language è¿è¡Œæ—¶å†…å­˜ç®¡ç†](memory.md)
- [CN Language ä¸­æ–­ç®¡ç†](interrupt.md)
- [ç²¾ç®€å…³é”®å­—å®ŒæˆæŠ¥å‘Š](../../implementation-plans/é˜¶æ®µ%209ï¼šCNè¯­æ³•å®Œå–„/ç²¾ç®€å…³é”®å­—å®ŒæˆæŠ¥å‘Š.md)
