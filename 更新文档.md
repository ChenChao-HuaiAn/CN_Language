## 阶段 4：最小运行时与基础标准库 TODO 列表

### 4.1 运行时初始化

| # | 任务 | 详情 | 文件位置 |
|---|------|------|----------|
| 4.1.1 | 设计运行时初始化接口 | 定义 `cn_rt_init()` 和 `cn_rt_exit()` 函数签名 | `include/cnlang/runtime/runtime.h` |
| 4.1.2 | 实现程序入口包装 | 实现 `cn_rt_init()` 全局初始化逻辑 | `src/runtime/core/runtime.c` |
| 4.1.3 | 实现退出流程 | 实现 `cn_rt_exit()` 资源清理与退出码处理 | `src/runtime/core/runtime.c` |
| 4.1.4 | 全局状态管理 | 添加运行时全局状态结构体（如错误状态、堆统计） | `src/runtime/core/runtime.c` |
| 4.1.5 | C 后端集成 | 确保 cgen 生成的代码在 `main()` 中调用 `cn_rt_init/exit` | `src/backend/cgen/cgen.c` |

---

### 4.2 内存管理

| # | 任务 | 详情 | 文件位置 |
|---|------|------|----------|
| 4.2.1 | 设计内存管理接口 | 定义统一内存分配接口头文件 | `include/cnlang/runtime/memory.h` (新建) |
| 4.2.2 | 实现基础分配器 | 封装 `cn_rt_malloc/free/realloc` | `src/runtime/memory/memory.c` (新建) |
| 4.2.3 | 添加内存分配追踪 | 可选调试模式，追踪分配/释放统计 | `src/runtime/memory/memory.c` |
| 4.2.4 | 预留自定义分配器钩子 | 为 OS 开发场景预留页分配器接口 | `include/cnlang/runtime/memory.h` |
| 4.2.5 | 迁移现有分配调用 | 将 `runtime.c`/`collections.c` 中的 `malloc/free` 替换为统一接口 | `src/runtime/core/`, `src/runtime/collections/` |
| 4.2.6 | 更新 CMakeLists | 将 memory 模块加入构建 | `src/runtime/CMakeLists.txt` |

---

### 4.3 基础标准库

| # | 任务 | 详情 | 文件位置 |
|---|------|------|----------|
| **字符串处理** | | | |
| 4.3.1 | 补充字符串函数 | 添加 `cn_rt_string_index_of`, `cn_rt_string_trim` 等 | `src/runtime/collections/collections.c` |
| 4.3.2 | 字符串格式化 | 实现简单格式化输出 `cn_rt_format` | `src/runtime/core/runtime.c` |
| **简单 I/O** | | | |
| 4.3.3 | 设计 I/O 接口 | 定义文件读写、控制台输入接口 | `include/cnlang/runtime/io.h` (新建) |
| 4.3.4 | 实现控制台输入 | 实现 `cn_rt_read_line`, `cn_rt_read_int` | `src/runtime/io/io.c` (新建) |
| 4.3.5 | 实现基础文件操作 | 封装文件打开/读/写/关闭（依赖宿主系统） | `src/runtime/io/io.c` |
| **数学函数** | | | |
| 4.3.6 | 设计数学接口 | 定义基础数学函数头文件 | `include/cnlang/runtime/math.h` (新建) |
| 4.3.7 | 实现数学函数 | 封装 `cn_rt_abs`, `cn_rt_min`, `cn_rt_max`, `cn_rt_pow` 等 | `src/runtime/math/math.c` (新建) |

---

### 4.4 与语言特性绑定

| # | 任务 | 详情 | 文件位置 |
|---|------|------|----------|
| 4.4.1 | 文档化运行时依赖 | 明确哪些语言特性（字符串、数组、集合）依赖运行时 | `docs/specifications/runtime_binding.md` (按需) |
| 4.4.2 | 字符串类型绑定 | 确保 C 后端对字符串操作生成正确的运行时调用 | `src/backend/cgen/cgen.c` |
| 4.4.3 | 数组类型绑定 | 确保数组分配/访问/释放使用运行时接口 | `src/backend/cgen/cgen.c` |
| 4.4.4 | 内置函数映射 | 将语言内置函数（如 `长度()`）映射到运行时调用 | `src/backend/cgen/cgen.c` |

---

### 4.5 测试覆盖

| # | 任务 | 详情 | 文件位置 |
|---|------|------|----------|
| 4.5.1 | 创建运行时单元测试目录 | 建立 `tests/unit/runtime/` 目录结构 | `tests/unit/runtime/` (新建) |
| 4.5.2 | 内存管理单元测试 | 测试分配/释放/追踪功能 | `tests/unit/runtime/runtime_memory_test.c` |
| 4.5.3 | 字符串函数单元测试 | 测试所有字符串操作函数 | `tests/unit/runtime/runtime_string_test.c` |
| 4.5.4 | 数组函数单元测试 | 测试数组分配/越界检查/元素操作 | `tests/unit/runtime/runtime_array_test.c` |
| 4.5.5 | I/O 函数单元测试 | 测试输入输出函数 | `tests/unit/runtime/runtime_io_test.c` |
| 4.5.6 | 运行时集成测试 | 编写依赖运行时的 `.cn` 示例并验证执行 | `tests/integration/compiler/` |
| 4.5.7 | 更新测试 CMakeLists | 将运行时测试加入构建 | `tests/unit/CMakeLists.txt` |

---

### 现有实现状态

**已完成：**
- [x] 基础打印函数 (`cn_rt_print_*`)
- [x] 字符串基础操作 (`concat`, `length`, `substring`, `compare`)
- [x] 数组基础操作 (`alloc`, `length`, `bounds_check`, `free`, `set/get_element`)
- [x] cn_runtime 静态库构建配置

**待实现：**
- [ ] 运行时初始化/退出流程
- [ ] 统一内存管理接口 (`src/runtime/memory/` 目前为空)
- [ ] I/O 接口（文件/控制台输入）
- [ ] 数学函数库
- [ ] OS 抽象层 (`src/runtime/os_abstraction/` 目前为空)
- [ ] 运行时单元测试（`tests/unit/runtime/` 不存在）

---
